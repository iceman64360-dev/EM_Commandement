<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>COMMANDEMENT_OS // GESTIONNAIRE TACTIQUE v4.2</title>
    
    <!-- iOS Compatibility Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="COMMANDEMENT_OS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- iOS App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMGQxMTE3Ii8+Cjx0ZXh0IHg9IjkwIiB5PSI5MCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSI0OCIgZmlsbD0iIzIyZDNlZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPkM8L3RleHQ+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgdmlld0JveD0iMCAwIDE1MiAxNTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTIiIGhlaWdodD0iMTUyIiBmaWxsPSIjMGQxMTE3Ii8+Cjx0ZXh0IHg9Ijc2IiB5PSI3NiIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSI0MCIgZmlsbD0iIzIyZDNlZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPkM8L3RleHQ+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjMGQxMTE3Ii8+Cjx0ZXh0IHg9IjYwIiB5PSI2MCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIzMiIgZmlsbD0iIzIyZDNlZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPkM8L3RleHQ+Cjwvc3ZnPg==">
    <!-- Utilisation de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioth√®que jsPDF pour l'export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK pour synchronisation multi-appareils -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- Police de caract√®res -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d1117; --bg-panel: rgba(17, 24, 39, 0.6); --border-color: rgba(55, 65, 81, 0.7);
            --text-primary: #c9d1d9; --text-secondary: #8b949e; --accent-cyan: #22d3ee;
            --accent-cyan-glow: rgba(34, 211, 238, 0.3); --accent-amber: #fcd34d;
            --accent-amber-glow: rgba(252, 211, 77, 0.3); --accent-red: #f87171; --accent-green: #34d399;
        }
        body { 
            font-family: 'Share Tech Mono', monospace; 
            background-color: var(--bg-dark); 
            color: var(--text-primary); 
            font-size: 16px; 
            overflow-x: hidden;
            /* iOS Specific Fixes */
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Safe area for iOS notch */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(to right, rgba(55, 65, 81, 0.15) 1px, transparent 1px), linear-gradient(to bottom, rgba(55, 65, 81, 0.15) 1px, transparent 1px); background-size: 40px 40px; z-index: -2; }
        body::after { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.3), rgba(0,0,0,0.3) 1px, transparent 1px, transparent 3px); pointer-events: none; z-index: 100; }
        .panel { background-color: var(--bg-panel); border: 1px solid var(--border-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 8px; padding: 1.5rem; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 5px rgba(55, 65, 81, 0.5); }
        .terminal-input, .terminal-select, .terminal-textarea { 
            background-color: rgba(17, 24, 39, 0.9); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            font-family: 'Share Tech Mono', monospace; 
            padding: 10px; 
            border-radius: 4px; 
            transition: all 0.2s ease-in-out; 
            width: 100%;
            /* iOS Specific Input Fixes */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            /* Prevent iOS zoom on input focus */
            font-size: 16px;
            /* Fix iOS input rendering */
            -webkit-border-radius: 4px;
            border-radius: 4px;
        }
        .terminal-select[multiple] { height: 100px; }
        .terminal-input:focus, .terminal-select:focus, .terminal-textarea:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 0 3px var(--accent-cyan-glow); }
        .uppercase-input { text-transform: uppercase; }
        .terminal-button { 
            background-color: var(--bg-panel); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            padding: 10px 16px; 
            border-radius: 4px; 
            transition: all 0.2s ease-in-out; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            justify-content: center;
            /* iOS Specific Button Fixes */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Prevent iOS button styling */
            -webkit-border-radius: 4px;
            border-radius: 4px;
            /* Better touch target for iOS */
            min-height: 44px;
            min-width: 44px;
        }
        .terminal-button:hover:not(:disabled) { color: var(--accent-cyan); border-color: var(--accent-cyan); box-shadow: 0 0 10px var(--accent-cyan-glow), inset 0 0 5px var(--accent-cyan-glow); cursor: pointer; }
        .terminal-button.primary { background-color: var(--accent-cyan); color: var(--bg-dark); border-color: var(--accent-cyan); }
        .terminal-button.primary:hover:not(:disabled) { box-shadow: 0 0 15px var(--accent-cyan-glow); }
        .terminal-button.selected { background-color: var(--accent-cyan); color: var(--bg-dark); }
        .terminal-button:disabled { background-color: #374151; color: #6b7280; cursor: not-allowed; opacity: 0.5; }
        .list-item { padding: 12px 16px; cursor: pointer; border-radius: 4px; transition: all 0.2s ease; border-left-width: 4px; }
        .list-item:hover { background-color: rgba(55, 65, 81, 0.5); }
        .list-item.selected { background-color: var(--accent-cyan); color: var(--bg-dark); font-weight: bold; box-shadow: 0 0 10px var(--accent-cyan-glow); }
        .mission-success { color: var(--accent-green); border-left-color: var(--accent-green); }
        .mission-failure { color: var(--accent-red); border-left-color: var(--accent-red); }
        .main-nav-link.active { background-color: var(--accent-cyan); color: var(--bg-dark); box-shadow: 0 0 10px var(--accent-cyan-glow); }
        .member-card { border: 1px solid var(--border-color); background-color: rgba(17, 24, 39, 0.7); padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; border-radius: 6px; }
        .member-card-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(13, 17, 23, 0.8); z-index: 40; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal-panel { animation: slideInUp 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .icon { width: 1.2em; height: 1.2em; }
        .h-screen-padded { height: calc(100vh - 2rem); }
        .leader-card { border-color: var(--accent-amber); box-shadow: 0 0 8px var(--accent-amber-glow), inset 0 0 4px var(--accent-amber-glow); }
        .grade-badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase; color: var(--bg-dark); font-weight: bold; }
        .grade-soldat { background-color: #9ca3af; }
        .grade-sous-officier { background-color: var(--accent-green); }
        .grade-officier { background-color: var(--accent-amber); }
        .objective-completed { text-decoration: line-through; color: var(--accent-green); }
        
        /* Styles pour les modales */
        .modal-overlay { background-color: rgba(13, 17, 23, 0.8); backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--bg-panel); border: 1px solid var(--border-color); backdrop-filter: blur(12px); }
        .btn-primary { background-color: var(--accent-cyan); color: var(--bg-dark); }
        .btn-primary:hover { background-color: var(--accent-cyan); box-shadow: 0 0 15px var(--accent-cyan-glow); }
        .terminal-border { border: 1px solid var(--border-color); }
        .tab-active { background-color: var(--accent-cyan); color: var(--bg-dark); box-shadow: 0 0 10px var(--accent-cyan-glow); }
        .tab-inactive { background-color: var(--bg-panel); color: var(--text-primary); border: 1px solid var(--border-color); }
        .tab-inactive:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); box-shadow: 0 0 10px var(--accent-cyan-glow), inset 0 0 5px var(--accent-cyan-glow); }
        .drag-zone { border: 2px dashed var(--border-color); background-color: var(--bg-panel); transition: all 0.3s ease; }
        .drag-zone.drag-over { border-color: var(--accent-cyan); background-color: rgba(34, 211, 238, 0.1); }
        
        /* iOS Specific Compatibility Styles */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari specific styles */
            .list-item {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                /* Better touch targets for iOS */
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .modal-backdrop {
                /* Fix iOS modal positioning */
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                -webkit-overflow-scrolling: touch;
            }
            
            .modal-panel {
                /* Fix iOS modal scrolling */
                -webkit-overflow-scrolling: touch;
                max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 40px);
                overflow-y: auto;
            }
            
            /* Fix iOS input focus issues */
            .terminal-input:focus,
            .terminal-select:focus,
            .terminal-textarea:focus {
                /* Prevent iOS zoom on focus */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }
            
            /* iOS scrolling improvements */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Fix iOS button active states */
            .terminal-button:active {
                transform: scale(0.98);
                -webkit-transform: scale(0.98);
            }
        }
        
        /* Additional iOS fixes for specific elements */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
            padding-right: 30px;
        }
        
        /* iOS specific scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-panel);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }
        .notification { position: fixed; top: 20px; right: 20px; z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        
        /* Navigation responsive */
        @media (max-width: 768px) {
            .h-screen-padded { height: calc(100vh - 1rem); }
            #main-nav {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(13, 17, 23, 0.95);
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 900;
            }
            #main-nav.mobile-menu-open {
                display: flex;
            }
            #main-nav .terminal-button {
                width: 80%;
                margin-bottom: 15px;
                text-align: center;
                font-size: 1.2em;
                padding: 15px;
            }
            #menu-toggle {
                display: block;
                z-index: 1000;
            }
        }
        
        .tab-inactive {
            background: transparent;
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .drag-zone {
            border: 2px dashed #00ff88;
            background: rgba(0, 255, 136, 0.1);
            transition: all 0.3s ease;
        }
        
        .drag-zone.drag-over {
            border-color: #00cc6a;
            background: rgba(0, 255, 136, 0.2);
        }
    </style>
</head>
<body class="p-2 md:p-4">
    <!-- √âcran d'authentification -->
    <div id="auth-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md mx-4 border border-cyan-500/30">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-cyan-400 mb-2">üèõÔ∏è COMMANDEMENT_OS</h1>
                <p class="text-gray-400">ACC√àS √âTAT-MAJOR</p>
                <p class="text-xs text-gray-500 mt-2">Interface r√©serv√©e au personnel autoris√©</p>
            </div>
            
            <form id="auth-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Nom d'utilisateur</label>
                    <input type="text" id="username" name="username" required
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 font-size-16">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Mot de passe</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 font-size-16">
                </div>
                
                <div id="auth-error" class="text-red-400 text-sm hidden"></div>
                
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    üîê ACC√âDER AU COMMANDEMENT
                </button>
            </form>
            
            <div class="mt-6 border-t border-gray-700 pt-6">
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-400 mb-3">Vous √™tes Chef d'Escouade ?</p>
                    <a href="escouade.html" class="inline-block w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-md transition-colors text-center">
                        üë®‚Äçüíº ACC√àS CHEF D'ESCOUADE
                    </a>
                    <p class="text-xs text-gray-500 mt-2">Saisissez et synchronisez les donn√©es de votre escouade</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de session utilisateur -->
    <div id="user-session-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md mx-4 border border-cyan-500/30">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-cyan-400 mb-2">üë§ SESSION UTILISATEUR</h2>
                <p id="session-message" class="text-gray-400">Veuillez saisir votre pseudo pour cr√©er votre session</p>
            </div>
            
            <!-- Affichage des utilisateurs d√©j√† connect√©s -->
            <div id="existing-users-section" class="hidden mb-6">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-sm font-semibold text-amber-400 mb-2">‚ö†Ô∏è Utilisateurs d√©j√† connect√©s :</h3>
                    <div id="existing-users-list" class="text-sm text-gray-300"></div>
                    <p class="text-xs text-gray-500 mt-2">Voulez-vous vous connecter √©galement ?</p>
                </div>
            </div>
            
            <form id="user-session-form" class="space-y-4">
                <div>
                    <label for="user-pseudo" class="block text-sm font-medium text-gray-300 mb-2">Votre pseudo</label>
                    <input type="text" id="user-pseudo" name="user-pseudo" required maxlength="20"
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 font-size-16"
                           placeholder="Ex: Commandant_Alpha">
                </div>
                
                <div id="session-error" class="text-red-400 text-sm hidden"></div>
                
                <div class="flex gap-3">
                    <button type="button" id="cancel-session" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                        ‚ùå Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                        üöÄ REJOINDRE
                    </button>
                </div>
            </form>
            
            <!-- Section d'information sur les sessions multiples -->
            <div class="mt-4 text-center">
                <p class="text-xs text-gray-500">Les sessions multiples permettent un travail collaboratif en temps r√©el</p>
            </div>
        </div>
    </div>

    <!-- Interface principale (cach√©e par d√©faut) -->
    <div id="main-interface" class="hidden">
        <!-- Notification -->
    <div id="notification" class="notification panel max-w-sm">
        <div class="flex items-center justify-between">
            <div>
                <h4 id="notification-title" class="font-bold text-white"></h4>
                <p id="notification-message" class="text-gray-300 text-sm"></p>
            </div>
            <button onclick="hideNotification()" class="text-gray-400 hover:text-white ml-4">√ó</button>
        </div>
    </div>

    <div class="flex flex-col h-screen-padded">
        <!-- En-t√™te -->
        <header class="flex-shrink-0 flex items-center justify-between p-2 mb-2 md:mb-4 border-b border-gray-800">
            <div>
                <div id="current-time" class="text-amber-400 text-xs md:text-sm"></div>
                <h1 class="text-2xl md:text-3xl text-cyan-300 font-bold tracking-widest">COMMANDEMENT_OS</h1>
                <div class="text-xs text-gray-400">Gestionnaire Tactique v4.2</div>
                
                <!-- Affichage des sessions utilisateurs -->
                <div class="mt-2 flex flex-wrap gap-2">
                    <div id="user-info" class="hidden bg-slate-800 px-2 py-1 rounded text-xs text-cyan-300 border border-cyan-500/30"></div>
                    <div id="session-count" class="hidden bg-slate-800 px-2 py-1 rounded text-xs text-amber-300 border border-amber-500/30"></div>
                </div>
                
                <!-- Liste des membres connect√©s -->
                <div id="connected-members-list" class="mt-2 hidden">
                    <div class="text-xs text-gray-500 mb-1">Membres connect√©s :</div>
                    <div id="members-display" class="flex flex-wrap gap-1"></div>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <!-- Bouton Hamburger pour mobile -->
                <button id="menu-toggle" class="md:hidden terminal-button" title="Menu">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <!-- Navigation principale -->
                <nav id="main-nav" class="hidden md:flex items-center gap-2 md:gap-4">
                    <button id="tab-dashboard" onclick="showTab('dashboard')" class="main-nav-link terminal-button active">
                        Dashboard
                    </button>
                    <button id="tab-squads" onclick="showTab('squads')" class="main-nav-link terminal-button">
                        Escouades
                    </button>
                    <button id="tab-missions" onclick="showTab('missions')" class="main-nav-link terminal-button">
                        Missions
                    </button>
                </nav>
            </div>
        </header>
        
        <!-- Contenu principal -->
        <main class="flex-grow min-h-0 overflow-hidden relative">
            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content absolute inset-0 overflow-y-auto p-1">
                <!-- Ligne Base Principale / FOB -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Base Principale -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">
                            üè≠ BASE PRINCIPALE
                        </h2>
                        <div class="space-y-4">
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm mb-2">Base S√©lectionn√©e</div>
                                <div id="selected-base-display" class="text-blue-300 font-bold text-lg mb-3">
                                    Aucune base s√©lectionn√©e
                                </div>
                                <button onclick="openBaseSelection()" class="terminal-button primary w-full flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    S√©lectionner Base
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FOB (Forward Operating Base) -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2">
                            üè¢ FOB
                        </h2>
                        <div class="space-y-4">
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm mb-2">FOB S√©lectionn√©e</div>
                                <div id="selected-fob-display" class="text-purple-300 font-bold text-lg mb-3">
                                    Aucune FOB s√©lectionn√©e
                                </div>
                                <button onclick="openFOBSelection()" class="terminal-button primary w-full flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    S√©lectionner FOB
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Premi√®re ligne : Actions et Escouades -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Actions Rapides -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-amber-400">ACTIONS RAPIDES</h2>
                        <div class="space-y-3">
                            <button onclick="showTab('squads')" class="terminal-button primary w-full">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                G√©rer Escouades
                            </button>
                            <button onclick="showTab('missions')" class="terminal-button primary w-full">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                G√©rer Missions
                            </button>
                            <button onclick="openImportModal()" class="terminal-button primary w-full">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                Importer Donn√©es
                            </button>
                        </div>
                    </div>
                    
                    <!-- Toutes les Escouades -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-amber-400">TOUTES LES ESCOUADES</h2>
                        <div id="dashboard-all-squads" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Chargement...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Deuxi√®me ligne : Missions et Statistiques -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Missions en Cours -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-green-400">MISSIONS EN COURS</h2>
                        <div id="dashboard-all-missions" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Chargement...</p>
                        </div>
                    </div>
                    
                    <!-- Missions Termin√©es -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-blue-400">MISSIONS TERMIN√âES</h2>
                        <div id="dashboard-completed-missions" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Chargement...</p>
                        </div>
                    </div>
                    
                    <!-- Statistiques D√©taill√©es -->
                    <div class="panel">
                        <h2 class="text-xl font-bold mb-4 text-amber-400">STATISTIQUES D√âTAILL√âES</h2>
                        <div id="detailed-stats" class="space-y-3">
                            <div class="grid grid-cols-1 gap-3 text-sm">
                                <div class="bg-slate-800 p-3 rounded">
                                    <div class="text-gray-400">Escouades Support</div>
                                    <div id="stats-support" class="text-orange-400 font-bold text-xl">0</div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded">
                                    <div class="text-gray-400">Escouades Terrain</div>
                                    <div id="stats-terrain" class="text-cyan-400 font-bold text-xl">0</div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded">
                                    <div class="text-gray-400">Missions Actives</div>
                                    <div id="stats-active-missions" class="text-green-400 font-bold text-xl">0</div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded">
                                    <div class="text-gray-400">Missions Termin√©es</div>
                                    <div id="stats-completed-missions" class="text-blue-400 font-bold text-xl">0</div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded">
                                    <div class="text-gray-400">Effectif Total</div>
                                    <div id="stats-total-personnel" class="text-purple-400 font-bold text-xl">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Squads Tab -->
            <div id="squads-content" class="tab-content absolute inset-0 hidden">
                <div class="flex h-full min-h-0 relative">
                    <!-- Sidebar Escouades -->
                    <aside class="w-full md:w-1/3 lg:w-1/4 h-full flex flex-col pr-0 md:pr-4">
                        <div class="panel flex-grow flex flex-col h-full">
                            <div class="flex-shrink-0 mb-4 border-b border-gray-700 pb-4">
                                <h3 class="text-xl text-amber-400 mb-3">Gestion</h3>
                                <div class="flex flex-col gap-2">
                                    <button onclick="openImportModal()" class="terminal-button primary w-full">
                                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        Nouvelle Escouade
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Encart Escouades de Support -->
                            <div class="mb-4">
                                <h2 class="text-lg mb-2 flex-shrink-0 text-amber-400">üîß SUPPORT</h2>
                                <div id="support-squads-list" class="space-y-2 mb-4">
                                    <p class="text-gray-400 text-sm">Aucune escouade de support</p>
                                </div>
                            </div>
                            
                            <!-- Encart Escouades de Terrain -->
                            <div class="flex-grow flex flex-col">
                                <h2 class="text-lg mb-2 flex-shrink-0 text-cyan-400">‚öîÔ∏è TERRAIN</h2>
                                <div id="terrain-squads-list" class="flex-grow overflow-y-auto pr-2">
                                    <p class="text-gray-400 text-sm">Aucune escouade de terrain</p>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <!-- D√©tail Escouade -->
                    <main class="w-full md:w-2/3 lg:w-3/4 panel overflow-y-auto">
                        <div id="squad-detail">
                            <div class="text-center text-gray-400 py-12">
                                <p>S√©lectionnez une escouade pour voir les d√©tails</p>
                            </div>
                        </div>
                    </main>
                </div>
            </div>

            <!-- Missions Tab -->
            <div id="missions-content" class="tab-content absolute inset-0 hidden">
                <div class="flex h-full min-h-0 relative">
                    <!-- Sidebar Missions -->
                    <aside class="w-full md:w-1/3 lg:w-1/4 h-full flex flex-col pr-0 md:pr-4">
                        <div class="panel flex-grow flex flex-col h-full">
                            <div class="flex-shrink-0 mb-4 border-b border-gray-700 pb-4">
                                <button onclick="openMissionCreationModal()" class="terminal-button primary w-full text-lg">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Nouvelle Mission
                                </button>
                            </div>
                            <h2 class="text-xl mb-2 flex-shrink-0 text-gray-300">> Missions Actives</h2>
                            <div id="missions-list" class="flex-grow overflow-y-auto pr-2">
                                <p class="text-gray-400 text-sm">Aucune mission cr√©√©e</p>
                            </div>
                        </div>
                    </aside>

                    <!-- D√©tail Mission -->
                    <main class="w-full md:w-2/3 lg:w-3/4 panel overflow-y-auto">
                        <div id="mission-detail">
                            <div class="text-center text-gray-400 py-12">
                                <p>S√©lectionnez une mission pour voir les d√©tails</p>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Import -->
    <div id="import-modal" class="modal-overlay fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content rounded-lg p-6 w-11/12 md:w-2/3 max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">IMPORTER DONN√âES ESCOUADE</h3>
                <button onclick="hideModal('import-modal')" class="text-2xl hover:text-red-400">√ó</button>
            </div>
            
            <!-- Zone de Drop -->
            <div id="drop-zone" class="drag-zone rounded-lg p-8 text-center mb-6">
                <div class="space-y-4">
                    <div class="text-4xl">üìÅ</div>
                    <p class="text-lg font-bold">Glissez votre fichier JSON ici</p>
                    <p class="text-sm text-gray-400">ou</p>
                    <button onclick="selectFile()" class="btn-primary px-6 py-2 rounded-lg">
                        S√©lectionner un fichier
                    </button>
                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
                </div>
            </div>

            <!-- Pr√©visualisation -->
            <div id="import-preview" class="hidden">
                <h4 class="text-lg font-bold mb-4">PR√âVISUALISATION</h4>
                <div id="import-info" class="bg-slate-800 p-4 rounded-lg mb-4"></div>
                <div id="import-squads" class="space-y-2 mb-6"></div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="hideModal('import-modal')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                        Annuler
                    </button>
                    <button onclick="executeImport()" class="btn-primary px-6 py-2 rounded">
                        Confirmer l'Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cr√©ation Mission -->
    <div id="mission-creation-modal" class="modal-overlay fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content rounded-lg p-6 w-11/12 md:w-2/3 max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-orange-400">CR√âER NOUVELLE MISSION</h3>
                <button onclick="hideModal('mission-creation-modal')" class="text-2xl hover:text-red-400">√ó</button>
            </div>
            
            <div class="space-y-4">
                <!-- Nom de la mission -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Nom de la Mission</label>
                    <input type="text" id="modal-mission-name" class="w-full p-3 bg-slate-800 border border-gray-600 rounded text-white" placeholder="Ex: OPERATION TEMP√äTE">
                </div>
                
                <!-- Secteur -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Secteur</label>
                    <input type="text" id="modal-mission-sector" class="w-full p-3 bg-slate-800 border border-gray-600 rounded text-white" placeholder="Ex: Zone Alpha-7">
                </div>
                
                <!-- Cat√©gorie -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Cat√©gorie</label>
                    <div class="relative">
                        <button id="modal-mission-category-btn" onclick="toggleDropdown('category-dropdown')" class="w-full p-3 bg-slate-800 border border-gray-600 rounded text-white text-left flex justify-between items-center">
                            Choisir...
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="category-dropdown" class="absolute top-full left-0 right-0 bg-slate-800 border border-gray-600 rounded mt-1 hidden z-10">
                            <div onclick="selectCategory('Reconnaissance')" class="p-3 hover:bg-slate-700 cursor-pointer">Reconnaissance</div>
                            <div onclick="selectCategory('Assault')" class="p-3 hover:bg-slate-700 cursor-pointer">Assault</div>
                            <div onclick="selectCategory('D√©fense')" class="p-3 hover:bg-slate-700 cursor-pointer">D√©fense</div>
                            <div onclick="selectCategory('Escorte')" class="p-3 hover:bg-slate-700 cursor-pointer">Escorte</div>
                            <div onclick="selectCategory('Infiltration')" class="p-3 hover:bg-slate-700 cursor-pointer">Infiltration</div>
                            <div onclick="selectCategory('Extraction')" class="p-3 hover:bg-slate-700 cursor-pointer">Extraction</div>
                        </div>
                    </div>
                </div>
                
                <!-- Difficult√© -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Difficult√©</label>
                    <div class="relative">
                        <button id="modal-mission-difficulty-btn" onclick="toggleDropdown('difficulty-dropdown')" class="w-full p-3 bg-slate-800 border border-gray-600 rounded text-white text-left flex justify-between items-center">
                            Normale
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="difficulty-dropdown" class="absolute top-full left-0 right-0 bg-slate-800 border border-gray-600 rounded mt-1 hidden z-10">
                            <div onclick="selectDifficulty('Facile')" class="p-3 hover:bg-slate-700 cursor-pointer text-green-400">Facile</div>
                            <div onclick="selectDifficulty('Normale')" class="p-3 hover:bg-slate-700 cursor-pointer text-yellow-400">Normale</div>
                            <div onclick="selectDifficulty('Difficile')" class="p-3 hover:bg-slate-700 cursor-pointer text-orange-400">Difficile</div>
                            <div onclick="selectDifficulty('Extr√™me')" class="p-3 hover:bg-slate-700 cursor-pointer text-red-400">Extr√™me</div>
                        </div>
                    </div>
                </div>
                
                <!-- Objectif principal -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Objectifs de Mission</label>
                    <div id="modal-objectives-list" class="space-y-2 mb-3">
                        <!-- Les objectifs seront ajout√©s ici dynamiquement -->
                    </div>
                    <button type="button" id="modal-add-objective-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        + Ajouter Objectif
                    </button>
                </div>
                
                <!-- Escouades assign√©es -->
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">Escouades Assign√©es</label>
                    <div class="flex items-center gap-3">
                        <div class="flex-grow p-3 bg-slate-800 border border-gray-600 rounded text-gray-400">
                            <span id="modal-mission-squads-display">Aucune</span>
                        </div>
                        <button onclick="openSquadSelectionModal()" class="terminal-button primary px-4 py-3">
                            S√©lectionner
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideModal('mission-creation-modal')" class="px-6 py-2 bg-gray-600 rounded hover:bg-gray-700">
                    Annuler
                </button>
                <button onclick="saveNewMission()" class="terminal-button primary px-6 py-2">
                    Cr√©er Mission
                </button>
            </div>
        </div>
    </div>

    <!-- Modal S√©lection Escouades -->
    <div id="squad-selection-modal" class="modal-overlay fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content rounded-lg p-6 w-11/12 md:w-2/3 max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-orange-400">S√âLECTIONNER ESCOUADES</h3>
                <button onclick="hideModal('squad-selection-modal')" class="text-2xl hover:text-red-400">√ó</button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-400 text-sm">S√©lectionnez les escouades √† assigner √† cette mission :</p>
            </div>
            
            <div id="squad-selection-list" class="space-y-2 mb-6 max-h-96 overflow-y-auto">
                <!-- Liste des escouades sera g√©n√©r√©e dynamiquement -->
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('squad-selection-modal')" class="px-6 py-2 bg-gray-600 rounded hover:bg-gray-700">
                    Annuler
                </button>
                <button onclick="confirmSquadSelection()" class="terminal-button primary px-6 py-2">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <script>
        // === CONSTANTES ET CONFIGURATION ===
        const SQUAD_NAMES = ['ALPHA', 'BRAVO', 'CHARLIE', 'DELTA', 'ECHO', 'FOXTROT', 'GOLF', 'HOTEL', 'INDIA', 'JULIETTE', 'KILO', 'LIMA', 'MIKE'];
        const SUPPORT_NAMES = ['LOGISTIQUE', 'PLANTON'];
        
        // Couleurs automatiques pour chaque escouade
        const SQUAD_COLORS = {
            'ALPHA': '#4CAF50',      // Vert
            'BRAVO': '#2196F3',      // Bleu
            'CHARLIE': '#9C27B0',    // Violet
            'DELTA': '#FFEB3B',      // Jaune
            'ECHO': '#00BCD4',       // Cyan
            'FOXTROT': '#FF5722',    // Orange
            'GOLF': '#E91E63',       // Magenta
            'HOTEL': '#8BC34A',      // Vert clair
            'INDIA': '#F44336',      // Rouge
            'JULIETTE': '#607D8B',   // Bleu-gris
            'KILO': '#795548',       // Marron
            'LIMA': '#B71C1C',       // Rouge fonc√©
            'MIKE': '#689F38',       // Vert olive
            'LOGISTIQUE': '#424242', // Gris fonc√©
            'PLANTON': '#9E9E9E'     // Gris
        };
        
        // Fr√©quences radio pour chaque escouade
        const SQUAD_FREQUENCIES = {
            'ALPHA': 32, 'BRAVO': 33, 'CHARLIE': 34, 'DELTA': 35,
            'ECHO': 36, 'FOXTROT': 37, 'GOLF': 38, 'HOTEL': 39,
            'INDIA': 40, 'JULIETTE': 41, 'KILO': 42, 'LIMA': 43,
            'MIKE': 44, 'LOGISTIQUE': 45, 'PLANTON': 52
        };
        
        // Configuration des grades et r√¥les
        const GRADES = ['Soldat', 'Soldat de 1√®re classe', 'Caporal', 'Caporal-Chef', 'Sergent', 'Sergent-Chef', 'Adjudant', 'Adjudant-Chef', 'Major', 'Aspirant', 'Sous-Lieutenant', 'Lieutenant', 'Capitaine'];
        const ROLES = ['Fusilier', 'Grenadier', 'Mitrailleur', 'Tireur de pr√©cision', 'Medic', 'Ing√©nieur', 'AT', 'AA', 'Chef d\'√©quipe', 'Chef', 'Second', 'Op√©rateur Radio', '√âclaireur'];
        
        // Syst√®me de TRADES (6 sp√©cialit√©s principales)
        const TRADES = {
            'Fusilier': {
                name: 'Fusilier',
                description: 'Infanterie de base, polyvalent au combat',
                color: '#4CAF50',
                icon: 'üî´',
                equipment: ['Fusil d\'assaut', 'Grenades', '√âquipement standard']
            },
            'AT': {
                name: 'Anti-Tank',
                description: 'Sp√©cialiste anti-blind√©s',
                color: '#FF5722',
                icon: 'üöÄ',
                equipment: ['Lance-roquettes', 'Munitions AT', '√âquipement lourd']
            },
            'LG': {
                name: 'Lance-Grenades',
                description: 'Support par grenades et explosifs',
                color: '#FF9800',
                icon: 'üí•',
                equipment: ['Lance-grenades', 'Grenades diverses', 'Explosifs']
            },
            'Minimi': {
                name: 'Mitrailleur L√©ger',
                description: 'Soutien par feu automatique l√©ger',
                color: '#2196F3',
                icon: 'üî•',
                equipment: ['Minimi', 'Munitions 5.56', 'Bipied']
            },
            'Mitrailleur Lourde': {
                name: 'Mitrailleur Lourd',
                description: 'Soutien par feu automatique lourd',
                color: '#9C27B0',
                icon: '‚ö°',
                equipment: ['Mitrailleuse lourde', 'Munitions 7.62', 'Tr√©pied']
            },
            'M√©decin': {
                name: 'M√©decin',
                description: 'Soins m√©dicaux et √©vacuation sanitaire',
                color: '#F44336',
                icon: 'üè•',
                equipment: ['Trousse m√©dicale', 'Morphine', 'Mat√©riel d\'√©vacuation']
            },
            'TP': {
                name: 'Tireur de Pr√©cision',
                description: '√âlimination de cibles √† longue distance',
                color: '#795548',
                icon: 'üéØ',
                equipment: ['Fusil de pr√©cision', 'Lunette', 'Camouflage']
            }
        };
        
        // Cat√©gories de grades pour l'affichage
        const GRADE_CATEGORIES = {
            'enlisted': ['Soldat', 'Soldat de 1√®re classe'],
            'nco': ['Caporal', 'Caporal-Chef', 'Sergent', 'Sergent-Chef', 'Adjudant', 'Adjudant-Chef', 'Major'],
            'officer': ['Aspirant', 'Sous-Lieutenant', 'Lieutenant', 'Capitaine']
        };
        
        // Variables globales
        let squads = {};
        let missions = {};
        let selectedSquad = null;
        let selectedMission = null;
        let tempMissionData = {};
        let tempObjectives = []; // Pour g√©rer les objectifs multiples
        let importFile = null;
        let squadCreationType = 'terrain'; // 'terrain' ou 'support'
        
        // Variables pour la gestion des bases et FOB
        let selectedBase = null;
        let selectedFOB = null;
        
        // Configuration des bases et FOB disponibles
        const config = {
            availableBases: [
                'ALABAMA', 'ALASKA', 'ARIZONA', 'ARKANSAS', 'AUSTIN', 'BALTIMORE', 'CALIFORNIA', 'CHICAGO',
                'COLORADO', 'CONNECTICUT', 'DALLAS', 'DELAWARE', 'DENVER', 'FLORIDA', 'FRESNO', 'GEORGIA',
                'HAWAI', 'HOUSTON', 'IDAHO', 'ILLINOIS', 'INDIANA', 'IOWA', 'KANSAS', 'KENTUCKY', 'LAS VEGAS',
                'LOS ANGELES', 'LOUISIANA', 'MAINE', 'MARYLAND', 'MASSACHUSETTS', 'MICHIGAN', 'MINNESOTA',
                'MISSISSIPI', 'MISSOURI', 'MONTANA', 'NEBRASKA', 'NEVADA', 'NEW HAMPSHIRE', 'NEW JERSEY',
                'NEW MEXICO', 'NEW ORLEANS', 'NEW YORK', 'NORTH CAROLINA', 'NORTH DAKOTA', 'OHIO', 'OKLAHOMA',
                'OMAHA', 'OREGON', 'PENNSYLVANIA', 'PHILADELPHIA', 'PHOENIX', 'PORTLAND', 'RELAI DE L\'EST',
                'RELAI ST PHILIPPE', 'RHODE ISLAND', 'SAN ANTONIO', 'SAN DIEGO', 'SAN JOSE', 'SEATTLE',
                'SOUTH CAROLINA', 'SOUTH DAKOTA', 'TENNESSEE', 'TEXAS', 'TOUR D\'ENTRE-DEUX', 'TOUR DE REGINA',
                'TOUR DES PINS', 'TOUR ESTRAPADE', 'TULSA', 'UTAH', 'VERMONT', 'VIRGINIA', 'WASHINGTON',
                'WEST VIRGINIA', 'WISCONSIN', 'WYOMING', 'SOUTH FISHING SHIP', 'SOUTHERN SILO', 'MAKIINPALLYS SILO'
            ]
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateStats();
            updateTime();
            setInterval(updateTime, 1000);
            setupDragAndDrop();
            
            // √âv√©nement pour le menu mobile
            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', toggleMobileMenu);
            }
            
            // Afficher le dashboard par d√©faut
            showTab('dashboard');
        });

        // Gestion des donn√©es (redirig√©e vers Firebase)
        function saveData() {
            // Rediriger vers la nouvelle fonction Firebase
            saveState();
        }

        function loadData() {
            // Rediriger vers la nouvelle fonction Firebase
            loadState();
        }

        // Gestion des onglets
        function showTab(tabName) {
            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // R√©initialiser tous les boutons de navigation
            document.querySelectorAll('.main-nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher le contenu s√©lectionn√©
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
            
            // Activer le bouton correspondant
            const targetTab = document.getElementById('tab-' + tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Fermer le menu mobile si ouvert
            const mobileMenu = document.getElementById('main-nav');
            if (mobileMenu) {
                mobileMenu.classList.remove('mobile-menu-open');
            }
        }
        
        // Gestion du menu mobile
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('main-nav');
            if (mobileMenu) {
                mobileMenu.classList.toggle('mobile-menu-open');
            }
        }

        // Gestion du temps
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('fr-FR');
        }

        // Gestion des statistiques
        function updateStats() {
            const squadCount = Object.keys(squads).length;
            const missionCount = Object.keys(missions).length;
            const personnelCount = Object.values(squads).reduce((total, squad) => {
                return total + (squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0);
            }, 0);
            
            document.getElementById('stats-squads').textContent = squadCount;
            document.getElementById('stats-missions').textContent = missionCount;
            document.getElementById('stats-personnel').textContent = personnelCount;
            
            // Mettre √† jour le dashboard dynamique
            renderDynamicDashboard();
        }
        
        // === FONCTIONS UTILITAIRES POUR MODALES ===
        
        // Fonction pour afficher une modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        // Fonction pour masquer une modal sp√©cifique
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Fonction pour masquer toutes les modales
        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.add('hidden');
            });
        }
        
        // Fonction pour afficher les notifications
        function showNotification(title, message) {
            const notification = document.getElementById('notification');
            const titleElement = document.getElementById('notification-title');
            const messageElement = document.getElementById('notification-message');
            
            if (notification && titleElement && messageElement) {
                titleElement.textContent = title;
                messageElement.textContent = message;
                notification.classList.add('show');
                
                // Masquer automatiquement apr√®s 5 secondes
                setTimeout(() => {
                    hideNotification();
                }, 5000);
            }
        }
        
        // Fonction pour masquer les notifications
        function hideNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.classList.remove('show');
            }
        }
        
        // === FONCTIONS UTILITAIRES AVANC√âES ===
        
        // Fonctions utilitaires pour les couleurs d'escouade
        function getSquadColor(squadName) {
            return SQUAD_COLORS[squadName] || '#6B7280'; // Gris par d√©faut
        }
        
        function applySquadColorToElement(element, squadName) {
            const color = getSquadColor(squadName);
            element.style.borderLeftColor = color;
        }
        
        // Obtenir le prochain nom d'escouade disponible
        function getNextAvailableSquadName(type = 'terrain') {
            const names = type === 'support' ? SUPPORT_NAMES : SQUAD_NAMES;
            
            for (const name of names) {
                if (!squads[name]) {
                    return name;
                }
            }
            
            // Si tous les noms sont pris, g√©n√©rer un nom avec num√©ro
            let counter = 2;
            const baseName = names[names.length - 1];
            while (squads[`${baseName}-${counter}`]) {
                counter++;
            }
            return `${baseName}-${counter}`;
        }
        
        // Cr√©er une escouade avec configuration avanc√©e
        function createAdvancedSquad(name, type = 'terrain') {
            const squad = {
                name: name,
                type: type === 'support' ? (name === 'LOGISTIQUE' ? 'Logistique' : 'Support') : 'Terrain',
                personnel: [],
                frequency: SQUAD_FREQUENCIES[name] || 30,
                color: getSquadColor(name),
                createdAt: new Date().toISOString(),
                status: 'Active'
            };
            
            // Ajouter des r√¥les pr√©d√©finis selon le type
            if (type === 'support') {
                if (name === 'LOGISTIQUE') {
                    squad.personnel = [
                        { name: '', grade: 'Sergent-Chef', role: 'Chef', status: 'Actif', position: 'Chef', team: null },
                        { name: '', grade: 'Sergent', role: 'Second', status: 'Actif', position: 'Second', team: null }
                    ];
                    // Ajouter 10 op√©rateurs logistique
                    for (let i = 1; i <= 10; i++) {
                        squad.personnel.push({
                            name: '', 
                            grade: 'Caporal', 
                            role: 'Op√©rateur Logistique', 
                            status: 'Actif',
                            position: `Op√©rateur ${i}`,
                            team: null
                        });
                    }
                } else if (name === 'PLANTON') {
                    squad.personnel = [
                        { name: '', grade: 'Caporal-Chef', role: 'Chef de Planton', status: 'Actif', position: 'Chef', team: null },
                        { name: '', grade: 'Caporal', role: 'Planton', status: 'Actif', position: 'Planton 1', team: null },
                        { name: '', grade: 'Caporal', role: 'Planton', status: 'Actif', position: 'Planton 2', team: null }
                    ];
                }
            } else {
                // Escouade de terrain standard
                squad.personnel = [
                    { name: '', grade: 'Sergent', role: 'Chef', status: 'Actif', position: 'Chef', team: null },
                    { name: '', grade: 'Caporal-Chef', role: 'Second', status: 'Actif', position: 'Second', team: null }
                ];
                // Ajouter 8 op√©rateurs
                for (let i = 1; i <= 8; i++) {
                    squad.personnel.push({
                        name: '', 
                        grade: 'Soldat', 
                        role: 'Fusilier', 
                        status: 'Actif',
                        position: `Op√©rateur ${i}`,
                        team: null
                    });
                }
            }
            
            return squad;
        }

        // Gestion des notifications
        function showNotification(title, message) {
            const notification = document.getElementById('notification');
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // Gestion des modales
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // === GESTION AVANC√âE DES ESCOUADES ===
        
        function openCreateSquadModal() {
            // R√©initialiser le type s√©lectionn√©
            squadCreationType = 'terrain';
            updateSquadCreationUI();
            showModal('create-squad-modal');
        }
        
        function updateSquadCreationUI() {
            const terrainBtn = document.querySelector('[data-squad-creation-type="terrain"]');
            const supportBtn = document.querySelector('[data-squad-creation-type="support"]');
            const nameInput = document.getElementById('squad-name');
            
            // Mettre √† jour les boutons
            if (terrainBtn && supportBtn) {
                terrainBtn.className = squadCreationType === 'terrain' ? 
                    'px-4 py-2 bg-green-600 text-white rounded font-bold' : 
                    'px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600';
                supportBtn.className = squadCreationType === 'support' ? 
                    'px-4 py-2 bg-blue-600 text-white rounded font-bold' : 
                    'px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600';
            }
            
            // Proposer le prochain nom disponible
            if (nameInput) {
                const nextName = getNextAvailableSquadName(squadCreationType);
                nameInput.value = nextName;
                nameInput.placeholder = `Ex: ${nextName}`;
            }
        }
        
        function setSquadCreationType(type) {
            squadCreationType = type;
            updateSquadCreationUI();
        }

        function createSquad(event) {
            event.preventDefault();
            
            let name = document.getElementById('squad-name').value.trim().toUpperCase();
            
            // Si aucun nom n'est fourni, utiliser le prochain nom automatique
            if (!name) {
                name = getNextAvailableSquadName(squadCreationType);
            }
            
            if (squads[name]) {
                showNotification('Erreur', 'Une escouade avec ce nom existe d√©j√†');
                return;
            }
            
            // Cr√©er l'escouade avec la logique avanc√©e
            const squad = createAdvancedSquad(name, squadCreationType);
            squads[name] = squad;
            
            saveData();
            renderSquadsList();
            renderQuickSquads();
            updateStats();
            hideModal('create-squad-modal');
            
            // R√©initialiser le formulaire
            document.getElementById('squad-name').value = '';
            squadCreationType = 'terrain';
            
            showNotification('Succ√®s', `Escouade ${name} (${squad.type}) cr√©√©e avec succ√®s`);
            
            // Proposer l'import d'effectifs
            setTimeout(() => {
                showSquadCreatedNotification(name);
            }, 1000);
        }
        
        // Notification post-cr√©ation pour import d'effectifs
        function showSquadCreatedNotification(squadName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg border border-green-500 max-w-md">
                    <h3 class="text-green-400 text-lg font-bold mb-4">‚úÖ Escouade ${squadName} cr√©√©e</h3>
                    <p class="text-gray-300 mb-6">Voulez-vous importer les effectifs depuis un fichier JSON ?</p>
                    <div class="flex gap-3">
                        <button onclick="triggerPersonnelImportForSquad('${squadName}'); document.body.removeChild(this.closest('.fixed'))" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold transition-colors">
                            üìÅ Importer Effectifs
                        </button>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold transition-colors">
                            Passer
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Import d'effectifs pour une escouade sp√©cifique
        function triggerPersonnelImportForSquad(squadName) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    importPersonnelForSpecificSquad(file, squadName);
                }
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }
        
        function importPersonnelForSpecificSquad(file, targetSquadName) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processImportedPersonnelForSquad(data, targetSquadName);
                } catch (error) {
                    showNotification('Erreur', 'Fichier JSON invalide');
                }
            };
            reader.readAsText(file);
        }
        
        function processImportedPersonnelForSquad(data, targetSquadName) {
            let importedMembers = [];
            
            // Chercher les donn√©es d'effectifs dans diff√©rents formats
            if (data.squads && data.squads[targetSquadName]) {
                importedMembers = data.squads[targetSquadName].personnel || data.squads[targetSquadName].members || [];
            } else if (data.squads && data.squads.LOGISTIQUE && targetSquadName === 'LOGISTIQUE') {
                importedMembers = data.squads.LOGISTIQUE.personnel || data.squads.LOGISTIQUE.members || [];
            } else if (data[targetSquadName]) {
                importedMembers = data[targetSquadName].personnel || data[targetSquadName].members || [];
            } else if (data.LOGISTIQUE && targetSquadName === 'LOGISTIQUE') {
                importedMembers = data.LOGISTIQUE.personnel || data.LOGISTIQUE.members || [];
            }
            
            if (importedMembers.length === 0) {
                showNotification('Information', 'Aucun effectif trouv√© dans le fichier pour cette escouade');
                return;
            }
            
            // Filtrer les membres avec un nom renseign√©
            const validMembers = importedMembers.filter(member => member.name && member.name.trim());
            
            if (validMembers.length === 0) {
                showNotification('Information', 'Aucun membre avec nom renseign√© trouv√©');
                return;
            }
            
            // Int√©grer dans l'escouade cible
            if (squads[targetSquadName]) {
                // Remplacer les membres vides par les membres import√©s
                const targetSquad = squads[targetSquadName];
                let importCount = 0;
                
                validMembers.forEach(importedMember => {
                    // Chercher un emplacement vide correspondant au r√¥le
                    const emptySlotIndex = targetSquad.personnel.findIndex(member => 
                        !member.name && (member.role === importedMember.role || member.position === importedMember.position)
                    );
                    
                    if (emptySlotIndex !== -1) {
                        targetSquad.personnel[emptySlotIndex] = {
                            ...targetSquad.personnel[emptySlotIndex],
                            name: importedMember.name,
                            grade: importedMember.grade || targetSquad.personnel[emptySlotIndex].grade,
                            status: importedMember.status || 'Actif'
                        };
                        importCount++;
                    } else {
                        // Ajouter √† la fin si pas d'emplacement sp√©cifique
                        targetSquad.personnel.push({
                            name: importedMember.name,
                            grade: importedMember.grade || 'Soldat',
                            role: importedMember.role || 'Op√©rateur',
                            status: importedMember.status || 'Actif',
                            position: importedMember.position || importedMember.role || 'Op√©rateur',
                            team: importedMember.team || null
                        });
                        importCount++;
                    }
                });
                
                saveData();
                renderSquadsList();
                updateStats();
                
                showNotification('Succ√®s', `${importCount} membre(s) import√©(s) dans l'escouade ${targetSquadName}`);
            }
        }

        function renderSquadsList() {
            const supportContainer = document.getElementById('support-squads-list');
            const terrainContainer = document.getElementById('terrain-squads-list');
            
            // S√©parer les escouades par type
            const supportSquads = Object.values(squads).filter(squad => SUPPORT_NAMES.includes(squad.name));
            const terrainSquads = Object.values(squads).filter(squad => !SUPPORT_NAMES.includes(squad.name));
            
            // Trier chaque groupe par ordre alphab√©tique
            supportSquads.sort((a, b) => a.name.localeCompare(b.name));
            terrainSquads.sort((a, b) => a.name.localeCompare(b.name));
            
            // Fonction pour g√©n√©rer le HTML d'une escouade
            const generateSquadHTML = (squad) => {
                const squadColor = getSquadColor(squad.name);
                const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
                const totalSlots = squad.personnel ? squad.personnel.length : 0;
                const frequency = squad.frequency || SQUAD_FREQUENCIES[squad.name] || 'N/A';
                const isSelected = selectedSquad === squad.name;
                
                return `
                    <div class="squad-card p-3 rounded-lg cursor-pointer transition-all duration-200 border-l-4 ${
                        isSelected ? 'bg-slate-700 border-l-4' : 'hover:bg-slate-800 border-l-4'
                    }" 
                         style="border-left-color: ${squadColor}" 
                         onclick="selectSquad('${squad.name}')">
                        <div class="flex justify-between items-center">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-bold text-lg" style="color: ${squadColor}">${squad.name}</h4>
                                    <span class="text-xs px-2 py-1 rounded" style="background-color: ${squadColor}20; color: ${squadColor}">
                                        ${squad.type}
                                    </span>
                                </div>
                                <div class="flex items-center gap-4 text-xs text-gray-400">
                                    <span>üë• ${personnelCount}/${totalSlots}</span>
                                    <span>üìª ${frequency} MHz</span>
                                    <span class="px-2 py-1 rounded ${
                                        squad.status === 'Active' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'
                                    }">${squad.status || 'Active'}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <button onclick="event.stopPropagation(); deleteSquad('${squad.name}')" 
                                        class="text-red-400 hover:text-red-300 text-sm px-2 py-1 rounded hover:bg-red-900/20">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // Remplir l'encart Support
            if (supportSquads.length === 0) {
                supportContainer.innerHTML = '<p class="text-gray-400 text-sm">Aucune escouade de support</p>';
            } else {
                supportContainer.innerHTML = supportSquads.map(generateSquadHTML).join('');
            }
            
            // Remplir l'encart Terrain
            if (terrainSquads.length === 0) {
                terrainContainer.innerHTML = '<p class="text-gray-400 text-sm">Aucune escouade de terrain</p>';
            } else {
                terrainContainer.innerHTML = terrainSquads.map(generateSquadHTML).join('');
            }
        }

        function renderQuickSquads() {
            const container = document.getElementById('dashboard-all-squads');
            
            if (!container) {
                console.warn('Element dashboard-all-squads not found');
                return;
            }
            
            if (Object.keys(squads).length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">Aucune escouade cr√©√©e</p>';
                return;
            }
            
            // S√©parer les escouades de support et de terrain
            const supportSquads = Object.values(squads).filter(squad => SUPPORT_NAMES.includes(squad.name));
            const terrainSquads = Object.values(squads).filter(squad => !SUPPORT_NAMES.includes(squad.name));
            
            let html = '';
            
            // Section Support (Logistique/Planton)
            if (supportSquads.length > 0) {
                html += '<div class="mb-4">';
                html += '<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">üîß Support</h4>';
                html += supportSquads.map(squad => {
                    const squadColor = getSquadColor(squad.name);
                    const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
                    const totalSlots = squad.personnel ? squad.personnel.length : 0;
                    
                    return `
                        <div class="flex justify-between items-center py-2 px-3 rounded border-l-4 hover:bg-slate-800 cursor-pointer transition-colors" 
                             style="border-left-color: ${squadColor}" 
                             onclick="showTab('squads'); selectSquad('${squad.name}')">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold" style="color: ${squadColor}">${squad.name}</span>
                                <span class="text-xs px-1 py-0.5 rounded" style="background-color: ${squadColor}20; color: ${squadColor}">
                                    ${squad.type}
                                </span>
                            </div>
                            <span class="text-xs text-gray-400">üë• ${personnelCount}/${totalSlots}</span>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }
            
            // Section Terrain (Alpha, Bravo, etc.)
            if (terrainSquads.length > 0) {
                html += '<div>';
                html += '<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">üèÉ Op√©rationnelles</h4>';
                html += '<div class="grid grid-cols-1 gap-1">';
                html += terrainSquads.slice(0, 6).map(squad => {
                    const squadColor = getSquadColor(squad.name);
                    const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
                    const totalSlots = squad.personnel ? squad.personnel.length : 0;
                    
                    return `
                        <div class="flex justify-between items-center py-2 px-3 rounded border-l-4 hover:bg-slate-800 cursor-pointer transition-colors" 
                             style="border-left-color: ${squadColor}" 
                             onclick="showTab('squads'); selectSquad('${squad.name}')">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold" style="color: ${squadColor}">${squad.name}</span>
                                <span class="text-xs" style="color: ${squadColor}">üìª ${squad.frequency || SQUAD_FREQUENCIES[squad.name] || 'N/A'}</span>
                            </div>
                            <span class="text-xs text-gray-400">üë• ${personnelCount}/${totalSlots}</span>
                        </div>
                    `;
                }).join('');
                html += '</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Fonction pour afficher toutes les missions dans le dashboard
        function renderDashboardMissions() {
            const container = document.getElementById('dashboard-all-missions');
            if (!container) {
                console.warn('Element dashboard-all-missions not found');
                return;
            }
            
            const activeMissions = Object.entries(missions).filter(([name, mission]) => 
                mission.status !== 'Termin√©e' && mission.status !== '√âchou√©e'
            );
            
            if (activeMissions.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">Aucune mission en cours</p>';
                return;
            }
            
            const html = activeMissions.map(([name, mission]) => {
                const statusColor = mission.status === 'En cours' ? 'text-green-400' :
                                   mission.status === 'En attente' ? 'text-yellow-400' :
                                   mission.status === 'Planifi√©e' ? 'text-blue-400' : 'text-gray-400';
                
                const completedObjectives = mission.objectives ? mission.objectives.filter(obj => obj.status === 'completed').length : 0;
                const totalObjectives = mission.objectives ? mission.objectives.length : 0;
                const progressPercent = totalObjectives > 0 ? Math.round((completedObjectives / totalObjectives) * 100) : 0;
                
                const assignedSquads = mission.assignedSquads || [];
                const squadsList = assignedSquads.length > 0 ? assignedSquads.join(', ') : 'Aucune';
                
                return `
                    <div class="bg-slate-800 p-3 rounded-lg border border-gray-700 hover:border-gray-600 cursor-pointer transition-colors"
                         onclick="showTab('missions'); selectMission('${name}');">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-white text-sm truncate">${name}</h4>
                            <span class="text-xs ${statusColor} font-medium">${mission.status || 'En cours'}</span>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-2">
                            <div class="mb-1">üìã ${mission.category || 'Non d√©finie'}</div>
                            <div class="mb-1">üë• ${squadsList}</div>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">Objectifs: ${completedObjectives}/${totalObjectives}</span>
                            <div class="flex items-center gap-1">
                                <div class="w-12 h-1 bg-gray-700 rounded">
                                    <div class="h-1 bg-green-500 rounded" style="width: ${progressPercent}%"></div>
                                </div>
                                <span class="text-green-400 font-medium">${progressPercent}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Fonction pour afficher toutes les missions termin√©es dans le dashboard
        function renderDashboardCompletedMissions() {
            const container = document.getElementById('dashboard-completed-missions');
            if (!container) {
                console.warn('Element dashboard-completed-missions not found');
                return;
            }
            
            const completedMissions = Object.entries(missions).filter(([name, mission]) => 
                mission.status === 'Termin√©e'
            );
            
            if (completedMissions.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">Aucune mission termin√©e</p>';
                return;
            }
            
            const html = completedMissions.map(([name, mission]) => {
                const completedObjectives = mission.objectives ? mission.objectives.filter(obj => obj.status === 'completed').length : 0;
                const failedObjectives = mission.objectives ? mission.objectives.filter(obj => obj.status === 'failed').length : 0;
                const totalObjectives = mission.objectives ? mission.objectives.length : 0;
                const successRate = totalObjectives > 0 ? Math.round((completedObjectives / totalObjectives) * 100) : 0;
                
                const assignedSquads = mission.assignedSquads || [];
                const squadsList = assignedSquads.length > 0 ? assignedSquads.join(', ') : 'Aucune';
                
                // Calculer la dur√©e de la mission
                let durationText = 'N/A';
                if (mission.creationDate && mission.completionDate) {
                    const duration = Math.round((new Date(mission.completionDate) - new Date(mission.creationDate)) / (1000 * 60 * 60));
                    durationText = duration > 0 ? `${duration}h` : '<1h';
                }
                
                return `
                    <div class="bg-slate-800 p-3 rounded-lg border border-blue-700/30 hover:border-blue-600/50 cursor-pointer transition-colors"
                         onclick="showTab('missions'); selectMission('${name}');">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-white text-sm truncate">${name}</h4>
                            <div class="flex items-center gap-1">
                                <span class="text-xs px-2 py-1 rounded bg-blue-900/20 text-blue-300 font-medium">TERMIN√âE</span>
                                <button onclick="event.stopPropagation(); showMissionCompletionReport('${name}')" 
                                        class="text-xs px-1 py-1 rounded bg-cyan-900/20 text-cyan-300 hover:bg-cyan-900/40 transition-colors"
                                        title="Voir le rapport de synth√®se">
                                    üìã
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-2">
                            <div class="mb-1">üìã ${mission.category || 'Non d√©finie'}</div>
                            <div class="mb-1">üë• ${squadsList}</div>
                            <div class="mb-1">‚è±Ô∏è Dur√©e: ${durationText}</div>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center gap-2">
                                <span class="text-green-400">‚úì ${completedObjectives}</span>
                                <span class="text-red-400">‚úó ${failedObjectives}</span>
                                <span class="text-gray-500">/${totalObjectives}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-12 h-1 bg-gray-700 rounded">
                                    <div class="h-1 bg-blue-500 rounded" style="width: ${successRate}%"></div>
                                </div>
                                <span class="text-blue-400 font-medium">${successRate}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Fonction de suppression d'escouade
        function deleteSquad(squadName) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'escouade ${squadName} ?\n\nCette action est irr√©versible.`)) {
                delete squads[squadName];
                
                // R√©initialiser la s√©lection si l'escouade supprim√©e √©tait s√©lectionn√©e
                if (selectedSquad === squadName) {
                    selectedSquad = null;
                }
                
                saveData();
                renderSquadsList();
                renderQuickSquads();
                updateStats();
                
                // Vider le d√©tail si l'escouade supprim√©e √©tait affich√©e
                if (selectedSquad === squadName) {
                    document.getElementById('squad-detail').innerHTML = `
                        <div class="text-center text-gray-400 py-12">
                            <p>S√©lectionnez une escouade pour voir les d√©tails</p>
                        </div>
                    `;
                }
                
                showNotification('Succ√®s', `Escouade ${squadName} supprim√©e avec succ√®s`);
            }
        }

        function selectSquad(squadName) {
            selectedSquad = squadName;
            renderSquadDetail();
        }

        function renderSquadDetail() {
            const container = document.getElementById('squad-detail');
            
            if (!selectedSquad || !squads[selectedSquad]) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-12">
                        <p>S√©lectionnez une escouade pour voir les d√©tails</p>
                    </div>
                `;
                return;
            }
            
            // Fonction utilitaire pour obtenir la cat√©gorie de grade
            function getGradeCategory(grade) {
                if (GRADE_CATEGORIES.officer.includes(grade)) return 'officer';
                if (GRADE_CATEGORIES.nco.includes(grade)) return 'nco';
                return 'enlisted';
            }
            
            // Trouver les missions assign√©es √† cette escouade
            const assignedMissions = Object.values(missions).filter(mission => 
                mission.assignedSquads.includes(selectedSquad)
            );
            
            const squad = squads[selectedSquad];
            const personnel = squad.personnel || [];
            const squadColor = getSquadColor(squad.name);
            const personnelCount = personnel.filter(p => p.name && p.name.trim()).length;
            
            // D√©tecter si l'escouade est incompl√®te (moins de 10 membres)
            const isIncomplete = personnel.length < 10;
            const vacantPositions = 10 - personnel.length;
            
            // Analyser les trades dans l'escouade
            const tradeStats = {};
            personnel.forEach(member => {
                if (member.role && TRADES[member.role]) {
                    tradeStats[member.role] = (tradeStats[member.role] || 0) + 1;
                }
            });
            
            let content = `
                <div class="squad-detail-content">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-2" style="color: ${squadColor}">${squad.name}</h2>
                            <div class="flex items-center gap-4 text-sm text-gray-300">
                                <span>üìª ${squad.frequency || SQUAD_FREQUENCIES[squad.name] || 'N/A'} MHz</span>
                                <span>üë• ${personnelCount}/10 membres</span>
                        ${isIncomplete ? `<span class="px-2 py-1 rounded bg-yellow-900/50 text-yellow-300 border border-yellow-500/30 text-xs font-medium">‚ö†Ô∏è ${vacantPositions} poste${vacantPositions > 1 ? 's' : ''} vacant${vacantPositions > 1 ? 's' : ''}</span>` : ''}
                                <span class="px-2 py-1 rounded ${squad.status === 'Active' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
                                    ${squad.status || 'Active'}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            ${assignedMissions.length === 0 ? `
                                <button onclick="openSquadAssignmentModal('${squad.name}')" 
                                        class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 px-3 py-2 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200 text-sm flex items-center gap-2 font-medium"
                                        title="Affecter cette escouade √† une mission">
                                    üéØ Affecter √† Mission
                                </button>
                            ` : ''}
                            <button onclick="dissolveSquad('${squad.name}')" 
                                    class="bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 px-3 py-2 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 text-sm flex items-center gap-2 font-medium"
                                    title="Dissoudre cette escouade">
                                ‚ö° Dissoudre
                            </button>
                        </div>
                    </div>
            `;
            
            // Afficher les missions assign√©es
            if (assignedMissions.length > 0) {
                content += `
                    <div class="bg-orange-900/20 border border-orange-500/30 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-orange-400 mb-3">üéØ Missions Assign√©es</h3>
                        <div class="space-y-2">
                `;
                
                assignedMissions.forEach(mission => {
                    const statusColor = {
                        'En pr√©paration': 'text-yellow-400',
                        'En cours': 'text-blue-400',
                        'Termin√©e': 'text-green-400',
                        'Annul√©e': 'text-red-400'
                    }[mission.status] || 'text-gray-400';
                    
                    content += `
                        <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-colors" 
                             onclick="showTab('missions'); selectMission('${mission.name}')">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-orange-400">${mission.name}</span>
                                    <span class="text-xs px-2 py-1 rounded bg-orange-900/20 text-orange-300">
                                        ${mission.category}
                                    </span>
                                </div>
                                <div class="text-xs text-gray-400">
                                    üìç ${mission.sector} ‚Ä¢ <span class="${statusColor}">${mission.status}</span>
                                </div>
                            </div>
                            <div class="text-orange-400">
                                ‚Üí
                            </div>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Afficher les trades
            if (Object.keys(tradeStats).length > 0) {
                content += `
                    <div class="bg-slate-800 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-3">‚öîÔ∏è Composition par Trades</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                `;
                
                Object.entries(tradeStats).forEach(([trade, count]) => {
                    const tradeInfo = TRADES[trade];
                    if (tradeInfo) {
                        content += `
                            <div class="flex items-center gap-2 p-2 bg-slate-700 rounded" style="border-left: 3px solid ${tradeInfo.color}">
                                <span class="text-lg">${tradeInfo.icon}</span>
                                <div class="flex-grow">
                                    <div class="text-sm font-semibold" style="color: ${tradeInfo.color}">${tradeInfo.name}</div>
                                    <div class="text-xs text-gray-400">${count} membre${count > 1 ? 's' : ''}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Afficher le personnel
            content += `
                <div class="bg-slate-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-cyan-400 mb-3">üë• Personnel</h3>
            `;
            
            // S√©parer le personnel : chef, second, et autres
            const chief = personnel.find(member => member.position === 'Chef');
            const second = personnel.find(member => member.position === 'Second');
            const others = personnel.filter(member => member.position !== 'Chef' && member.position !== 'Second');
            
            // Fonction pour g√©n√©rer une carte de membre
            function generateMemberCard(member, isCompact = false) {
                if (!member) return '';
                
                const isEmpty = !member.name || !member.name.trim();
                const isLeader = member.position === 'Chef';
                const isSecond = member.position === 'Second';
                const tradeInfo = TRADES[member.role] || null;
                
                return `
                    <div class="bg-slate-700 p-4 rounded-lg border border-slate-600 shadow-sm transition-all hover:bg-slate-600 hover:border-slate-500 border-l-4 ${
                        isLeader ? 'border-l-yellow-500' : 
                        isSecond ? 'border-l-orange-500' : 
                        'border-l-green-500'
                    }">
                        <div class="flex justify-between items-center">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-3 flex-wrap">
                                    <span class="text-xs px-2 py-1 rounded font-bold ${
                                        isLeader ? 'bg-yellow-900 text-yellow-300' :
                                        isSecond ? 'bg-orange-900 text-orange-300' :
                                        'bg-gray-800 text-gray-300'
                                    }">
                                        ${member.position || member.role || 'Op√©rateur'}
                                    </span>
                                    ${member.team ? `<span class="text-xs px-2 py-1 rounded bg-blue-900 text-blue-300">√âquipe ${member.team}</span>` : ''}
                                    ${tradeInfo ? `<span class="text-xs px-2 py-1 rounded" style="background-color: ${tradeInfo.color}20; color: ${tradeInfo.color}; border: 1px solid ${tradeInfo.color}40;">${tradeInfo.icon} ${tradeInfo.name}</span>` : ''}
                                </div>
                                <div class="${isCompact ? 'grid grid-cols-1 gap-3' : 'grid grid-cols-1 md:grid-cols-3 gap-4'}">
                                    <div class="bg-slate-800 p-2 rounded">
                                        <label class="text-xs text-gray-400 uppercase tracking-wider block mb-1">Nom</label>
                                        <p class="font-bold text-sm ${
                                            isEmpty ? 'text-gray-500 italic' : 'text-white'
                                        }">${member.name || 'Non assign√©'}</p>
                                    </div>
                                    ${!isCompact ? `
                                    <div class="bg-slate-800 p-2 rounded">
                                        <label class="text-xs text-gray-400 uppercase tracking-wider block mb-1">Grade</label>
                                        <p class="text-gray-300 text-sm">${member.grade || 'N/A'}</p>
                                    </div>
                                    <div class="bg-slate-800 p-2 rounded">
                                        <label class="text-xs text-gray-400 uppercase tracking-wider block mb-1">R√¥le</label>
                                        <p class="text-gray-300 text-sm">${member.role || 'N/A'}</p>
                                    </div>
                                    ` : `
                                    <div class="flex gap-3">
                                        <div class="flex-1 bg-slate-800 p-2 rounded">
                                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-1">Grade</label>
                                            <p class="text-gray-300 text-sm">${member.grade || 'N/A'}</p>
                                        </div>
                                        <div class="flex-1 bg-slate-800 p-2 rounded">
                                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-1">R√¥le</label>
                                            <p class="text-gray-300 text-sm">${member.role || 'N/A'}</p>
                                        </div>
                                    </div>
                                    `}
                                </div>
                                <div class="mt-3 flex items-center justify-between">
                                    <span class="text-xs px-3 py-1 rounded-full font-medium ${
                                        member.status === 'Actif' ? 'bg-green-900/50 text-green-300 border border-green-500/30' : 
                                        member.status === 'Bless√©' ? 'bg-yellow-900/50 text-yellow-300 border border-yellow-500/30' :
                                        member.status === 'Indisponible' ? 'bg-red-900/50 text-red-300 border border-red-500/30' :
                                        'bg-gray-800 text-gray-300 border border-gray-600'
                                    }">${member.status || 'Actif'}</span>
                                    ${!isEmpty ? `<div class="text-xs text-gray-500">‚Ä¢ ID: ${member.name ? member.name.substring(0, 3).toUpperCase() : 'XXX'}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Afficher chef et second en haut
            if (chief || second) {
                content += `
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-yellow-400 mb-3">üéñÔ∏è Commandement</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                
                if (chief) {
                    content += `<div>${generateMemberCard(chief, false)}</div>`;
                }
                if (second) {
                    content += `<div>${generateMemberCard(second, false)}</div>`;
                }
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Afficher les autres membres sur 2 colonnes
            if (others.length > 0) {
                content += `
                    <div>
                        <h4 class="text-md font-semibold text-cyan-400 mb-3">üë• √âquipiers</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                `;
                
                others.forEach(member => {
                    content += `<div>${generateMemberCard(member, true)}</div>`;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Afficher les postes vacants si l'escouade est incompl√®te
            if (isIncomplete) {
                content += `
                    <div class="mt-6">
                        <h4 class="text-md font-semibold text-yellow-400 mb-3 flex items-center gap-2">
                            ‚ö†Ô∏è Postes Vacants
                            <span class="text-xs px-2 py-1 rounded bg-yellow-900/50 text-yellow-300 border border-yellow-500/30">
                                ${vacantPositions} poste${vacantPositions > 1 ? 's' : ''} √† pourvoir
                            </span>
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                `;
                
                // G√©n√©rer les cartes de postes vacants
                for (let i = 0; i < vacantPositions; i++) {
                    const positionIndex = personnel.length + i + 1;
                    content += `
                        <div class="bg-slate-700/50 p-4 rounded-lg border border-yellow-500/30 shadow-sm transition-all hover:bg-slate-700 hover:border-yellow-500/50 border-l-4 border-l-yellow-500">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-xs px-2 py-1 rounded font-bold bg-yellow-900/50 text-yellow-300 border border-yellow-500/30">
                                            Op√©rateur ${positionIndex}
                                        </span>
                                        <span class="text-xs px-2 py-1 rounded bg-gray-800 text-gray-400 border border-gray-600">
                                            VACANT
                                        </span>
                                    </div>
                                    
                                    <!-- Formulaire de saisie directe -->
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-1 gap-3">
                                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                                <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Nom complet *</label>
                                                <input type="text" 
                                                       id="vacant-name-${positionIndex}" 
                                                       class="w-full bg-slate-700 text-white p-2 rounded border border-slate-500 focus:border-yellow-500 focus:outline-none text-sm"
                                                       placeholder="Entrez le nom du membre..."
                                                       maxlength="50">
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                                <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Grade</label>
                                                <select id="vacant-grade-${positionIndex}" 
                                                        class="w-full bg-slate-700 text-white p-2 rounded border border-slate-500 focus:border-yellow-500 focus:outline-none text-sm">
                                                    <option value="">S√©lectionner un grade...</option>
                                                    <option value="Soldat">Soldat</option>
                                                    <option value="Soldat de 1√®re classe">Soldat de 1√®re classe</option>
                                                    <option value="Caporal">Caporal</option>
                                                    <option value="Caporal-Chef">Caporal-Chef</option>
                                                    <option value="Sergent">Sergent</option>
                                                    <option value="Sergent-Chef">Sergent-Chef</option>
                                                    <option value="Adjudant">Adjudant</option>
                                                    <option value="Adjudant-Chef">Adjudant-Chef</option>
                                                    <option value="Major">Major</option>
                                                    <option value="Aspirant">Aspirant</option>
                                                    <option value="Sous-Lieutenant">Sous-Lieutenant</option>
                                                    <option value="Lieutenant">Lieutenant</option>
                                                    <option value="Capitaine">Capitaine</option>
                                                </select>
                                            </div>
                                            
                                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                                <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">R√¥le/Sp√©cialit√©</label>
                                                <select id="vacant-role-${positionIndex}" 
                                                        class="w-full bg-slate-700 text-white p-2 rounded border border-slate-500 focus:border-yellow-500 focus:outline-none text-sm">
                                                    <option value="">S√©lectionner un r√¥le...</option>
                                                    <option value="Fusilier">Fusilier</option>
                                                    <option value="Grenadier">Grenadier</option>
                                                    <option value="Mitrailleur">Mitrailleur</option>
                                                    <option value="Tireur d'√©lite">Tireur d'√©lite</option>
                                                    <option value="M√©dic">M√©dic</option>
                                                    <option value="Ing√©nieur">Ing√©nieur</option>
                                                    <option value="Op√©rateur radio">Op√©rateur radio</option>
                                                    <option value="√âclaireur">√âclaireur</option>
                                                    <option value="Sp√©cialiste AT">Sp√©cialiste AT</option>
                                                    <option value="Sp√©cialiste AA">Sp√©cialiste AA</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="flex justify-end gap-2 pt-2">
                                            <button onclick="addVacantMember('${squad.name}', ${positionIndex})" 
                                                    class="bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 px-4 py-2 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200 text-sm flex items-center gap-2 font-medium">
                                                ‚úÖ Ajouter ce membre
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                content += `
                        </div>
                        
                        <!-- Bouton pour compl√©ter automatiquement -->
                        <div class="mt-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-400 mb-1">Compl√©tion automatique</h5>
                                    <p class="text-xs text-gray-400">G√©n√©rer automatiquement ${vacantPositions} membre${vacantPositions > 1 ? 's' : ''} avec des noms et grades par d√©faut</p>
                                </div>
                                <button onclick="autoCompleteSquad('${squad.name}')" 
                                        class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 px-4 py-2 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200 text-sm flex items-center gap-2 font-medium">
                                    ü§ñ Compl√©ter automatiquement
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content += `
                </div>
            </div>
            `;
            
            container.innerHTML = content;
        }

        // Fonction pour dissoudre une escouade (avec modal de confirmation personnalis√©e)
        function dissolveSquad(squadName) {
            console.log('üöÄ dissolveSquad appel√©e avec:', squadName);
            console.log('üìã Escouades actuelles:', Object.keys(squads));
            console.log('üéØ Escouade s√©lectionn√©e:', selectedSquad);
            
            if (!squads[squadName]) {
                console.error('‚ùå Escouade introuvable:', squadName);
                alert('Erreur: Escouade introuvable.');
                return;
            }
            
            const squad = squads[squadName];
            const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
            
            // V√©rifier si l'escouade est assign√©e √† des missions
            const assignedMissions = Object.values(missions).filter(mission => 
                mission.assignedSquads.includes(squadName)
            );
            
            let warningMessage = `√ätes-vous s√ªr de vouloir dissoudre l'escouade "${squadName}" ?\n\nCette action est irr√©versible et supprimera d√©finitivement :`;
            warningMessage += `\n‚Ä¢ ${personnelCount} membre(s) du personnel`;
            warningMessage += `\n‚Ä¢ Toutes les donn√©es d'organisation`;
            
            if (assignedMissions.length > 0) {
                warningMessage += `\n‚Ä¢ L'affectation √† ${assignedMissions.length} mission(s) en cours`;
                warningMessage += `\n\n‚ö†Ô∏è ATTENTION: Cette escouade est actuellement assign√©e aux missions suivantes :`;
                assignedMissions.forEach(mission => {
                    warningMessage += `\n  - ${mission.name} (${mission.status})`;
                });
            }
            
            console.log('‚úÖ Escouade trouv√©e, affichage de la modal de confirmation');
            
            // Utiliser la modal de confirmation personnalis√©e
            showCustomConfirmation(
                'Dissoudre Escouade',
                warningMessage,
                function() {
                    console.log('‚úÖ Dissolution confirm√©e, suppression en cours...');
                    
                    // Retirer l'escouade de toutes les missions assign√©es
                    if (assignedMissions.length > 0) {
                        assignedMissions.forEach(mission => {
                            mission.assignedSquads = mission.assignedSquads.filter(name => name !== squadName);
                            console.log(`üîÑ Escouade retir√©e de la mission: ${mission.name}`);
                        });
                    }
                    
                    // Supprimer l'escouade
                    delete squads[squadName];
                    console.log('üóëÔ∏è Escouade supprim√©e des donn√©es');
                    
                    // Si c'√©tait l'escouade s√©lectionn√©e, d√©s√©lectionner
                    if (selectedSquad === squadName) {
                        selectedSquad = null;
                        console.log('üéØ Escouade d√©s√©lectionn√©e');
                    }
                    
                    console.log('üíæ Sauvegarde en cours...');
                    saveState();
                    
                    console.log('üîÑ Mise √† jour de l\'interface...');
                    renderSquadsList();
                    renderSquadDetail();
                    renderQuickSquads();
                    renderDashboardMissions();
                    updateStats();
                    
                    console.log('‚úÖ Dissolution termin√©e avec succ√®s');
                    
                    // Notification de succ√®s avec style personnalis√©
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-orange-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>‚ö°</span>
                            <span>Escouade "${squadName}" dissoute avec succ√®s</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Supprimer la notification apr√®s 3 secondes
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            );
        }
        
        // Fonction pour supprimer une escouade (ancienne version - gard√©e pour compatibilit√©)
        function deleteSquad(squadName) {
            // Rediriger vers la nouvelle fonction dissolveSquad
            dissolveSquad(squadName);
        }
        
        // Fonction pour ajouter un membre vacant √† une escouade
        function addVacantMember(squadName, positionIndex) {
            const nameInput = document.getElementById(`vacant-name-${positionIndex}`);
            const gradeSelect = document.getElementById(`vacant-grade-${positionIndex}`);
            const roleSelect = document.getElementById(`vacant-role-${positionIndex}`);
            
            // Validation des champs
            const name = nameInput.value.trim();
            if (!name) {
                showNotification('Veuillez saisir un nom pour le membre', 'error');
                nameInput.focus();
                return;
            }
            
            const grade = gradeSelect.value || 'Soldat';
            const role = roleSelect.value || 'Fusilier';
            
            // V√©rifier que l'escouade existe
            if (!squads[squadName]) {
                showNotification('Erreur: Escouade introuvable', 'error');
                return;
            }
            
            // Cr√©er le nouveau membre
            const newMember = {
                name: name,
                grade: grade,
                role: role,
                position: `Op√©rateur ${positionIndex}`,
                status: 'Actif'
            };
            
            // Ajouter le membre √† l'escouade
            squads[squadName].personnel.push(newMember);
            
            // Sauvegarder et mettre √† jour l'interface
            saveState();
            renderSquadDetail();
            renderSquadsList();
            updateStats();
            
            showNotification(`${name} ajout√©(e) avec succ√®s √† l'escouade ${squadName}`, 'success');
        }
        
        // Fonction pour compl√©ter automatiquement une escouade
        function autoCompleteSquad(squadName) {
            if (!squads[squadName]) {
                showNotification('Erreur: Escouade introuvable', 'error');
                return;
            }
            
            const squad = squads[squadName];
            const currentCount = squad.personnel.length;
            const needed = 10 - currentCount;
            
            if (needed <= 0) {
                showNotification('Cette escouade est d√©j√† compl√®te', 'info');
                return;
            }
            
            // Noms g√©n√©riques pour compl√©tion automatique
            const genericNames = [
                'Martin Dubois', 'Pierre Moreau', 'Jean Leroy', 'Paul Bernard',
                'Michel Petit', 'Andr√© Durand', 'Henri Lambert', 'Louis Rousseau',
                'Fran√ßois Garnier', 'Robert Fabre', 'Jacques Mercier', 'Antoine Blanc',
                'Nicolas Girard', 'Julien Fournier', 'Maxime Bonnet', 'Thomas Dupont',
                'Alexandre Simon', 'S√©bastien Michel', 'Vincent Laurent', 'David Lefebvre'
            ];
            
            // Grades par d√©faut pour les op√©rateurs
            const defaultGrades = ['Soldat', 'Soldat de 1√®re classe', 'Caporal'];
            
            // R√¥les par d√©faut
            const defaultRoles = ['Fusilier', 'Grenadier', 'Mitrailleur', 'M√©dic', 'Ing√©nieur', 'Op√©rateur radio'];
            
            // Ajouter les membres manquants
            for (let i = 0; i < needed; i++) {
                const memberIndex = currentCount + i;
                const nameIndex = memberIndex % genericNames.length;
                const gradeIndex = Math.floor(Math.random() * defaultGrades.length);
                const roleIndex = Math.floor(Math.random() * defaultRoles.length);
                
                const newMember = {
                    name: genericNames[nameIndex],
                    grade: defaultGrades[gradeIndex],
                    role: defaultRoles[roleIndex],
                    position: `Op√©rateur ${memberIndex + 1}`,
                    status: 'Actif'
                };
                
                squad.personnel.push(newMember);
            }
            
            // Sauvegarder et mettre √† jour l'interface
            saveState();
            renderSquadDetail();
            renderSquadsList();
            updateStats();
            
            showNotification(`${needed} membre${needed > 1 ? 's' : ''} ajout√©${needed > 1 ? 's' : ''} automatiquement √† l'escouade ${squadName}`, 'success');
        }

        // Syst√®me d'import robuste
        function openImportModal() {
            showModal('import-modal');
            document.getElementById('import-preview').classList.add('hidden');
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processImportFile(files[0]);
                }
            });
        }

        function selectFile() {
            document.getElementById('file-input').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processImportFile(file);
            }
        }

        function processImportFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validation robuste
                    if (!data || typeof data !== 'object') {
                        throw new Error('Le fichier doit contenir un objet JSON valide.');
                    }
                    
                    // D√©tection s√©curis√©e des escouades
                    let squadsData = null;
                    
                    if (data.squads && typeof data.squads === 'object') {
                        // Format standard avec propri√©t√© squads
                        squadsData = data.squads;
                    } else {
                        // D√©tection automatique des escouades en propri√©t√©s directes
                        const possibleSquads = {};
                        
                        Object.keys(data).forEach(key => {
                            // Ignorer les m√©tadonn√©es
                            if (key === 'exportDate' || key === 'timestamp' || key === 'metadata') {
                                return;
                            }
                            
                            // V√©rifier si c'est une escouade
                            const item = data[key];
                            if (item && typeof item === 'object' && 
                                (Array.isArray(item.personnel) || Array.isArray(item.members))) {
                                possibleSquads[key] = item;
                            }
                        });
                        
                        if (Object.keys(possibleSquads).length > 0) {
                            squadsData = possibleSquads;
                        }
                    }
                    
                    if (!squadsData || Object.keys(squadsData).length === 0) {
                        throw new Error('Aucune escouade d√©tect√©e dans le fichier.');
                    }
                    
                    // Normaliser les donn√©es
                    Object.keys(squadsData).forEach(squadName => {
                        const squad = squadsData[squadName];
                        if (squad.members && !squad.personnel) {
                            squad.personnel = squad.members;
                        }
                        if (!squad.personnel) {
                            squad.personnel = [];
                        }
                    });
                    
                    importData = { squads: squadsData };
                    
                    // Afficher la pr√©visualisation
                    updateImportPreview(file, importData);
                    document.getElementById('import-preview').classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Erreur d\'import:', error);
                    showNotification('Erreur de Format', error.message || 'Le fichier JSON n\'est pas dans un format reconnu.');
                }
            };
            
            reader.onerror = function() {
                showNotification('Erreur de Lecture', 'Impossible de lire le fichier.');
            };
            
            reader.readAsText(file);
        }

        // Fonctions d'import
        function openImportModal() {
            importData = null;
            importFile = null;
            document.getElementById('import-preview').classList.add('hidden');
            showModal('import-modal');
        }
        
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processImportFile(files[0]);
                }
            });
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processImportFile(file);
            }
        }

        function updateImportPreview(file, data) {
            const infoContainer = document.getElementById('import-info');
            const squadsContainer = document.getElementById('import-squads');
            
            // Informations du fichier
            const fileSize = (file.size / 1024).toFixed(2);
            const squadCount = Object.keys(data.squads).length;
            
            infoContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>Fichier:</strong> ${file.name}</div>
                    <div><strong>Taille:</strong> ${fileSize} KB</div>
                    <div><strong>Escouades d√©tect√©es:</strong> ${squadCount}</div>
                    <div><strong>Format:</strong> Compatible</div>
                </div>
            `;
            
            // Liste des escouades
            squadsContainer.innerHTML = Object.keys(data.squads).map(squadName => {
                const squad = data.squads[squadName];
                const memberCount = squad.personnel ? squad.personnel.length : 0;
                const exists = squads[squadName] ? true : false;
                
                return `
                    <div class="bg-slate-800 p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <h5 class="font-bold">${squadName}</h5>
                            <p class="text-sm text-gray-400">${memberCount} membres</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded ${exists ? 'bg-yellow-600' : 'bg-green-600'}">
                            ${exists ? 'EXISTE' : 'NOUVEAU'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function executeImport() {
            if (!importData) {
                showNotification('Erreur', 'Aucune donn√©e √† importer.');
                return;
            }
            
            let importedCount = 0;
            let createdSquads = 0;
            
            Object.keys(importData.squads).forEach(squadName => {
                const squadData = importData.squads[squadName];
                
                // Cr√©er l'escouade si elle n'existe pas
                if (!squads[squadName]) {
                    // Utiliser createAdvancedSquad pour cr√©er l'escouade avec la bonne structure
                    const squadType = squadData.type === 'Logistique' || squadData.type === 'Support' ? 'support' : 'terrain';
                    squads[squadName] = createAdvancedSquad(squadName, squadType);
                    
                    // Appliquer les donn√©es du fichier
                    if (squadData.frequency) squads[squadName].frequency = squadData.frequency;
                    if (squadData.color) squads[squadName].color = squadData.color;
                    if (squadData.type) squads[squadName].type = squadData.type;
                    
                    // Vider le personnel par d√©faut pour le remplacer par celui du fichier
                    squads[squadName].personnel = [];
                    createdSquads++;
                }
                
                // Importer le personnel
                if (squadData.personnel && Array.isArray(squadData.personnel)) {
                    squadData.personnel.forEach(person => {
                        if (person.name && person.name.trim()) {
                            const member = {
                                name: person.name.toUpperCase(),
                                grade: person.grade || 'Soldat',
                                role: person.role || 'Fusilier',
                                status: person.status || 'Actif',
                                position: person.position || person.role || 'Op√©rateur',
                                team: person.team || null
                            };
                            
                            squads[squadName].personnel.push(member);
                            importedCount++;
                        }
                    });
                }
            });
            
            saveData();
            renderSquadsList();
            renderQuickSquads();
            updateStats();
            
            if (selectedSquad && squads[selectedSquad]) {
                renderSquadDetail();
            }
            
            hideModal('import-modal');
            
            const message = `${importedCount} membre(s) import√©(s)` + 
                          (createdSquads > 0 ? ` dans ${createdSquads} nouvelle(s) escouade(s)` : '');
            showNotification('Import R√©ussi', message);
        }

        // === DASHBOARD DYNAMIQUE ===
        
        // Fonction pour rendre le dashboard dynamique avec toutes les escouades
        function renderDynamicDashboard() {
            renderDashboardAllSquads();
            renderDetailedStats();
        }
        
        // Fonction pour afficher toutes les escouades dans le dashboard
        function renderDashboardAllSquads() {
            const container = document.getElementById('dashboard-all-squads');
            
            if (Object.keys(squads).length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">Aucune escouade cr√©√©e</p>';
                return;
            }
            
            // S√©parer les escouades par type
            const supportSquads = [];
            const terrainSquads = [];
            
            Object.values(squads).forEach(squad => {
                if (SUPPORT_NAMES.includes(squad.name)) {
                    supportSquads.push(squad);
                } else {
                    terrainSquads.push(squad);
                }
            });
            
            let content = '';
            
            // Afficher les escouades de support
            if (supportSquads.length > 0) {
                content += `
                    <div class="mb-4">
                        <h4 class="text-sm font-bold text-orange-400 mb-2 uppercase tracking-wider">üîß Support (${supportSquads.length})</h4>
                        <div class="space-y-2">
                `;
                
                supportSquads.forEach(squad => {
            const squadColor = getSquadColor(squad.name);
            const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
            const totalSlots = 10; // Effectif fixe de 10 membres par escouade
            const isComplete = personnelCount >= 10;
            const vacantPositions = Math.max(0, 10 - personnelCount);
            
            // Couleur et style selon le statut de compl√©tion
            const completionColor = isComplete ? '#22c55e' : '#f97316'; // Vert si complet, orange si incomplet
            const completionBadge = isComplete ? 
                `<span class="text-xs px-2 py-1 rounded bg-green-900/50 text-green-300 border border-green-500/30 font-medium">‚úÖ Complet</span>` :
                `<span class="text-xs px-2 py-1 rounded bg-orange-900/50 text-orange-300 border border-orange-500/30 font-medium">‚ö†Ô∏è ${vacantPositions} vacant${vacantPositions > 1 ? 's' : ''}</span>`;
            
            // Trouver les missions assign√©es
            const assignedMissions = Object.values(missions).filter(mission => 
                mission.assignedSquads.includes(squad.name)
            );
            
            content += `
                <div class="bg-slate-800 p-3 rounded-lg border-l-4 hover:bg-slate-700 cursor-pointer transition-colors" 
                     style="border-left-color: ${squadColor}" 
                     onclick="showTab('squads'); selectSquad('${squad.name}')">
                    <div class="flex justify-between items-center">
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-sm" style="color: ${squadColor}">${squad.name}</span>
                                <span class="text-xs px-2 py-1 rounded bg-orange-900/20 text-orange-300">
                                    ${squad.type || 'Support'}
                                </span>
                            </div>
                            <div class="flex items-center gap-3 text-xs">
                                <span style="color: ${completionColor}; font-weight: 600;">üë• ${personnelCount}/${totalSlots}</span>
                                ${completionBadge}
                                <span class="text-gray-400">üìª ${squad.frequency || SQUAD_FREQUENCIES[squad.name] || 'N/A'} MHz</span>
                                ${assignedMissions.length > 0 ? `<span class="text-orange-400">üéØ ${assignedMissions.length} mission(s)</span>` : ''}
                            </div>
                        </div>
                        <div class="text-orange-400">‚Üí</div>
                    </div>
                </div>
            `;
            });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Afficher les escouades de terrain
            if (terrainSquads.length > 0) {
                content += `
                    <div>
                        <h4 class="text-sm font-bold text-cyan-400 mb-2 uppercase tracking-wider">‚öîÔ∏è Terrain (${terrainSquads.length})</h4>
                        <div class="space-y-2">
                `;
                
                terrainSquads.sort((a, b) => a.name.localeCompare(b.name)).forEach(squad => {
                    const squadColor = getSquadColor(squad.name);
                    const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
                    const totalSlots = 10; // Effectif fixe de 10 membres par escouade
                    const isComplete = personnelCount >= 10;
                    const vacantPositions = Math.max(0, 10 - personnelCount);
                    
                    // Couleur et style selon le statut de compl√©tion
                    const completionColor = isComplete ? '#22c55e' : '#f97316'; // Vert si complet, orange si incomplet
                    const completionBadge = isComplete ? 
                        `<span class="text-xs px-2 py-1 rounded bg-green-900/50 text-green-300 border border-green-500/30 font-medium">‚úÖ Complet</span>` :
                        `<span class="text-xs px-2 py-1 rounded bg-orange-900/50 text-orange-300 border border-orange-500/30 font-medium">‚ö†Ô∏è ${vacantPositions} vacant${vacantPositions > 1 ? 's' : ''}</span>`;
                    
                    // Trouver les missions assign√©es
                    const assignedMissions = Object.values(missions).filter(mission => 
                        mission.assignedSquads.includes(squad.name)
                    );
                    
                    content += `
                        <div class="bg-slate-800 p-3 rounded-lg border-l-4 hover:bg-slate-700 cursor-pointer transition-colors" 
                             style="border-left-color: ${squadColor}" 
                             onclick="showTab('squads'); selectSquad('${squad.name}')">
                            <div class="flex justify-between items-center">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-bold text-sm" style="color: ${squadColor}">${squad.name}</span>
                                        <span class="text-xs px-2 py-1 rounded bg-cyan-900/20 text-cyan-300">
                                            ${squad.type || 'Terrain'}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-3 text-xs">
                                        <span style="color: ${completionColor}; font-weight: 600;">üë• ${personnelCount}/${totalSlots}</span>
                                        ${completionBadge}
                                        <span class="text-gray-400">üìª ${squad.frequency || SQUAD_FREQUENCIES[squad.name] || 'N/A'} MHz</span>
                                        ${assignedMissions.length > 0 ? `<span class="text-orange-400">üéØ ${assignedMissions.length} mission(s)</span>` : ''}
                                    </div>
                                </div>
                                <div class="text-cyan-400">‚Üí</div>
                            </div>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = content;
        }
        
        // Fonction pour afficher les statistiques d√©taill√©es
        function renderDetailedStats() {
            const supportCount = Object.values(squads).filter(squad => SUPPORT_NAMES.includes(squad.name)).length;
            const terrainCount = Object.values(squads).filter(squad => !SUPPORT_NAMES.includes(squad.name)).length;
            const activeMissions = Object.values(missions).filter(mission => mission.status === 'En cours' || mission.status === 'En pr√©paration').length;
            const totalPersonnel = Object.values(squads).reduce((total, squad) => {
                return total + (squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0);
            }, 0);
            
            document.getElementById('stats-support').textContent = supportCount;
            document.getElementById('stats-terrain').textContent = terrainCount;
            document.getElementById('stats-active-missions').textContent = activeMissions;
            document.getElementById('stats-total-personnel').textContent = totalPersonnel;
        }
        
        // === GESTION DES MISSIONS ===
        
        // Fonction pour ouvrir la modal de cr√©ation de mission
        function openMissionCreationModal() {
            tempMissionData = {
                difficulty: 'Normale',
                category: 'Choisir...',
                assignedSquads: []
            };
            tempObjectives = [{ text: 'Objectif principal', status: 'active', requiresReport: false }]; // Objectif par d√©faut
            
            document.getElementById('modal-mission-name').value = '';
            document.getElementById('modal-mission-sector').value = '';
            document.getElementById('modal-mission-category-btn').textContent = 'Choisir...';
            document.getElementById('modal-mission-difficulty-btn').textContent = 'Normale';
            document.getElementById('modal-mission-squads-display').textContent = 'Aucune';
            
            renderObjectivesInModal();
            showModal('mission-creation-modal');
        }
        
        // Fonction pour afficher les objectifs dans la modal
        function renderObjectivesInModal() {
            const container = document.getElementById('modal-objectives-list');
            if (!container) return;
            
            container.innerHTML = tempObjectives.map((obj, index) => `
                <div class="p-3 bg-slate-700 rounded-lg space-y-3">
                    <!-- Ligne principale avec statut, texte et suppression -->
                    <div class="flex items-center gap-2">
                        <button type="button" class="flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors toggle-objective-status-btn"
                                data-index="${index}"
                                style="${obj.status === 'completed' ? 'border-color: #10b981; background-color: #10b981; color: white;' : 'border-color: #6b7280; background-color: transparent; color: #6b7280;'}">
                            ${obj.status === 'completed' ? '‚úì' : ''}
                        </button>
                        <input type="text" class="flex-grow bg-slate-600 border border-slate-500 rounded px-3 py-2 text-white objective-input" 
                               data-index="${index}" value="${obj.text}" placeholder="D√©crivez cet objectif...">
                        <button type="button" class="flex-shrink-0 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors delete-objective-btn" 
                                data-index="${index}">
                            üóëÔ∏è
                        </button>
                    </div>
                    <!-- Case √† cocher pour demande de rapport -->
                    <div class="flex items-center gap-2 ml-8">
                        <input type="checkbox" id="report-required-${index}" class="w-4 h-4 text-blue-600 bg-slate-600 border-slate-500 rounded focus:ring-blue-500 objective-report-checkbox" 
                               data-index="${index}" ${obj.requiresReport ? 'checked' : ''}>
                        <label for="report-required-${index}" class="text-sm text-gray-300 cursor-pointer">
                            üìã Demande de rapport pour validation
                        </label>
                    </div>
                </div>
            `).join('');
            
            // Ajouter les gestionnaires d'√©v√©nements pour les cases √† cocher
            setTimeout(() => {
                const checkboxes = container.querySelectorAll('.objective-report-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        if (tempObjectives[index]) {
                            tempObjectives[index].requiresReport = this.checked;
                        }
                    });
                });
                
                // Gestionnaires pour les inputs de texte
                const inputs = container.querySelectorAll('.objective-input');
                inputs.forEach(input => {
                    input.addEventListener('input', function() {
                        const index = parseInt(this.dataset.index);
                        if (tempObjectives[index]) {
                            tempObjectives[index].text = this.value;
                        }
                    });
                });
                
                // Gestionnaires pour les boutons de suppression
                const deleteButtons = container.querySelectorAll('.delete-objective-btn');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        tempObjectives.splice(index, 1);
                        renderObjectivesInModal();
                    });
                });
            }, 100);
        }
        
        // Fonction pour sauvegarder une nouvelle mission
        function saveNewMission() {
            const name = document.getElementById('modal-mission-name').value.trim().toUpperCase();
            const sector = document.getElementById('modal-mission-sector').value.trim();

            // V√©rifier que tous les objectifs ont du texte
            const validObjectives = tempObjectives.filter(obj => obj.text && obj.text.trim());
            
            if (!name || !sector || validObjectives.length === 0 || tempMissionData.category === 'Choisir...') {
                showNotification('Erreur de Validation', 'Veuillez remplir tous les champs, ajouter au moins un objectif et choisir une cat√©gorie.');
                return;
            }

            const newMission = {
                id: `mission_${Date.now()}`,
                name,
                sector,
                category: tempMissionData.category,
                difficulty: tempMissionData.difficulty,
                objectives: validObjectives, // Utiliser les objectifs multiples
                assignedSquads: tempMissionData.assignedSquads,
                status: 'En pr√©paration',
                sitreps: [],
                evacRequests: [],
                reinforcementRequests: [], // Nouvelle fonctionnalit√©
                creationDate: new Date().toISOString()
            };

            missions[name] = newMission;
            selectedMission = name;
            saveState();
            renderMissionList();
            renderMissionDetail(name);
            hideAllModals();
            showNotification('Mission Cr√©√©e', `La mission "${name}" a √©t√© cr√©√©e avec ${validObjectives.length} objectif(s).`);
        }
        
        // Fonction pour rendre la liste des missions
        function renderMissionList() {
            const container = document.getElementById('missions-list');
            
            // V√©rification d√©fensive : s'assurer que missions est d√©fini
            if (!missions || typeof missions !== 'object') {
                console.warn('‚ö†Ô∏è Variable missions non d√©finie, initialisation...');
                missions = {};
            }
            
            if (Object.keys(missions).length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">Aucune mission cr√©√©e</p>';
                return;
            }
            
            const sortedMissions = Object.values(missions).sort((a, b) => 
                new Date(b.creationDate) - new Date(a.creationDate)
            );
            
            container.innerHTML = sortedMissions.map(mission => {
                const isSelected = selectedMission === mission.name;
                const statusColor = {
                    'En pr√©paration': 'text-yellow-400',
                    'En cours': 'text-blue-400',
                    'Termin√©e': 'text-green-400',
                    'Annul√©e': 'text-red-400'
                }[mission.status] || 'text-gray-400';
                
                return `
                    <div class="mission-card p-3 rounded-lg cursor-pointer transition-all duration-200 border-l-4 ${
                        isSelected ? 'bg-slate-700 border-l-orange-500' : 'hover:bg-slate-800 border-l-gray-600'
                    }" onclick="selectMission('${mission.name}')">
                        <div class="flex justify-between items-center">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-bold text-lg text-orange-400">${mission.name}</h4>
                                    <span class="text-xs px-2 py-1 rounded bg-orange-900/20 text-orange-300">
                                        ${mission.category}
                                    </span>
                                </div>
                                <div class="flex items-center gap-4 text-xs text-gray-400">
                                    <span>üìç ${mission.sector}</span>
                                    <span>üë• ${mission.assignedSquads ? mission.assignedSquads.length : 0} escouade(s)</span>
                                    <span class="${statusColor}">${mission.status}</span>
                                </div>
                            </div>
                            <div class="text-right flex items-center gap-2">
                                ${mission.status === 'Termin√©e' ? `
                                    <button onclick="event.stopPropagation(); showMissionCompletionReport('${mission.name}')" 
                                            class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 px-2 py-1 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200 text-xs"
                                            title="Consulter le rapport de synth√®se">
                                        üìã
                                    </button>
                                ` : ''}
                                <button onclick="event.stopPropagation(); deleteMission('${mission.name}')" 
                                        class="bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 px-2 py-1 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 text-xs"
                                        title="Supprimer cette mission">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fonction pour s√©lectionner une mission
        function selectMission(missionName) {
            selectedMission = missionName;
            renderMissionList();
            renderMissionDetail(missionName);
        }
        
        // Fonction pour supprimer une mission
        function deleteMission(missionName) {
            console.log('üöÄ deleteMission appel√©e avec:', missionName);
            console.log('üìã Missions actuelles:', Object.keys(missions));
            console.log('üéØ Mission s√©lectionn√©e:', selectedMission);
            
            if (!missions[missionName]) {
                console.error('‚ùå Mission introuvable:', missionName);
                alert('Erreur: Mission introuvable.');
                return;
            }
            
            console.log('‚úÖ Mission trouv√©e, affichage de la modal de confirmation');
            
            // Utiliser la modal de confirmation personnalis√©e
            showCustomConfirmation(
                'Supprimer Mission',
                `√ätes-vous s√ªr de vouloir supprimer la mission "${missionName}" ?\n\nCette action est irr√©versible et supprimera d√©finitivement toutes les donn√©es associ√©es (objectifs, SITREP, demandes de renfort).`,
                function() {
                    console.log('‚úÖ Confirmation accept√©e, suppression en cours...');
                    
                    delete missions[missionName];
                    console.log('üóëÔ∏è Mission supprim√©e des donn√©es');
                    
                    // Si c'√©tait la mission s√©lectionn√©e, d√©s√©lectionner
                    if (selectedMission === missionName) {
                        selectedMission = null;
                        console.log('üéØ Mission d√©s√©lectionn√©e');
                    }
                    
                    console.log('üíæ Sauvegarde en cours...');
                    saveState();
                    
                    console.log('üîÑ Mise √† jour de l\'interface...');
                    renderMissionList();
                    renderMissionDetail(null);
                    renderDashboardMissions();
                    updateStats();
                    
                    console.log('‚úÖ Suppression termin√©e avec succ√®s');
                    
                    // Notification de succ√®s avec style personnalis√©
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>‚úÖ</span>
                            <span>Mission "${missionName}" supprim√©e avec succ√®s</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Supprimer la notification apr√®s 3 secondes
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            );
        }
        
        // Fonction pour rendre le d√©tail d'une mission
        function renderMissionDetail(missionName) {
            const container = document.getElementById('mission-detail');
            
            if (!missionName || !missions[missionName]) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-12">
                        <p>S√©lectionnez une mission pour voir les d√©tails</p>
                    </div>
                `;
                return;
            }
            
            const mission = missions[missionName];
            const statusColor = {
                'En pr√©paration': 'text-yellow-400',
                'En cours': 'text-blue-400',
                'Termin√©e': 'text-green-400',
                'Annul√©e': 'text-red-400'
            }[mission.status] || 'text-gray-400';
            
            container.innerHTML = `
                <div class="mission-detail-content">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-2 text-orange-400">${mission.name}</h2>
                            <div class="flex items-center gap-4 text-sm text-gray-300">
                                <span>üìç ${mission.sector}</span>
                                <span>üë• ${mission.assignedSquads.length} escouade(s)</span>
                                <span class="px-2 py-1 rounded ${statusColor.replace('text-', 'bg-').replace('-400', '-900')} ${statusColor}">
                                    ${mission.status}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            ${mission.status === 'Termin√©e' ? `
                                <button onclick="showMissionCompletionReport('${mission.name}')" 
                                        class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 px-3 py-1 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200 text-sm flex items-center gap-1"
                                        title="Consulter le rapport de synth√®se complet">
                                    üìã Rapport de Synth√®se
                                </button>
                            ` : mission.status === 'En cours' ? `
                                <button onclick="manualCompleteMission('${mission.name}')" 
                                        class="bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 px-3 py-1 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200 text-sm flex items-center gap-1"
                                        title="Terminer manuellement cette mission">
                                    ‚úÖ Terminer Mission
                                </button>
                            ` : ''}
                            <button onclick="deleteMission('${mission.name}')" 
                                    class="bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 px-3 py-1 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 text-sm flex items-center gap-1"
                                    title="Supprimer cette mission">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                    
                    <!-- Objectifs Multiples -->
                    <div class="bg-slate-800 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-3">üéØ Objectifs (${mission.objectives.filter(obj => obj.status === 'completed').length}/${mission.objectives.length} compl√©t√©s)</h3>
                        <div class="space-y-2">
                            ${mission.objectives.map((obj, index) => {
                                let iconStyle, iconSymbol, textStyle, statusText, tooltipText;
                                
                                switch (obj.status) {
                                    case 'completed':
                                        iconStyle = 'background-color: #10b981; border-color: #10b981; color: white;';
                                        iconSymbol = '‚úì';
                                        textStyle = 'line-through text-green-400';
                                        statusText = 'VALID√â';
                                        tooltipText = 'Objectif valid√© - Cliquer pour modifier';
                                        break;
                                    case 'failed':
                                        iconStyle = 'background-color: #ef4444; border-color: #ef4444; color: white;';
                                        iconSymbol = '‚úó';
                                        textStyle = 'line-through text-red-400';
                                        statusText = '√âCHEC';
                                        tooltipText = 'Objectif √©chou√© - Cliquer pour modifier';
                                        break;
                                    default:
                                        iconStyle = 'border-color: #6b7280; color: #6b7280;';
                                        iconSymbol = '‚óã';
                                        textStyle = 'text-white';
                                        statusText = 'EN COURS';
                                        tooltipText = 'Objectif en cours - Cliquer pour modifier';
                                }
                                
                                return `
                                    <div class="flex items-center gap-3 p-3 bg-slate-700 rounded-lg hover:bg-slate-600 cursor-pointer transition-colors objective-item"
                                         data-mission="${selectedMission}" data-objective-index="${index}"
                                         title="${tooltipText}">
                                        <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                                             style="${iconStyle}">
                                            ${iconSymbol}
                                        </div>
                                        <span class="flex-grow text-sm ${textStyle}">
                                            ${obj.text}
                                        </span>
                                        <span class="text-xs ${
                                            obj.status === 'completed' ? 'text-green-400' :
                                            obj.status === 'failed' ? 'text-red-400' :
                                            'text-gray-400'
                                        }">
                                            ${statusText}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Barre de progression des objectifs -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-400 mb-1">
                                <span>Progression</span>
                                <span>${Math.round((mission.objectives.filter(obj => obj.status === 'completed').length / mission.objectives.length) * 100)}%</span>
                            </div>
                            <div class="w-full bg-slate-600 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${(mission.objectives.filter(obj => obj.status === 'completed').length / mission.objectives.length) * 100}%"></div>
                            </div>
                        </div>
                        
                        <!-- Boutons de Terminaison de Mission -->
                        ${mission.status !== 'Termin√©e' && mission.status !== 'Annul√©e' ? `
                            <div class="mt-6 pt-4 border-t border-slate-600">
                                <h4 class="text-sm font-medium text-gray-300 mb-3">üèÅ Terminer la Mission</h4>
                                <div class="flex gap-3">
                                    <button onclick="completeMission('${mission.name}', 'success')" 
                                            class="flex-1 bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 px-4 py-2 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200 text-sm font-medium flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        R√âUSSITE
                                    </button>
                                    <button onclick="completeMission('${mission.name}', 'failure')" 
                                            class="flex-1 bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 px-4 py-2 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 text-sm font-medium flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                        √âCHEC
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Escouades Assign√©es avec Trades -->
                    <div class="bg-slate-800 p-4 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-3">üë• Escouades Assign√©es</h3>
                        <div class="space-y-3">
                            ${mission.assignedSquads.map(squadName => {
                                const squad = squads[squadName];
                                const squadColor = getSquadColor(squadName);
                                
                                // Analyser les trades dans l'escouade
                                const tradeStats = {};
                                if (squad && squad.personnel) {
                                    squad.personnel.forEach(member => {
                                        if (member.role && TRADES[member.role]) {
                                            tradeStats[member.role] = (tradeStats[member.role] || 0) + 1;
                                        }
                                    });
                                }
                                
                                return `
                                    <div class="p-3 bg-slate-700 rounded-lg border-l-4" style="border-left-color: ${squadColor}">
                                        <div class="flex items-center justify-between mb-2 cursor-pointer hover:bg-slate-600/50 p-2 rounded transition-colors" 
                                             onclick="showTab('squads'); selectSquad('${squadName}')">
                                            <div class="flex items-center gap-3">
                                                <div class="w-3 h-3 rounded-full" style="background-color: ${squadColor}"></div>
                                                <span class="font-bold" style="color: ${squadColor}">${squadName}</span>
                                                ${squad ? `<span class="text-xs text-gray-400">${squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0} membres</span>` : ''}
                                            </div>
                                            <div class="text-cyan-400">‚Üí</div>
                                        </div>
                                        
                                        <!-- Affichage des Trades disponibles -->
                                        ${Object.keys(tradeStats).length > 0 ? `
                                            <div class="mt-2">
                                                <div class="text-xs text-gray-400 mb-1">Sp√©cialit√©s disponibles :</div>
                                                <div class="flex flex-wrap gap-1">
                                                    ${Object.entries(tradeStats).map(([trade, count]) => {
                                                        const tradeInfo = TRADES[trade];
                                                        if (!tradeInfo) return '';
                                                        return `
                                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs" 
                                                                  style="background-color: ${tradeInfo.color}20; color: ${tradeInfo.color}; border: 1px solid ${tradeInfo.color}40;">
                                                                ${tradeInfo.icon} ${tradeInfo.name} (${count})
                                                            </span>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Bouton Demander Renfort -->
                        <div class="mt-4 pt-4 border-t border-slate-600">
                            <button onclick="openReinforcementModal('${mission.name}')" 
                                    class="w-full px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                                <span>üöÅ</span>
                                Demander Renfort
                            </button>
                        </div>
                    </div>
                    
                    <!-- Demandes de Renfort -->
                    ${mission.reinforcementRequests && mission.reinforcementRequests.length > 0 ? `
                        <div class="bg-orange-900/20 border border-orange-500/30 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold text-orange-400 mb-3">üöÅ Demandes de Renfort</h3>
                            <div class="space-y-2">
                                ${mission.reinforcementRequests.map(req => `
                                    <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg">
                                        <div class="flex-grow">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-bold text-orange-400">${req.type}</span>
                                                <span class="text-xs px-2 py-1 rounded ${
                                                    req.status === 'En attente' ? 'bg-yellow-900/20 text-yellow-300' :
                                                    req.status === 'Approuv√©' ? 'bg-green-900/20 text-green-300' :
                                                    req.status === 'Refus√©' ? 'bg-red-900/20 text-red-300' :
                                                    'bg-gray-700 text-gray-300'
                                                }">
                                                    ${req.status}
                                                </span>
                                            </div>
                                            <div class="text-xs text-gray-400">
                                                ${req.reason} ‚Ä¢ Demand√© le ${new Date(req.timestamp).toLocaleString('fr-FR')}
                                            </div>
                                            ${req.assignedSquad ? `<div class="text-xs text-green-400 mt-1">Escouade assign√©e: ${req.assignedSquad}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Chronologie Mission et Rapports SITREP sur 2 colonnes -->
                    ${mission.status !== 'Termin√©e' && mission.status !== 'Annul√©e' && mission.assignedSquads.length > 0 ? `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Colonne 1: Chronologie Mission -->
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-purple-400 mb-3">üìÖ Chronologie Mission</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                                    <button onclick="createMissionChronologySitrep('${mission.name}', 'DEPART_BASE')" 
                                            class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 px-2 py-2 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200 text-xs font-medium">
                                        üöÅ D√âPART BASE
                                    </button>
                                    <button onclick="createMissionChronologySitrep('${mission.name}', 'SUR_OBJECTIF')" 
                                            class="bg-orange-900/20 hover:bg-orange-900/40 text-orange-400 hover:text-orange-300 px-2 py-2 rounded border border-orange-500/30 hover:border-orange-500/50 transition-all duration-200 text-xs font-medium">
                                        üéØ SUR OBJECTIF
                                    </button>
                                    <button onclick="createMissionChronologySitrep('${mission.name}', 'OBJECTIF_ATTEINT')" 
                                            class="bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 px-2 py-2 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200 text-xs font-medium">
                                        ‚úÖ OBJECTIF ATTEINT
                                    </button>
                                    <button onclick="createMissionChronologySitrep('${mission.name}', 'RETOUR_BASE')" 
                                            class="bg-cyan-900/20 hover:bg-cyan-900/40 text-cyan-400 hover:text-cyan-300 px-2 py-2 rounded border border-cyan-500/30 hover:border-cyan-500/50 transition-all duration-200 text-xs font-medium">
                                        üè† RETOUR BASE
                                    </button>
                                    <button onclick="createMissionChronologySitrep('${mission.name}', 'DEMANDE_EVACUATION')" 
                                            class="bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 px-2 py-2 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 text-xs font-medium col-span-2">
                                        üöë DEMANDE √âVACUATION
                                    </button>
                                </div>
                                
                                <!-- Timeline des √©v√©nements chronologiques -->
                                ${mission.chronologyEvents && mission.chronologyEvents.length > 0 ? `
                                    <div class="mt-4">
                                        <h4 class="text-sm font-medium text-gray-300 mb-3">üï∞Ô∏è Timeline Mission</h4>
                                        <div class="space-y-2 max-h-32 overflow-y-auto">
                                            ${mission.chronologyEvents.map(event => {
                                                const eventColors = {
                                                    'DEPART_BASE': 'border-blue-500/50 bg-blue-900/10 text-blue-300',
                                                    'SUR_OBJECTIF': 'border-orange-500/50 bg-orange-900/10 text-orange-300',
                                                    'OBJECTIF_ATTEINT': 'border-green-500/50 bg-green-900/10 text-green-300',
                                                    'RETOUR_BASE': 'border-cyan-500/50 bg-cyan-900/10 text-cyan-300',
                                                    'DEMANDE_EVACUATION': 'border-red-500/50 bg-red-900/10 text-red-300'
                                                };
                                                const eventColor = eventColors[event.type] || 'border-gray-500/50 bg-gray-900/10 text-gray-300';
                                                const eventTime = new Date(event.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                                
                                                return `
                                                    <div class="flex items-center gap-2 p-2 rounded border-l-4 ${eventColor}">
                                                        <span class="text-xs font-mono">${eventTime}</span>
                                                        <span class="text-xs font-medium">${event.squadName || 'CMD'}</span>
                                                        <span class="text-xs flex-grow">${event.message}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Colonne 2: Rapports SITREP -->
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-cyan-400 mb-3">üì∞ Rapports SITREP</h3>
                                
                                <!-- Rapports de l'Escouade -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">üë• Rapports Escouade</h4>
                                    <div class="grid grid-cols-2 gap-1">
                                        <button onclick="createQuickSitrep('${mission.name}', 'CONTACT_ENNEMI')" 
                                                class="bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 px-1 py-1 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 text-xs font-medium">
                                            ‚ö†Ô∏è CONTACT ENNEMI
                                        </button>
                                        <button onclick="createQuickSitrep('${mission.name}', 'DEMANDE_SOUTIEN')" 
                                                class="bg-orange-900/20 hover:bg-orange-900/40 text-orange-400 hover:text-orange-300 px-1 py-1 rounded border border-orange-500/30 hover:border-orange-500/50 transition-all duration-200 text-xs font-medium">
                                            üî• DEMANDE SOUTIEN
                                        </button>
                                        <button onclick="createQuickSitrep('${mission.name}', 'PROGRESSION')" 
                                                class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 px-1 py-1 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200 text-xs font-medium">
                                            üìä PROGRESSION
                                        </button>
                                        <button onclick="createQuickSitrep('${mission.name}', 'MUNITIONS_BASSES')" 
                                                class="bg-yellow-900/20 hover:bg-yellow-900/40 text-yellow-400 hover:text-yellow-300 px-1 py-1 rounded border border-yellow-500/30 hover:border-yellow-500/50 transition-all duration-200 text-xs font-medium">
                                            üî´ MUNITIONS BASSES
                                        </button>
                                        <button onclick="createQuickSitrep('${mission.name}', 'DEMANDE_RAVIT')" 
                                                class="bg-purple-900/20 hover:bg-purple-900/40 text-purple-400 hover:text-purple-300 px-1 py-1 rounded border border-purple-500/30 hover:border-purple-500/50 transition-all duration-200 text-xs font-medium">
                                            üçΩÔ∏è DEMANDE RAVIT.
                                        </button>
                                        <button onclick="createQuickSitrep('${mission.name}', 'RETOUR_AU_CALME')" 
                                                class="bg-gray-900/20 hover:bg-gray-900/40 text-gray-400 hover:text-gray-300 px-1 py-1 rounded border border-gray-500/30 hover:border-gray-500/50 transition-all duration-200 text-xs font-medium">
                                            üîá RETOUR AU CALME
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Demandes du Commandement -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">üé§ Demandes Commandement</h4>
                                    <div class="grid grid-cols-1 gap-1">
                                        <button onclick="createDirectCommandSitrep('${mission.name}', 'DEMANDER_POSITION')" 
                                                class="bg-indigo-900/20 hover:bg-indigo-900/40 text-indigo-400 hover:text-indigo-300 px-2 py-1 rounded border border-indigo-500/30 hover:border-indigo-500/50 transition-all duration-200 text-xs font-medium">
                                            üìç DEMANDER POSITION
                                        </button>
                                        <button onclick="createDirectCommandSitrep('${mission.name}', 'DEMANDER_STATUT')" 
                                                class="bg-teal-900/20 hover:bg-teal-900/40 text-teal-400 hover:text-teal-300 px-2 py-1 rounded border border-teal-500/30 hover:border-teal-500/50 transition-all duration-200 text-xs font-medium">
                                            üìä DEMANDER STATUT
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Actions G√©n√©rales -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">‚è∏Ô∏è Actions</h4>
                                    <div class="grid grid-cols-1 gap-1">
                                        <button onclick="createQuickSitrep('${mission.name}', 'STAND_BY')" 
                                                class="bg-yellow-900/20 hover:bg-yellow-900/40 text-yellow-400 hover:text-yellow-300 px-2 py-1 rounded border border-yellow-500/30 hover:border-yellow-500/50 transition-all duration-200 text-xs font-medium">
                                            ‚è∏Ô∏è STAND BY
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Bouton SITREP Personnalis√© -->
                                <div class="flex justify-center">
                                    <button onclick="openSitrepModal('${mission.name}')" 
                                            class="bg-cyan-900/20 hover:bg-cyan-900/40 text-cyan-400 hover:text-cyan-300 px-3 py-2 rounded border border-cyan-500/30 hover:border-cyan-500/50 transition-all duration-200 text-sm font-medium flex items-center gap-2">
                                        üìù SITREP PERSONNALIS√â
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Historique SITREP sur toute la largeur -->
                        <div class="bg-slate-800 p-4 rounded-lg mb-6">
                            <h3 class="text-lg font-semibold text-green-400 mb-3">üìã Historique SITREP Complet</h3>
                            ${(mission.sitreps && mission.sitreps.length > 0) || (mission.chronologyEvents && mission.chronologyEvents.length > 0) ? `
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${(() => {
                                        // Combiner chronologie et SITREP dans un seul historique
                                        const allEvents = [];
                                        
                                        // Ajouter les √©v√©nements de chronologie
                                        if (mission.chronologyEvents) {
                                            mission.chronologyEvents.forEach(event => {
                                                allEvents.push({
                                                    timestamp: event.timestamp,
                                                    type: 'chronology',
                                                    subtype: event.type,
                                                    message: event.message,
                                                    squadName: event.squadName
                                                });
                                            });
                                        }
                                        
                                        // Ajouter les SITREP classiques
                                        if (mission.sitreps) {
                                            mission.sitreps.forEach(sitrep => {
                                                allEvents.push({
                                                    timestamp: sitrep.timestamp,
                                                    type: 'sitrep',
                                                    subtype: sitrep.type || 'custom',
                                                    message: sitrep.message,
                                                    squadName: sitrep.squadName,
                                                    priority: sitrep.priority
                                                });
                                            });
                                        }
                                        
                                        // Trier par timestamp (plus r√©cent en premier)
                                        allEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                                        
                                        return allEvents.slice(0, 20).map(event => {
                                            const eventTime = new Date(event.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                            const eventDate = new Date(event.timestamp).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
                                            
                                            let colorClass = 'border-gray-500/50 bg-gray-900/10 text-gray-300';
                                            let typeIcon = 'üìù';
                                            
                                            if (event.type === 'chronology') {
                                                const chronoColors = {
                                                    'DEPART_BASE': { color: 'border-blue-500/50 bg-blue-900/10 text-blue-300', icon: 'üöÅ' },
                                                    'SUR_OBJECTIF': { color: 'border-orange-500/50 bg-orange-900/10 text-orange-300', icon: 'üéØ' },
                                                    'OBJECTIF_ATTEINT': { color: 'border-green-500/50 bg-green-900/10 text-green-300', icon: '‚úÖ' },
                                                    'RETOUR_BASE': { color: 'border-cyan-500/50 bg-cyan-900/10 text-cyan-300', icon: 'üè†' },
                                                    'DEMANDE_EVACUATION': { color: 'border-red-500/50 bg-red-900/10 text-red-300', icon: 'üöë' }
                                                };
                                                const config = chronoColors[event.subtype] || { color: colorClass, icon: 'üìÖ' };
                                                colorClass = config.color;
                                                typeIcon = config.icon;
                                            } else {
                                                const sitrepColors = {
                                                    'CONTACT_ENNEMI': { color: 'border-red-500/50 bg-red-900/10 text-red-300', icon: '‚ö†Ô∏è' },
                                                    'DEMANDE_SOUTIEN': { color: 'border-orange-500/50 bg-orange-900/10 text-orange-300', icon: 'üî•' },
                                                    'PROGRESSION': { color: 'border-blue-500/50 bg-blue-900/10 text-blue-300', icon: 'üìä' },
                                                    'MUNITIONS_BASSES': { color: 'border-yellow-500/50 bg-yellow-900/10 text-yellow-300', icon: 'üî´' },
                                                    'DEMANDE_RAVIT': { color: 'border-purple-500/50 bg-purple-900/10 text-purple-300', icon: 'üçΩÔ∏è' },
                                                    'RETOUR_AU_CALME': { color: 'border-gray-500/50 bg-gray-900/10 text-gray-300', icon: 'üîá' },
                                                    'DEMANDER_POSITION': { color: 'border-indigo-500/50 bg-indigo-900/10 text-indigo-300', icon: 'üìç' },
                                                    'DEMANDER_STATUT': { color: 'border-teal-500/50 bg-teal-900/10 text-teal-300', icon: 'üìä' },
                                                    'ORDRE_ENGAGEMENT': { color: 'border-pink-500/50 bg-pink-900/10 text-pink-300', icon: '‚öîÔ∏è' }
                                                };
                                                const config = sitrepColors[event.subtype] || { color: colorClass, icon: 'üìù' };
                                                colorClass = config.color;
                                                typeIcon = config.icon;
                                            }
                                            
                                            // G√©n√©rer les boutons de r√©ponse pour les demandes de commandement
                                            let responseButtons = '';
                                            
                                            // Pour les demandes de position (originales ou stand-by)
                                            if (event.subtype === 'DEMANDER_POSITION') {
                                                const targetSquad = event.targetSquad || (mission.assignedSquads && mission.assignedSquads.length === 1 ? mission.assignedSquads[0] : 'ALPHA');
                                                responseButtons = `
                                                    <div class="flex gap-2 mt-2">
                                                        <button onclick="openPositionResponseModal('${event.id}', '${missionName}', '${targetSquad}')" 
                                                                class="px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded transition-colors">
                                                            üìç R√©ponse
                                                        </button>
                                                        <button onclick="addStandByEntry('${missionName}', '${targetSquad}', 'squad', 'DEMANDER_POSITION')" 
                                                                class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition-colors">
                                                            ‚è≥ Stand By
                                                        </button>
                                                    </div>
                                                `;
                                            }
                                            // Pour les demandes de statut (originales ou stand-by)
                                            else if (event.subtype === 'DEMANDER_STATUT') {
                                                const targetSquad = event.targetSquad || (mission.assignedSquads && mission.assignedSquads.length === 1 ? mission.assignedSquads[0] : 'ALPHA');
                                                responseButtons = `
                                                    <div class="flex gap-2 mt-2">
                                                        <button onclick="openStatusResponseModal('${event.id}', '${missionName}', '${targetSquad}')" 
                                                                class="px-2 py-1 bg-teal-600 hover:bg-teal-700 text-white text-xs rounded transition-colors">
                                                            üìä R√©ponse
                                                        </button>
                                                        <button onclick="addStandByEntry('${missionName}', '${targetSquad}', 'squad', 'DEMANDER_STATUT')" 
                                                                class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition-colors">
                                                            ‚è≥ Stand By
                                                        </button>
                                                    </div>
                                                `;
                                            }
                                            // Pour les contacts ennemis
                                            else if (event.subtype === 'CONTACT_ENNEMI') {
                                                const reportingSquad = event.squadName && event.squadName !== 'null' ? event.squadName : (mission.assignedSquads && mission.assignedSquads.length === 1 ? mission.assignedSquads[0] : 'ALPHA');
                                                responseButtons = `
                                                    <div class="flex gap-2 mt-2">
                                                        <button onclick="openEngagementOrderModal('${event.id}', '${missionName}', '${reportingSquad}')" 
                                                                class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                                                            ‚öîÔ∏è Ordre d'Engagement
                                                        </button>
                                                        <button onclick="addStandByEntry('${missionName}', '${reportingSquad}', 'command', 'CONTACT_ENNEMI')" 
                                                                class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition-colors">
                                                            ‚è≥ Stand By
                                                        </button>
                                                    </div>
                                                `;
                                            }
                                            // Pour les entr√©es Stand By qui conservent les boutons de r√©ponse
                                            else if (event.isStandBy && event.keepResponseButtons) {
                                                const targetSquad = event.squadName && event.squadName !== 'null' ? event.squadName : (mission.assignedSquads && mission.assignedSquads.length === 1 ? mission.assignedSquads[0] : 'ALPHA');
                                                if (event.subtype === 'DEMANDER_POSITION') {
                                                    responseButtons = `
                                                        <div class="flex gap-2 mt-2">
                                                            <button onclick="openPositionResponseModal('${event.id}', '${missionName}', '${targetSquad}')" 
                                                                    class="px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded transition-colors">
                                                                üìç R√©ponse
                                                            </button>
                                                            <span class="px-2 py-1 bg-gray-600 text-white text-xs rounded opacity-50">
                                                                ‚è≥ En attente...
                                                            </span>
                                                        </div>
                                                    `;
                                                } else if (event.subtype === 'DEMANDER_STATUT') {
                                                    responseButtons = `
                                                        <div class="flex gap-2 mt-2">
                                                            <button onclick="openStatusResponseModal('${event.id}', '${missionName}', '${targetSquad}')" 
                                                                    class="px-2 py-1 bg-teal-600 hover:bg-teal-700 text-white text-xs rounded transition-colors">
                                                                üìä R√©ponse
                                                            </button>
                                                            <span class="px-2 py-1 bg-gray-600 text-white text-xs rounded opacity-50">
                                                                ‚è≥ En attente...
                                                            </span>
                                                        </div>
                                                    `;
                                                }
                                            }
                                            
                                            // Ajouter bouton "Voir rapport" pour les objectifs avec rapport
                                            if (event.hasReport && event.type === 'objective_completed') {
                                                responseButtons = `
                                                    <div class="flex gap-2 mt-2">
                                                        <button data-action="view-report" data-mission="${missionName}" data-objective-index="${event.objectiveIndex}" 
                                                                class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors">
                                                            üìã Voir rapport
                                                        </button>
                                                    </div>
                                                `;
                                            }
                                            
                                            return `
                                                <div class="flex items-start gap-3 p-3 rounded border-l-4 ${colorClass}">
                                                    <div class="flex flex-col items-center text-xs">
                                                        <span class="font-mono">${eventTime}</span>
                                                        <span class="font-mono text-gray-500">${eventDate}</span>
                                                    </div>
                                                    <span class="text-lg">${typeIcon}</span>
                                                    <div class="flex-grow">
                                                        <div class="flex items-center gap-2 mb-1">
                                                             <span class="text-sm font-medium">${event.squadName && event.squadName !== 'null' ? event.squadName : 'Commandement'}</span>
                                                            <span class="text-xs px-2 py-1 rounded ${event.type === 'chronology' ? 'bg-purple-900/20 text-purple-300' : 'bg-cyan-900/20 text-cyan-300'}">
                                                                ${event.type === 'chronology' ? 'CHRONOLOGIE' : 'SITREP'}
                                                            </span>
                                                            ${event.priority ? `<span class="text-xs px-2 py-1 rounded ${
                                                                event.priority === 'Critique' ? 'bg-red-900/20 text-red-300' :
                                                                event.priority === 'Haute' ? 'bg-orange-900/20 text-orange-300' :
                                                                event.priority === 'Normale' ? 'bg-blue-900/20 text-blue-300' :
                                                                'bg-gray-900/20 text-gray-300'
                                                            }">${event.priority}</span>` : ''}
                                                        </div>
                                                        <span class="text-sm">${event.message}</span>
                                                        ${responseButtons}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('');
                                    })()
                                    }
                                </div>
                            ` : `
                                <div class="text-center text-gray-400 py-8">
                                    <span class="text-4xl mb-2 block">üì≠</span>
                                    <p>Aucun rapport SITREP ou √©v√©nement chronologique enregistr√©</p>
                                    <p class="text-sm mt-1">Utilisez les boutons ci-dessus pour cr√©er des rapports</p>
                                </div>
                            `}
                        </div>
                    ` : ''}
                    

                </div>
            `;
        }
        
        // Fonction pour terminer une mission manuellement
        function completeMission(missionName, outcome) {
            if (!missions[missionName]) {
                console.error('Mission introuvable:', missionName);
                return;
            }
            
            const outcomeText = outcome === 'success' ? 'R√âUSSIE' : '√âCHOU√âE';
            
            // Utiliser la modal de confirmation personnalis√©e
            showCustomConfirmation(
                'Terminer Mission',
                `√ätes-vous s√ªr de vouloir marquer la mission "${missionName}" comme ${outcomeText} ?`,
                () => {
                    // Confirmer la terminaison
                    missions[missionName].status = 'Termin√©e';
                    missions[missionName].outcome = outcome;
                    missions[missionName].completionDate = new Date().toISOString();
                    
                    // Ajouter un SITREP de fin de mission
                    if (!missions[missionName].sitreps) {
                        missions[missionName].sitreps = [];
                    }
                    missions[missionName].sitreps.push({
                        id: `sitrep_${Date.now()}`,
                        message: `Mission ${outcomeText} - Termin√©e manuellement par le commandement`,
                        timestamp: new Date().toISOString(),
                        type: 'mission_completion'
                    });
                    
                    // Sauvegarder et mettre √† jour l'interface
                    saveState();
                    renderMissionList();
                    renderMissionDetail(missionName);
                    renderDashboardMissions();
                    updateStats();
                    
                    // Notification de succ√®s
                    showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© marqu√©e comme ${outcomeText.toLowerCase()}.`);
                }
            );
        }
        
        // Fonction pour supprimer une mission
        function deleteMission(missionName) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la mission "${missionName}" ?`)) {
                delete missions[missionName];
                if (selectedMission === missionName) {
                    selectedMission = null;
                    renderMissionDetail(null);
                }
                saveState();
                renderMissionList();
                updateStats();
                showNotification('Mission Supprim√©e', `La mission "${missionName}" a √©t√© supprim√©e avec succ√®s.`);
            }
        }
        
        // === FONCTIONS DE GESTION DES DROPDOWNS ET S√âLECTIONS ===
        
        // Fonction pour basculer l'affichage d'un dropdown
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }
        

        
        // === FONCTIONS DE GESTION DES OBJECTIFS ===
        
        // Fonction pour d√©finir le statut d'un objectif
        function setObjectiveStatus(newStatus) {
            if (!window.currentObjectiveData) return;
            
            const { missionName, objectiveIndex } = window.currentObjectiveData;
            const objective = missions[missionName].objectives[objectiveIndex];
            
            if (!objective) return;
            
            const oldStatus = objective.status;
            objective.status = newStatus;
            
            // Cr√©er le message SITREP appropri√©
            let sitrepMessage;
            let notificationMessage;
            
            switch (newStatus) {
                case 'completed':
                    sitrepMessage = `Objectif VALID√â: ${objective.text}`;
                    notificationMessage = 'Objectif valid√© avec succ√®s.';
                    break;
                case 'failed':
                    sitrepMessage = `Objectif √âCHOU√â: ${objective.text}`;
                    notificationMessage = 'Objectif marqu√© comme √©chou√©.';
                    break;
                default:
                    sitrepMessage = `Objectif R√âACTIV√â: ${objective.text}`;
                    notificationMessage = 'Objectif r√©activ√©.';
                    break;
            }
            
            // Ajouter un SITREP automatique
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push({
                id: `sitrep_${Date.now()}`,
                message: sitrepMessage,
                timestamp: new Date().toISOString(),
                type: 'objective'
            });
            
            // V√©rifier si la mission est compl√©t√©e √† 100%
            checkMissionCompletion(missionName);
            
            // Nettoyer les donn√©es temporaires
            delete window.currentObjectiveData;
            
            saveState();
            renderMissionDetail(missionName);
            hideModal('objective-status-modal');
            showNotification('Objectif mis √† jour', notificationMessage);
        }
        
        // Fonction pour v√©rifier la compl√©tion automatique d'une mission
        function checkMissionCompletion(missionName) {
            const mission = missions[missionName];
            if (!mission || !mission.objectives || mission.status === 'Termin√©e') {
                return;
            }
            
            // Compter les objectifs r√©alis√©s (valid√©s OU en √©chec = 100% r√©alis√©)
            const totalObjectives = mission.objectives.length;
            const completedObjectives = mission.objectives.filter(obj => 
                obj.status === 'completed' || obj.status === 'failed'
            ).length;
            
            // Si tous les objectifs sont r√©alis√©s (100%)
            if (completedObjectives === totalObjectives && totalObjectives > 0) {
                // D√©terminer le r√©sultat global de la mission
                const successfulObjectives = mission.objectives.filter(obj => obj.status === 'completed').length;
                const failedObjectives = mission.objectives.filter(obj => obj.status === 'failed').length;
                
                // Proposer automatiquement la terminaison de la mission
                setTimeout(() => {
                    showMissionCompletionModal(missionName, successfulObjectives, failedObjectives, totalObjectives);
                }, 500); // Petit d√©lai pour que l'interface se mette √† jour
            }
        }
        
        // Fonction pour afficher la modal de compl√©tion automatique de mission
        function showMissionCompletionModal(missionName, successCount, failCount, totalCount) {
            const modal = document.getElementById('mission-completion-modal');
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="mission-completion-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-lg mx-4 border border-orange-500/50">
                            <h3 class="text-xl font-bold text-orange-400 mb-4">üéØ Mission Compl√©t√©e √† 100%</h3>
                            
                            <div class="mb-6">
                                <p class="text-gray-300 mb-3">La mission <span id="completion-mission-name" class="font-bold text-orange-400"></span> a atteint 100% de progression :</p>
                                
                                <div class="bg-slate-700 p-4 rounded-lg mb-4">
                                    <div class="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <div class="text-2xl font-bold text-green-400" id="completion-success-count"></div>
                                            <div class="text-xs text-gray-400">Valid√©s</div>
                                        </div>
                                        <div>
                                            <div class="text-2xl font-bold text-red-400" id="completion-fail-count"></div>
                                            <div class="text-xs text-gray-400">√âchou√©s</div>
                                        </div>
                                        <div>
                                            <div class="text-2xl font-bold text-orange-400" id="completion-total-count"></div>
                                            <div class="text-xs text-gray-400">Total</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="text-gray-300 text-sm mb-4">Voulez-vous terminer cette mission maintenant ?</p>
                            </div>
                            
                            <div class="space-y-3">
                                <button onclick="completeMissionFromModal('success')" 
                                        class="w-full p-3 bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200 font-medium">
                                    ‚úÖ Terminer comme R√âUSSIE
                                </button>
                                
                                <button onclick="completeMissionFromModal('failure')" 
                                        class="w-full p-3 bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200 font-medium">
                                    ‚ùå Terminer comme √âCHOU√âE
                                </button>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button onclick="hideModal('mission-completion-modal')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                                    Continuer la Mission
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir les informations de la mission
            document.getElementById('completion-mission-name').textContent = missionName;
            document.getElementById('completion-success-count').textContent = successCount;
            document.getElementById('completion-fail-count').textContent = failCount;
            document.getElementById('completion-total-count').textContent = totalCount;
            
            // Stocker le nom de la mission pour les fonctions de terminaison
            window.currentCompletionMission = missionName;
            
            showModal('mission-completion-modal');
        }
        
        // Fonction pour terminer une mission depuis la modal de compl√©tion automatique
        function completeMissionFromModal(outcome) {
            const missionName = window.currentCompletionMission;
            if (!missionName) return;
            
            hideModal('mission-completion-modal');
            
            // Utiliser la fonction existante de terminaison
            const outcomeText = outcome === 'success' ? 'R√âUSSIE' : '√âCHOU√âE';
            
            missions[missionName].status = 'Termin√©e';
            missions[missionName].outcome = outcome;
            missions[missionName].completionDate = new Date().toISOString();
            
            // Ajouter un SITREP de fin de mission
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push({
                id: `sitrep_${Date.now()}`,
                message: `Mission ${outcomeText} - Tous les objectifs r√©alis√©s`,
                timestamp: new Date().toISOString(),
                type: 'mission_completion'
            });
            
            saveState();
            renderMissionList();
            renderMissionDetail(missionName);
            renderDashboardMissions();
            updateStats();
            
            showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© automatiquement marqu√©e comme ${outcomeText.toLowerCase()}.`);
            
            // Nettoyer la variable temporaire
            delete window.currentCompletionMission;
        }
        
        // Fonction pour ouvrir la modal de statut d'objectif
        function openObjectiveStatusModal(missionName, objectiveIndex) {
            if (!missions[missionName] || !missions[missionName].objectives[objectiveIndex]) {
                return;
            }
            
            const objective = missions[missionName].objectives[objectiveIndex];
            const modal = document.getElementById('objective-status-modal');
            
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="objective-status-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">üéØ Statut de l'Objectif</h3>
                            
                            <div class="mb-4">
                                <p class="text-gray-300 mb-2">Objectif:</p>
                                <p id="objective-text" class="font-medium text-white bg-slate-700 p-3 rounded"></p>
                            </div>
                            
                            <div class="mb-6">
                                <p class="text-gray-300 mb-2">Statut actuel:</p>
                                <span id="current-objective-status" class="px-3 py-1 rounded text-sm font-medium"></span>
                            </div>
                            
                            <div class="space-y-3">
                                <button onclick="setObjectiveStatus('completed')" 
                                        class="w-full p-3 bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200">
                                    ‚úÖ Marquer comme VALID√â
                                </button>
                                
                                <button onclick="setObjectiveStatus('failed')" 
                                        class="w-full p-3 bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 rounded border border-red-500/30 hover:border-red-500/50 transition-all duration-200">
                                    ‚ùå Marquer comme √âCHOU√â
                                </button>
                                
                                <button onclick="setObjectiveStatus('active')" 
                                        class="w-full p-3 bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 rounded border border-blue-500/30 hover:border-blue-500/50 transition-all duration-200">
                                    üîÑ R√©activer (En cours)
                                </button>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button onclick="hideModal('objective-status-modal')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir les informations de l'objectif
            document.getElementById('objective-text').textContent = objective.text;
            
            const currentStatusElement = document.getElementById('current-objective-status');
            const statusText = objective.status === 'completed' ? 'VALID√â' :
                              objective.status === 'failed' ? '√âCHOU√â' :
                              'EN COURS';
            const statusClass = objective.status === 'completed' ? 'bg-green-900/20 text-green-300' :
                               objective.status === 'failed' ? 'bg-red-900/20 text-red-300' :
                               'bg-blue-900/20 text-blue-300';
            
            currentStatusElement.textContent = statusText;
            currentStatusElement.className = `px-3 py-1 rounded text-sm font-medium ${statusClass}`;
            
            // Stocker les informations pour la fonction de mise √† jour
            window.currentObjectiveData = {
                missionName,
                objectiveIndex
            };
            
            showModal('objective-status-modal');
        }
        
        // Fonction pour terminer une mission (fonction existante am√©lior√©e)
        function completeMission(missionName, outcome) {
            const outcomeText = outcome === 'success' ? 'R√âUSSIE' : '√âCHOU√âE';
            showConfirmation(
                'Terminer Mission',
                `Marquer la mission "${missionName}" comme ${outcomeText} ?`,
                () => {
                    missions[missionName].status = 'Termin√©e';
                    missions[missionName].outcome = outcome;
                    missions[missionName].completionDate = new Date().toISOString();
                    saveState();
                    renderMissionList();
                    renderMissionDetail(missionName);
                    showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© marqu√©e comme ${outcomeText.toLowerCase()}.`);
                }
            );
        }
        
        // Fonction pour ouvrir la modal de s√©lection d'escouades
        function openSquadSelectionModal() {
            const container = document.getElementById('squad-selection-list');
            const availableSquads = Object.keys(squads);
            
            if (availableSquads.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">Aucune escouade disponible</p>';
                showModal('squad-selection-modal');
                return;
            }
            
            container.innerHTML = availableSquads.map(squadName => {
                const squad = squads[squadName];
                const squadColor = getSquadColor(squadName);
                const isSelected = tempMissionData.assignedSquads.includes(squadName);
                
                return `
                    <div class="squad-selection-item p-3 rounded-lg cursor-pointer transition-all duration-200 border-l-4 ${
                        isSelected ? 'bg-slate-700 border-l-orange-500' : 'hover:bg-slate-800 border-l-gray-600'
                    }" 
                         style="border-left-color: ${squadColor}" 
                         onclick="toggleSquadSelection('${squadName}')">
                        <div class="flex items-center gap-3">
                            <div class="w-5 h-5 rounded border-2 flex items-center justify-center ${
                                isSelected ? 'bg-orange-500 border-orange-500' : 'border-gray-400'
                            }">
                                ${isSelected ? '<span class="text-white text-xs">‚úì</span>' : ''}
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold" style="color: ${squadColor}">${squadName}</span>
                                    <span class="text-xs px-2 py-1 rounded" style="background-color: ${squadColor}20; color: ${squadColor}">
                                        ${squad.type}
                                    </span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    ${squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0} membres
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal('squad-selection-modal');
        }
        
        // Fonction pour basculer la s√©lection d'une escouade
        function toggleSquadSelection(squadName) {
            const index = tempMissionData.assignedSquads.indexOf(squadName);
            if (index > -1) {
                tempMissionData.assignedSquads.splice(index, 1);
            } else {
                tempMissionData.assignedSquads.push(squadName);
            }
            
            // Mettre √† jour l'affichage
            openSquadSelectionModal();
            updateSquadSelectionDisplay();
        }
        
        // Fonction pour mettre √† jour l'affichage des escouades s√©lectionn√©es
        function updateSquadSelectionDisplay() {
            const display = document.getElementById('modal-mission-squads-display');
            if (display) {
                display.textContent = tempMissionData.assignedSquads.length > 0 
                    ? tempMissionData.assignedSquads.join(', ') 
                    : 'Aucune';
            }
        }
        
        // Fonction pour confirmer la s√©lection d'escouades
        function confirmSquadSelection() {
            updateSquadSelectionDisplay();
            hideModal('squad-selection-modal');
        }
        
        // Fonction pour s√©lectionner une cat√©gorie de mission
        function selectCategory(category) {
            tempMissionData.category = category;
            document.getElementById('modal-mission-category-btn').textContent = category;
            toggleDropdown('category-dropdown');
        }
        
        // Fonction pour s√©lectionner une difficult√©
        function selectDifficulty(difficulty) {
            tempMissionData.difficulty = difficulty;
            document.getElementById('modal-mission-difficulty-btn').textContent = difficulty;
            toggleDropdown('difficulty-dropdown');
        }
        
        // Fonction pour afficher une bo√Æte de confirmation
        function showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const titleElement = document.getElementById('confirmation-title');
            const messageElement = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            
            if (modal && titleElement && messageElement && confirmBtn) {
                titleElement.textContent = title;
                messageElement.textContent = message;
                
                // Supprimer les anciens √©v√©nements
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // Ajouter le nouvel √©v√©nement
                newConfirmBtn.addEventListener('click', () => {
                    onConfirm();
                    hideModal('confirmation-modal');
                });
                
                showModal('confirmation-modal');
            }
        }
        
        // Fonction pour ouvrir la modal de demande de renfort
        function openReinforcementModal(missionName) {
            const modal = document.getElementById('reinforcement-modal');
            if (!modal) {
                // Cr√©er la modal dynamiquement si elle n'existe pas
                const modalHTML = `
                    <div id="reinforcement-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-xl font-bold text-orange-400 mb-4">üöÅ Demander Renfort</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Type de renfort</label>
                                    <select id="reinforcement-type" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                        <option value="Personnel">Personnel suppl√©mentaire</option>
                                        <option value="Sp√©cialiste">Sp√©cialiste (M√©decin, AT, etc.)</option>
                                        <option value="Mat√©riel">Mat√©riel / √âquipement</option>
                                        <option value="Transport">Transport / √âvacuation</option>
                                        <option value="Soutien">Soutien feu / A√©rien</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Raison de la demande</label>
                                    <textarea id="reinforcement-reason" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white" 
                                              rows="3" placeholder="D√©crivez pourquoi vous avez besoin de renfort..."></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Priorit√©</label>
                                    <select id="reinforcement-priority" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                        <option value="Faible">Faible</option>
                                        <option value="Normale" selected>Normale</option>
                                        <option value="Haute">Haute</option>
                                        <option value="Critique">Critique</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 mt-6">
                                <button onclick="hideModal('reinforcement-modal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                    Annuler
                                </button>
                                <button onclick="submitReinforcementRequest('${missionName}')" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                                    Demander
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // R√©initialiser les champs
            document.getElementById('reinforcement-type').value = 'Personnel';
            document.getElementById('reinforcement-reason').value = '';
            document.getElementById('reinforcement-priority').value = 'Normale';
            
            showModal('reinforcement-modal');
        }
        
        // Fonction pour soumettre une demande de renfort
        function submitReinforcementRequest(missionName) {
            const type = document.getElementById('reinforcement-type').value;
            const reason = document.getElementById('reinforcement-reason').value.trim();
            const priority = document.getElementById('reinforcement-priority').value;
            
            if (!reason) {
                showNotification('Erreur', 'Veuillez d√©crire la raison de votre demande de renfort.');
                return;
            }
            
            const reinforcementRequest = {
                id: `reinf_${Date.now()}`,
                type,
                reason,
                priority,
                status: 'En attente',
                timestamp: new Date().toISOString(),
                assignedSquad: null
            };
            
            // Ajouter la demande √† la mission
            if (!missions[missionName].reinforcementRequests) {
                missions[missionName].reinforcementRequests = [];
            }
            missions[missionName].reinforcementRequests.push(reinforcementRequest);
            
            // Ajouter un SITREP automatique
            const sitrepMessage = `Demande de renfort ${type.toLowerCase()} - Priorit√©: ${priority} - ${reason}`;
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push({
                id: `sitrep_${Date.now()}`,
                message: sitrepMessage,
                timestamp: new Date().toISOString(),
                type: 'reinforcement'
            });
            
            saveState();
            renderMissionDetail(missionName);
            hideModal('reinforcement-modal');
            showNotification('Demande Envoy√©e', `Demande de renfort ${type.toLowerCase()} envoy√©e avec priorit√© ${priority.toLowerCase()}.`);
        }
        
        // Fonction pour ouvrir la modal de statut d'objectif
        function openObjectiveStatusModal(missionName, objectiveIndex) {
            if (!missions[missionName] || !missions[missionName].objectives[objectiveIndex]) {
                return;
            }
            
            const objective = missions[missionName].objectives[objectiveIndex];
            const modal = document.getElementById('objective-status-modal');
            
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="objective-status-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">üéØ Statut de l'Objectif</h3>
                            
                            <div class="mb-6">
                                <div class="bg-slate-700 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">Objectif :</h4>
                                    <p id="objective-text" class="text-white"></p>
                                </div>
                                
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">Statut actuel :</h4>
                                    <span id="current-status" class="px-3 py-1 rounded text-sm font-medium"></span>
                                </div>
                                
                                <div>
                                    <h4 class="text-sm font-medium text-gray-300 mb-3">Changer le statut :</h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="setObjectiveStatus('completed')" 
                                                class="p-3 bg-green-900/20 border border-green-500/30 text-green-300 rounded-lg hover:bg-green-900/40 transition-colors flex items-center justify-center gap-2">
                                            <span>‚úì</span>
                                            <span>VALID√â</span>
                                        </button>
                                        <button onclick="setObjectiveStatus('failed')" 
                                                class="p-3 bg-red-900/20 border border-red-500/30 text-red-300 rounded-lg hover:bg-red-900/40 transition-colors flex items-center justify-center gap-2">
                                            <span>‚úó</span>
                                            <span>√âCHEC</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button onclick="setObjectiveStatus('active')" 
                                            class="w-full p-2 bg-gray-900/20 border border-gray-500/30 text-gray-300 rounded-lg hover:bg-gray-900/40 transition-colors text-sm">
                                        ‚Üª R√âACTIVER (En cours)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3">
                                <button onclick="hideModal('objective-status-modal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir les informations de l'objectif
            document.getElementById('objective-text').textContent = objective.text;
            
            const currentStatusElement = document.getElementById('current-status');
            const statusText = objective.status === 'completed' ? 'VALID√â' : 
                              objective.status === 'failed' ? '√âCHEC' : 'EN COURS';
            const statusClass = objective.status === 'completed' ? 'bg-green-900/20 text-green-300' :
                               objective.status === 'failed' ? 'bg-red-900/20 text-red-300' :
                               'bg-blue-900/20 text-blue-300';
            
            currentStatusElement.textContent = statusText;
            currentStatusElement.className = `px-3 py-1 rounded text-sm font-medium ${statusClass}`;
            
            // Stocker les informations pour la fonction de mise √† jour
            window.currentObjectiveData = {
                missionName,
                objectiveIndex
            };
            
            showModal('objective-status-modal');
        }
        
        // Fonction pour d√©finir le statut d'un objectif
        function setObjectiveStatus(newStatus) {
            if (!window.currentObjectiveData) return;
            
            const { missionName, objectiveIndex } = window.currentObjectiveData;
            const objective = missions[missionName].objectives[objectiveIndex];
            
            if (!objective) return;
            
            const oldStatus = objective.status;
            objective.status = newStatus;
            
            // Cr√©er le message SITREP appropri√©
            let sitrepMessage;
            let notificationMessage;
            
            switch (newStatus) {
                case 'completed':
                    sitrepMessage = `Objectif VALID√â: ${objective.text}`;
                    notificationMessage = 'Objectif valid√© avec succ√®s';
                    break;
                case 'failed':
                    sitrepMessage = `Objectif √âCHOU√â: ${objective.text}`;
                    notificationMessage = 'Objectif marqu√© comme √©chou√©';
                    break;
                case 'active':
                    sitrepMessage = `Objectif R√âACTIV√â: ${objective.text}`;
                    notificationMessage = 'Objectif r√©activ√©';
                    break;
            }
            
            // Ajouter un SITREP automatique
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push({
                id: `sitrep_${Date.now()}`,
                message: sitrepMessage,
                timestamp: new Date().toISOString(),
                type: 'objective'
            });
            
            // Nettoyer les donn√©es temporaires
            delete window.currentObjectiveData;
            
            saveState();
            renderMissionDetail(missionName);
            hideModal('objective-status-modal');
            showNotification('Objectif mis √† jour', notificationMessage);
        }
        
        // Fonction pour ouvrir la modal de statut d'objectif
        function openObjectiveStatusModal(missionName, objectiveIndex) {
            if (!missions[missionName] || !missions[missionName].objectives[objectiveIndex]) {
                return;
            }
            
            const objective = missions[missionName].objectives[objectiveIndex];
            const modal = document.getElementById('objective-status-modal');
            
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="objective-status-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">üéØ Statut de l'Objectif</h3>
                            
                            <div class="mb-6">
                                <div class="bg-slate-700 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">Objectif :</h4>
                                    <p id="objective-text" class="text-white"></p>
                                </div>
                                
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-300 mb-2">Statut actuel :</h4>
                                    <span id="current-status" class="px-3 py-1 rounded text-sm font-medium"></span>
                                </div>
                                
                                <div>
                                    <h4 class="text-sm font-medium text-gray-300 mb-3">Changer le statut :</h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="setObjectiveStatus('completed')" 
                                                class="p-3 bg-green-900/20 border border-green-500/30 text-green-300 rounded-lg hover:bg-green-900/40 transition-colors flex items-center justify-center gap-2">
                                            <span>‚úì</span>
                                            <span>VALID√â</span>
                                        </button>
                                        <button onclick="setObjectiveStatus('failed')" 
                                                class="p-3 bg-red-900/20 border border-red-500/30 text-red-300 rounded-lg hover:bg-red-900/40 transition-colors flex items-center justify-center gap-2">
                                            <span>‚úó</span>
                                            <span>√âCHEC</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button onclick="setObjectiveStatus('active')" 
                                            class="w-full p-2 bg-gray-900/20 border border-gray-500/30 text-gray-300 rounded-lg hover:bg-gray-900/40 transition-colors text-sm">
                                        ‚Üª R√âACTIVER (En cours)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3">
                                <button onclick="hideModal('objective-status-modal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir les informations de l'objectif
            document.getElementById('objective-text').textContent = objective.text;
            
            const currentStatusElement = document.getElementById('current-status');
            const statusText = objective.status === 'completed' ? 'VALID√â' : 
                              objective.status === 'failed' ? '√âCHEC' : 'EN COURS';
            const statusClass = objective.status === 'completed' ? 'bg-green-900/20 text-green-300' :
                               objective.status === 'failed' ? 'bg-red-900/20 text-red-300' :
                               'bg-blue-900/20 text-blue-300';
            
            currentStatusElement.textContent = statusText;
            currentStatusElement.className = `px-3 py-1 rounded text-sm font-medium ${statusClass}`;
            
            // Stocker les informations pour la fonction de mise √† jour
            window.currentObjectiveData = {
                missionName,
                objectiveIndex
            };
            
            showModal('objective-status-modal');
        }
        
        // Fonction pour d√©finir le statut d'un objectif
        function setObjectiveStatus(newStatus) {
            if (!window.currentObjectiveData) return;
            
            const { missionName, objectiveIndex } = window.currentObjectiveData;
            const objective = missions[missionName].objectives[objectiveIndex];
            
            if (!objective) return;
            
            const oldStatus = objective.status;
            objective.status = newStatus;
            
            // Cr√©er le message SITREP appropri√©
            let sitrepMessage;
            let notificationMessage;
            
            switch (newStatus) {
                case 'completed':
                    sitrepMessage = `Objectif VALID√â: ${objective.text}`;
                    notificationMessage = 'Objectif valid√© avec succ√®s';
                    break;
                case 'failed':
                    sitrepMessage = `Objectif √âCHOU√â: ${objective.text}`;
                    notificationMessage = 'Objectif marqu√© comme √©chou√©';
                    break;
                case 'active':
                    sitrepMessage = `Objectif R√âACTIV√â: ${objective.text}`;
                    notificationMessage = 'Objectif r√©activ√©';
                    break;
            }
            
            // Ajouter un SITREP automatique
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push({
                id: `sitrep_${Date.now()}`,
                message: sitrepMessage,
                timestamp: new Date().toISOString(),
                type: 'objective'
            });
            
            // Nettoyer les donn√©es temporaires
            delete window.currentObjectiveData;
            
            saveState();
            renderMissionDetail(missionName);
            hideModal('objective-status-modal');
            showNotification('Objectif mis √† jour', notificationMessage);
        }
        
        // Fonction pour cr√©er un SITREP rapide
        function createQuickSitrep(missionName, type) {
            const mission = missions[missionName];
            if (!mission) return;
            
            // V√©rifier si c'est une demande du commandement
            const commandRequests = ['DEMANDER_POSITION', 'DEMANDER_STATUT', 'ORDRE_ENGAGEMENT'];
            if (commandRequests.includes(type)) {
                createDirectCommandSitrep(missionName, type);
                return;
            }
            
            // Si plusieurs escouades sont assign√©es, ouvrir la modal de s√©lection
            if (mission.assignedSquads && mission.assignedSquads.length > 1) {
                openSquadSelectionForSitrep(missionName, type);
                return;
            }
            
            // Si une seule escouade ou aucune, cr√©er directement le SITREP
            const assignedSquad = mission.assignedSquads && mission.assignedSquads.length === 1 ? mission.assignedSquads[0] : null;
            createSitrepWithSquad(missionName, type, assignedSquad);
        }
        
        // Fonction pour cr√©er directement un SITREP de demande du commandement
        function createDirectCommandSitrep(missionName, type) {
            const sitrepTypes = {
                'DEMANDER_POSITION': {
                    message: 'Commandement demande position actuelle - Appel radio en attente de retour',
                    priority: 'Normale'
                },
                'DEMANDER_STATUT': {
                    message: 'Commandement demande statut escouade - Appel radio en attente de retour',
                    priority: 'Normale'
                },
                'ORDRE_ENGAGEMENT': {
                    message: 'Ordre d\'engagement transmis - Appel radio en attente de confirmation',
                    priority: 'Critique'
                }
            };
            
            const sitrepInfo = sitrepTypes[type];
            if (!sitrepInfo) return;
            
            // Cr√©er le SITREP directement sans modal
            const sitrep = {
                id: `sitrep_${Date.now()}`,
                message: sitrepInfo.message,
                timestamp: new Date().toISOString(),
                type: type,
                priority: sitrepInfo.priority,
                squadName: null, // Commandement
                coordinates: {
                    latitude: null,
                    longitude: null,
                    grid: null
                },
                additionalInfo: null
            };
            
            // Ajouter le SITREP √† la mission
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push(sitrep);
            
            saveState();
            renderMissionDetail(missionName);
            showNotification('Appel Radio Envoy√©', `${type.replace('_', ' ')} - En attente de retour des escouades.`);
        }
        
        // Fonction pour ouvrir la modal de s√©lection d'escouade pour SITREP
        function openSquadSelectionForSitrep(missionName, sitrepType) {
            const mission = missions[missionName];
            if (!mission) return;
            
            const modal = document.getElementById('sitrep-squad-selection-modal');
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="sitrep-squad-selection-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">üì∞ S√©lection Escouade - SITREP</h3>
                            
                            <div class="mb-4">
                                <p class="text-gray-300 text-sm mb-3">Quelle escouade envoie ce rapport ?</p>
                                <div id="sitrep-squad-list" class="space-y-2">
                                    <!-- Liste des escouades g√©n√©r√©e dynamiquement -->
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3">
                                <button onclick="hideModal('sitrep-squad-selection-modal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir la liste des escouades
            const squadList = document.getElementById('sitrep-squad-list');
            squadList.innerHTML = mission.assignedSquads.map(squadName => {
                const squadColor = getSquadColor(squadName);
                return `
                    <button onclick="createSitrepWithSquad('${missionName}', '${sitrepType}', '${squadName}')" 
                            class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg border-l-4 transition-colors text-left"
                            style="border-left-color: ${squadColor}">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${squadColor}"></div>
                            <span class="font-bold" style="color: ${squadColor}">${squadName}</span>
                            <span class="text-xs text-gray-400 ml-auto">
                                ${squads[squadName] && squads[squadName].personnel ? 
                                    squads[squadName].personnel.filter(p => p.name && p.name.trim()).length : 0} membres
                            </span>
                        </div>
                    </button>
                `;
            }).join('');
            
            showModal('sitrep-squad-selection-modal');
        }
        
        // Fonction pour cr√©er un SITREP avec une escouade sp√©cifi√©e
        function createSitrepWithSquad(missionName, type, squadName) {
            // Fermer la modal de s√©lection si elle est ouverte
            hideModal('sitrep-squad-selection-modal');
            
            const sitrepTypes = {
                'CONTACT_ENNEMI': {
                    message: 'Contact ennemi signal√© - Demande instructions',
                    priority: 'Haute'
                },
                'DEMANDE_SOUTIEN': {
                    message: 'Demande soutien feu - Position compromise',
                    priority: 'Critique'
                },
                'PROGRESSION': {
                    message: 'Progression selon plan - Objectif en vue',
                    priority: 'Normale'
                },
                'OBJECTIF_ATTEINT': {
                    message: 'Objectif atteint - Demande nouvelles instructions',
                    priority: 'Haute'
                },
                'MUNITIONS_BASSES': {
                    message: 'Munitions basses - Demande ravitaillement',
                    priority: 'Haute'
                },
                'DEMANDE_RAVIT': {
                    message: 'Demande ravitaillement - Vivres et munitions',
                    priority: 'Normale'
                },
                'RETOUR_CALME': {
                    message: 'Situation stabilis√©e - Retour au calme',
                    priority: 'Normale'
                },
                'DEMANDER_POSITION': {
                    message: 'Commandement demande position actuelle',
                    priority: 'Normale'
                },
                'DEMANDER_STATUT': {
                    message: 'Commandement demande statut escouade',
                    priority: 'Normale'
                },
                'ORDRE_ENGAGEMENT': {
                    message: 'Ordre d\'engagement re√ßu - Ex√©cution imm√©diate',
                    priority: 'Critique'
                },
                // R√©ponses aux demandes du commandement
                'REPONSE_POSITION': {
                    message: 'Position actuelle transmise - Coordonn√©es ci-dessous',
                    priority: 'Normale'
                },
                'REPONSE_STATUT': {
                    message: 'Statut escouade transmis - Effectifs et √©tat op√©rationnel',
                    priority: 'Normale'
                },
                'CONFIRMATION_ORDRE': {
                    message: 'Ordre d\'engagement confirm√© - Ex√©cution en cours',
                    priority: 'Haute'
                },
                'ORDRE_RECU': {
                    message: 'Ordre bien re√ßu - En attente d\'ex√©cution',
                    priority: 'Normale'
                }
            };
            
            const sitrepInfo = sitrepTypes[type];
            if (!sitrepInfo) return;
            
            // Ouvrir la modal de coordonn√©es pour finaliser le SITREP
            openCoordinatesModal(missionName, type, squadName, sitrepInfo);
        }
        
        // Fonction pour ouvrir la modal de coordonn√©es
        function openCoordinatesModal(missionName, sitrepType, squadName, sitrepInfo) {
            const modal = document.getElementById('coordinates-modal');
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="coordinates-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-lg mx-4">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">üìç Finaliser SITREP</h3>
                            
                            <div class="space-y-4">
                                <!-- Informations du rapport -->
                                <div class="bg-slate-700 p-3 rounded-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-sm font-medium text-gray-300">Type:</span>
                                        <span id="coord-sitrep-type" class="text-cyan-400 font-bold"></span>
                                    </div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-sm font-medium text-gray-300">Escouade:</span>
                                        <span id="coord-squad-name" class="font-bold"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-medium text-gray-300">Priorit√©:</span>
                                        <span id="coord-priority" class="px-2 py-1 rounded text-xs"></span>
                                    </div>
                                </div>
                                
                                <!-- Message du rapport -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Message</label>
                                    <textarea id="coord-message" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white" 
                                              rows="3" placeholder="Message du rapport..."></textarea>
                                </div>
                                
                                <!-- Coordonn√©es -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Coordonn√©es (optionnel)</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Latitude</label>
                                            <input type="text" id="coord-latitude" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white text-sm" 
                                                   placeholder="Ex: 48.8566">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Longitude</label>
                                            <input type="text" id="coord-longitude" class="w-full p-2 bg-slate-700 border border-slate-600 rounded text-white text-sm" 
                                                   placeholder="Ex: 2.3522">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informations compl√©mentaires -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Informations compl√©mentaires (optionnel)</label>
                                    <textarea id="coord-additional" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white" 
                                              rows="2" placeholder="D√©tails suppl√©mentaires, contexte, observations..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 mt-6">
                                <button onclick="hideModal('coordinates-modal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                    Annuler
                                </button>
                                <button onclick="finalizeAndSendSitrep()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition-colors">
                                    Envoyer SITREP
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir les informations du rapport
            document.getElementById('coord-sitrep-type').textContent = sitrepType.replace('_', ' ');
            
            const squadColor = squadName ? getSquadColor(squadName) : '#6b7280';
            const squadNameElement = document.getElementById('coord-squad-name');
            squadNameElement.textContent = squadName || 'Commandement';
            squadNameElement.style.color = squadColor;
            
            const priorityElement = document.getElementById('coord-priority');
            priorityElement.textContent = sitrepInfo.priority;
            priorityElement.className = `px-2 py-1 rounded text-xs ${
                sitrepInfo.priority === 'Critique' ? 'bg-red-900/20 text-red-300' :
                sitrepInfo.priority === 'Haute' ? 'bg-orange-900/20 text-orange-300' :
                sitrepInfo.priority === 'Normale' ? 'bg-blue-900/20 text-blue-300' :
                'bg-gray-900/20 text-gray-300'
            }`;
            
            document.getElementById('coord-message').value = sitrepInfo.message;
            
            // R√©initialiser les champs de coordonn√©es
            document.getElementById('coord-latitude').value = '';
            document.getElementById('coord-longitude').value = '';
            document.getElementById('coord-additional').value = '';
            
            // Stocker les informations pour la finalisation
            window.currentSitrepData = {
                missionName,
                sitrepType,
                squadName,
                sitrepInfo
            };
            
            showModal('coordinates-modal');
        }
        
        // Fonction pour finaliser et envoyer le SITREP
        function finalizeAndSendSitrep() {
            if (!window.currentSitrepData) return;
            
            const { missionName, sitrepType, squadName, sitrepInfo } = window.currentSitrepData;
            
            const message = document.getElementById('coord-message').value.trim();
            const latitude = document.getElementById('coord-latitude').value.trim();
            const longitude = document.getElementById('coord-longitude').value.trim();
            const additional = document.getElementById('coord-additional').value.trim();
            
            if (!message) {
                showNotification('Erreur', 'Le message du rapport est obligatoire.');
                return;
            }
            
            // Construire le SITREP complet
            const sitrep = {
                id: `sitrep_${Date.now()}`,
                message: message,
                timestamp: new Date().toISOString(),
                type: sitrepType,
                priority: sitrepInfo.priority,
                squadName: squadName,
                coordinates: {
                    latitude: latitude || null,
                    longitude: longitude || null
                },
                additionalInfo: additional || null
            };
            
            // Ajouter le SITREP √† la mission
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push(sitrep);
            
            // Nettoyer les donn√©es temporaires
            delete window.currentSitrepData;
            
            saveState();
            renderMissionDetail(missionName);
            hideModal('coordinates-modal');
            
            const squadText = squadName ? ` de l'escouade ${squadName}` : ' du commandement';
            showNotification('SITREP Envoy√©', `Rapport ${sitrepType.replace('_', ' ')}${squadText} transmis avec priorit√© ${sitrepInfo.priority.toLowerCase()}.`);
        }
        
        // Fonction pour ouvrir la modal de cr√©ation de SITREP personnalis√©
        function openSitrepModal(missionName) {
            const modal = document.getElementById('sitrep-modal');
            if (!modal) {
                // Cr√©er la modal dynamiquement si elle n'existe pas
                const modalHTML = `
                    <div id="sitrep-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">üì∞ Nouveau Rapport SITREP</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Type de rapport</label>
                                    <select id="sitrep-type" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                        <optgroup label="Rapports Escouade">
                                            <option value="CONTACT_ENNEMI">Contact Ennemi</option>
                                            <option value="DEMANDE_SOUTIEN">Demande Soutien</option>
                                            <option value="PROGRESSION">Progression</option>
                                            <option value="OBJECTIF_ATTEINT">Objectif Atteint</option>
                                            <option value="MUNITIONS_BASSES">Munitions Basses</option>
                                            <option value="DEMANDE_RAVIT">Demande Ravitaillement</option>
                                            <option value="RETOUR_CALME">Retour au Calme</option>
                                        </optgroup>
                                        <optgroup label="Demandes Commandement">
                                            <option value="DEMANDER_POSITION">Demander Position</option>
                                            <option value="DEMANDER_STATUT">Demander Statut</option>
                                            <option value="ORDRE_ENGAGEMENT">Ordre d'Engagement</option>
                                        </optgroup>
                                        <option value="CUSTOM">Rapport personnalis√©</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Message</label>
                                    <textarea id="sitrep-message" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white" 
                                              rows="4" placeholder="D√©crivez la situation..."></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Priorit√©</label>
                                    <select id="sitrep-priority" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                        <option value="Faible">Faible</option>
                                        <option value="Normale" selected>Normale</option>
                                        <option value="Haute">Haute</option>
                                        <option value="Critique">Critique</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 mt-6">
                                <button onclick="hideModal('sitrep-modal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                    Annuler
                                </button>
                                <button onclick="submitCustomSitrep('${missionName}')" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition-colors">
                                    Envoyer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Gestionnaire pour le changement de type
                document.getElementById('sitrep-type').addEventListener('change', function() {
                    const type = this.value;
                    const messageField = document.getElementById('sitrep-message');
                    const priorityField = document.getElementById('sitrep-priority');
                    
                    const sitrepTypes = {
                        'CONTACT_ENNEMI': { message: 'Contact ennemi signal√© - Demande instructions', priority: 'Haute' },
                        'DEMANDE_SOUTIEN': { message: 'Demande soutien feu - Position compromise', priority: 'Critique' },
                        'PROGRESSION': { message: 'Progression selon plan - Objectif en vue', priority: 'Normale' },
                        'OBJECTIF_ATTEINT': { message: 'Objectif atteint - Demande nouvelles instructions', priority: 'Haute' },
                        'MUNITIONS_BASSES': { message: 'Munitions basses - Demande ravitaillement', priority: 'Haute' },
                        'DEMANDE_RAVIT': { message: 'Demande ravitaillement - Vivres et munitions', priority: 'Normale' },
                        'RETOUR_CALME': { message: 'Situation stabilis√©e - Retour au calme', priority: 'Normale' },
                        'DEMANDER_POSITION': { message: 'Commandement demande position actuelle', priority: 'Normale' },
                        'DEMANDER_STATUT': { message: 'Commandement demande statut escouade', priority: 'Normale' },
                        'ORDRE_ENGAGEMENT': { message: 'Ordre d\'engagement re√ßu - Ex√©cution imm√©diate', priority: 'Critique' }
                    };
                    
                    if (type !== 'CUSTOM' && sitrepTypes[type]) {
                        messageField.value = sitrepTypes[type].message;
                        priorityField.value = sitrepTypes[type].priority;
                    } else if (type === 'CUSTOM') {
                        messageField.value = '';
                        priorityField.value = 'Normale';
                    }
                });
            }
            
            // R√©initialiser les champs
            document.getElementById('sitrep-type').value = 'CONTACT_ENNEMI';
            document.getElementById('sitrep-message').value = 'Contact ennemi signal√© - Demande instructions';
            document.getElementById('sitrep-priority').value = 'Haute';
            
            showModal('sitrep-modal');
        }
        
        // Fonction pour soumettre un SITREP personnalis√©
        function submitCustomSitrep(missionName) {
            const type = document.getElementById('sitrep-type').value;
            const message = document.getElementById('sitrep-message').value.trim();
            const priority = document.getElementById('sitrep-priority').value;
            
            if (!message) {
                showNotification('Erreur', 'Veuillez saisir un message pour le rapport.');
                return;
            }
            
            const sitrep = {
                id: `sitrep_${Date.now()}`,
                message: message,
                timestamp: new Date().toISOString(),
                type: type,
                priority: priority
            };
            
            if (!missions[missionName].sitreps) {
                missions[missionName].sitreps = [];
            }
            missions[missionName].sitreps.push(sitrep);
            
            saveState();
            renderMissionDetail(missionName);
            hideModal('sitrep-modal');
            showNotification('SITREP Envoy√©', `Rapport transmis avec priorit√© ${priority.toLowerCase()}.`);
        }
        
        // Fonction pour confirmer la s√©lection d'escouades
        function confirmSquadSelection() {
            const display = document.getElementById('modal-mission-squads-display');
            if (display) {
                display.textContent = tempMissionData.assignedSquads.length > 0 
                    ? tempMissionData.assignedSquads.join(', ') 
                    : 'Aucune';
            }
            hideModal('squad-selection-modal');
        }
        
        // === FONCTIONS UTILITAIRES POUR LES MODALES ===
        
        // Fonction pour basculer l'affichage des dropdowns
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('[id$="-dropdown"]');
            
            // Fermer tous les autres dropdowns
            allDropdowns.forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.add('hidden');
                }
            });
            
            // Basculer le dropdown cibl√©
            dropdown.classList.toggle('hidden');
        }
        
        // Fonction pour s√©lectionner une cat√©gorie
        function selectCategory(category) {
            tempMissionData.category = category;
            document.getElementById('modal-mission-category-btn').textContent = category;
            document.getElementById('category-dropdown').classList.add('hidden');
        }
        
        // Fonction pour s√©lectionner une difficult√©
        function selectDifficulty(difficulty) {
            tempMissionData.difficulty = difficulty;
            document.getElementById('modal-mission-difficulty-btn').textContent = difficulty;
            document.getElementById('difficulty-dropdown').classList.add('hidden');
        }
        
        // Fermer les dropdowns en cliquant ailleurs
        document.addEventListener('click', function(event) {
            const dropdowns = document.querySelectorAll('[id$="-dropdown"]');
            const buttons = document.querySelectorAll('[id$="-btn"]');
            
            let clickedOnButton = false;
            buttons.forEach(button => {
                if (button.contains(event.target)) {
                    clickedOnButton = true;
                }
            });
            
            if (!clickedOnButton) {
                dropdowns.forEach(dropdown => {
                    if (!dropdown.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            }
        });
        
        // === FONCTIONS D'AFFECTATION D'ESCOUADE √Ä MISSION ===
        
        // Fonction pour ouvrir la modal d'affectation d'escouade
        function openSquadAssignmentModal(squadName) {
            const modal = document.getElementById('squad-assignment-modal');
            if (!modal) {
                // Cr√©er la modal dynamiquement
                const modalHTML = `
                    <div id="squad-assignment-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-lg mx-4">
                            <h3 class="text-xl font-bold text-blue-400 mb-4">üéØ Affecter Escouade √† Mission</h3>
                            
                            <div class="mb-4">
                                <p class="text-gray-300 mb-2">Escouade: <span id="assignment-squad-name" class="font-bold text-blue-400"></span></p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-300 mb-3">Choisir une option :</h4>
                                    
                                    <div class="space-y-3">
                                        <button onclick="assignToExistingMission()" 
                                                class="w-full p-4 bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-green-300 rounded border border-green-500/30 hover:border-green-500/50 transition-all duration-200 text-left">
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">üìã</span>
                                                <div>
                                                    <div class="font-semibold">Mission Existante</div>
                                                    <div class="text-sm opacity-75">Affecter en soutien d'une mission d√©j√† cr√©√©e</div>
                                                </div>
                                            </div>
                                        </button>
                                        
                                        <button onclick="createNewMissionWithSquad()" 
                                                class="w-full p-4 bg-orange-900/20 hover:bg-orange-900/40 text-orange-400 hover:text-orange-300 rounded border border-orange-500/30 hover:border-orange-500/50 transition-all duration-200 text-left">
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">‚ú®</span>
                                                <div>
                                                    <div class="font-semibold">Nouvelle Mission</div>
                                                    <div class="text-sm opacity-75">Cr√©er une nouvelle mission avec cette escouade</div>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button onclick="hideModal('squad-assignment-modal')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir le nom de l'escouade
            document.getElementById('assignment-squad-name').textContent = squadName;
            
            // Stocker l'escouade pour les fonctions suivantes
            window.currentAssignmentSquad = squadName;
            
            showModal('squad-assignment-modal');
        }
        
        // Fonction pour affecter √† une mission existante
        function assignToExistingMission() {
            const squadName = window.currentAssignmentSquad;
            if (!squadName) return;
            
            const availableMissions = Object.values(missions).filter(mission => 
                mission.status !== 'Termin√©e' && mission.status !== 'Annul√©e'
            );
            
            if (availableMissions.length === 0) {
                showNotification('Aucune Mission', 'Aucune mission active disponible. Cr√©ez d\'abord une mission.');
                return;
            }
            
            // Cr√©er la modal de s√©lection de mission
            const modal = document.getElementById('mission-selection-modal');
            if (!modal) {
                const modalHTML = `
                    <div id="mission-selection-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-2xl mx-4">
                            <h3 class="text-xl font-bold text-green-400 mb-4">üìã S√©lectionner une Mission</h3>
                            
                            <div id="available-missions-list" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Missions seront ajout√©es ici -->
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button onclick="hideModal('mission-selection-modal')" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Remplir la liste des missions
            const missionsList = document.getElementById('available-missions-list');
            missionsList.innerHTML = availableMissions.map(mission => {
                const statusColor = {
                    'En pr√©paration': 'text-yellow-400',
                    'En cours': 'text-blue-400',
                    'Termin√©e': 'text-green-400',
                    'Annul√©e': 'text-red-400'
                }[mission.status] || 'text-gray-400';
                
                const assignedSquadsCount = mission.assignedSquads ? mission.assignedSquads.length : 0;
                
                return `
                    <div onclick="confirmMissionAssignment('${mission.name}')" 
                         class="p-4 bg-slate-700 hover:bg-slate-600 rounded-lg cursor-pointer transition-colors border border-slate-600 hover:border-slate-500">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <h4 class="font-semibold text-white mb-1">${mission.name}</h4>
                                <p class="text-sm text-gray-400 mb-2">${mission.sector}</p>
                                <div class="flex items-center gap-4 text-xs">
                                    <span class="${statusColor}">${mission.status}</span>
                                    <span class="text-gray-500">üë• ${assignedSquadsCount} escouade(s)</span>
                                    <span class="text-gray-500">üìÖ ${mission.category}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs px-2 py-1 rounded bg-green-900/20 text-green-400">
                                    Cliquer pour affecter
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            hideModal('squad-assignment-modal');
            showModal('mission-selection-modal');
        }
        
        // Fonction pour confirmer l'affectation √† une mission
        function confirmMissionAssignment(missionName) {
            const squadName = window.currentAssignmentSquad;
            if (!squadName || !missions[missionName]) return;
            
            // Ajouter l'escouade √† la mission
            if (!missions[missionName].assignedSquads) {
                missions[missionName].assignedSquads = [];
            }
            
            if (!missions[missionName].assignedSquads.includes(squadName)) {
                missions[missionName].assignedSquads.push(squadName);
                
                saveState();
                renderSquadDetail();
                renderMissionDetail(missionName);
                renderMissionList();
                renderDashboardMissions();
                updateStats();
                
                hideModal('mission-selection-modal');
                
                showNotification('Affectation R√©ussie', `L'escouade "${squadName}" a √©t√© affect√©e √† la mission "${missionName}" en soutien.`);
                
                // Nettoyer la variable temporaire
                delete window.currentAssignmentSquad;
            } else {
                showNotification('D√©j√† Affect√©e', `L'escouade "${squadName}" est d√©j√† affect√©e √† cette mission.`);
            }
        }
        
        // Fonction pour cr√©er une nouvelle mission avec l'escouade
        function createNewMissionWithSquad() {
            const squadName = window.currentAssignmentSquad;
            if (!squadName) return;
            
            // Pr√©-remplir les donn√©es de mission avec l'escouade
            tempMissionData = {
                difficulty: 'Normale',
                category: 'Choisir...',
                assignedSquads: [squadName]
            };
            tempObjectives = [{ text: 'Objectif principal', status: 'active' }];
            
            // Remplir les champs de la modal de cr√©ation
            document.getElementById('modal-mission-name').value = '';
            document.getElementById('modal-mission-sector').value = '';
            document.getElementById('modal-mission-category-btn').textContent = 'Choisir...';
            document.getElementById('modal-mission-difficulty-btn').textContent = 'Normale';
            document.getElementById('modal-mission-squads-display').textContent = squadName;
            
            renderObjectivesInModal();
            
            // Fermer la modal d'affectation et ouvrir la cr√©ation de mission
            hideModal('squad-assignment-modal');
            showModal('mission-creation-modal');
            
            // Nettoyer la variable temporaire
            delete window.currentAssignmentSquad;
        }
        
        // === FONCTIONS DE SAUVEGARDE ET CHARGEMENT ===
        
        // Fonction pour sauvegarder l'√©tat complet via Firebase
        function saveState() {
            const state = {
                squads: squads,
                missions: missions,
                selectedSquad: selectedSquad,
                selectedMission: selectedMission,
                selectedBase: selectedBase,
                selectedFOB: selectedFOB,
                lastSaved: new Date().toISOString(),
                lastModifiedBy: currentUser ? currentUser.pseudo : 'Syst√®me'
            };
            
            // Sauvegarder dans Firebase en priorit√©
            if (isFirebaseEnabled && database) {
                try {
                    database.ref('commandement_data').set(state)
                        .then(() => {
                            console.log('üíæ Donn√©es synchronis√©es avec Firebase');
                        })
                        .catch((error) => {
                            console.error('‚ùå Erreur Firebase, fallback localStorage:', error);
                            localStorage.setItem('commandement_os_state', JSON.stringify(state));
                        });
                } catch (error) {
                    console.error('‚ùå Erreur Firebase, fallback localStorage:', error);
                    localStorage.setItem('commandement_os_state', JSON.stringify(state));
                }
            } else {
                // Fallback localStorage si Firebase indisponible
                localStorage.setItem('commandement_os_state', JSON.stringify(state));
                console.log('üíæ Donn√©es sauvegard√©es localement (Firebase indisponible)');
            }
        }
        
        // Fonction pour charger l'√©tat complet depuis Firebase avec √©coute temps r√©el
        function loadState() {
            if (isFirebaseEnabled && database) {
                try {
                    // Charger les donn√©es initiales
                    database.ref('commandement_data').once('value')
                        .then((snapshot) => {
                            const state = snapshot.val();
                            if (state) {
                                squads = state.squads || {};
                                missions = state.missions || {};
                                selectedSquad = state.selectedSquad || null;
                                selectedMission = state.selectedMission || null;
                                selectedBase = state.selectedBase || null;
                                selectedFOB = state.selectedFOB || null;
                                
                                console.log('üîÑ Donn√©es charg√©es depuis Firebase');
                                
                                // Mettre √† jour l'interface
                                updateAllInterfaces();
                                
                                // Notification de synchronisation
                                if (state.lastModifiedBy && currentUser && state.lastModifiedBy !== currentUser.pseudo) {
                                    showNotification('üîÑ Synchronisation', `Donn√©es mises √† jour par ${state.lastModifiedBy}`, 'info');
                                }
                            } else {
                                console.log('üÜï Aucune donn√©e Firebase, initialisation vide');
                            }
                        })
                        .catch((error) => {
                            console.error('‚ùå Erreur chargement Firebase, fallback localStorage:', error);
                            loadStateFromLocalStorage();
                        });
                    
                    // √âcoute temps r√©el des changements
                    setupRealtimeDataListener();
                    return true;
                } catch (error) {
                    console.error('‚ùå Erreur Firebase, fallback localStorage:', error);
                    return loadStateFromLocalStorage();
                }
            } else {
                // Fallback localStorage si Firebase indisponible
                return loadStateFromLocalStorage();
            }
        }
        
        // Fonction fallback pour charger depuis localStorage
        function loadStateFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('commandement_os_state');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    squads = state.squads || {};
                    missions = state.missions || {};
                    selectedSquad = state.selectedSquad || null;
                    selectedMission = state.selectedMission || null;
                    selectedBase = state.selectedBase || null;
                    selectedFOB = state.selectedFOB || null;
                    
                    console.log('üíæ Donn√©es charg√©es depuis localStorage');
                    updateAllInterfaces();
                    return true;
                }
            } catch (error) {
                console.error('Erreur lors du chargement localStorage:', error);
            }
            return false;
        }
        
        // Fonction pour configurer l'√©coute temps r√©el des donn√©es Firebase
        function setupRealtimeDataListener() {
            if (!isFirebaseEnabled || !database) return;
            
            try {
                database.ref('commandement_data').on('value', (snapshot) => {
                    const state = snapshot.val();
                    if (state && state.lastModifiedBy && currentUser && state.lastModifiedBy !== currentUser.pseudo) {
                        // Mise √† jour des donn√©es depuis un autre utilisateur
                        squads = state.squads || {};
                        missions = state.missions || {};
                        selectedSquad = state.selectedSquad || null;
                        selectedMission = state.selectedMission || null;
                        selectedBase = state.selectedBase || null;
                        selectedFOB = state.selectedFOB || null;
                        
                        console.log(`üîÑ Synchronisation temps r√©el depuis ${state.lastModifiedBy}`);
                        
                        // Mettre √† jour toute l'interface
                        updateAllInterfaces();
                        
                        // Notification de synchronisation
                        showNotification('üîÑ Synchronisation', `Donn√©es mises √† jour par ${state.lastModifiedBy}`, 'info');
                    }
                });
                
                console.log('üîä √âcoute temps r√©el Firebase activ√©e');
            } catch (error) {
                console.error('‚ùå Erreur configuration √©coute Firebase:', error);
            }
        }
        
        // Fonction pour mettre √† jour toutes les interfaces
        function updateAllInterfaces() {
            try {
                // Mettre √† jour toutes les listes et affichages
                renderSquadsList();
                renderDashboardAllSquads();
                renderMissionList();
                renderDashboardMissions();
                renderDashboardCompletedMissions();
                updateStats();
                renderDetailedStats();
                updateBaseAndFOBDisplay();
                
                // Mettre √† jour les d√©tails si une escouade/mission est s√©lectionn√©e
                if (selectedSquad && squads[selectedSquad]) {
                    renderSquadDetail();
                }
                if (selectedMission && missions[selectedMission]) {
                    renderMissionDetail(selectedMission);
                }
                
                console.log('üîÑ Toutes les interfaces mises √† jour');
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour interfaces:', error);
            }
        }
        
        // === SYNCHRONISATION ESCOUADES DEPUIS SL ===
        
        // Fonction pour √©couter les escouades synchronis√©es depuis escouade.html
        function listenForSquadSync() {
            if (!isFirebaseEnabled || !database) {
                console.log('üì± Mode local : √©coute escouades SL d√©sactiv√©e');
                return;
            }
            
            try {
                // √âcouter les nouvelles escouades envoy√©es par les SL
                database.ref('squad_sync').on('child_added', (snapshot) => {
                    const squadData = snapshot.val();
                    if (squadData && squadData.name) {
                        console.log(`üì´ Escouade re√ßue depuis SL: ${squadData.name}`);
                        
                        // Ajouter l'escouade aux donn√©es locales
                        squads[squadData.name] = {
                            name: squadData.name,
                            type: squadData.type || 'Terrain',
                            personnel: squadData.personnel || [],
                            frequency: squadData.frequency || '30.0 MHz',
                            color: squadData.color || '#4CAF50',
                            createdAt: squadData.exportDate || new Date().toISOString(),
                            syncedFromSL: true,
                            lastSync: new Date().toISOString()
                        };
                        
                        // Sauvegarder et mettre √† jour l'interface
                        saveState();
                        updateAllInterfaces();
                        
                        // Notification de r√©ception
                        showNotification('üì´ Escouade Re√ßue', `Escouade ${squadData.name} synchronis√©e depuis SL (${squadData.personnel.length} membres)`, 'success');
                        
                        // Supprimer l'entr√©e de synchronisation pour √©viter les doublons
                        snapshot.ref.remove();
                    }
                });
                
                console.log('üîä √âcoute escouades SL activ√©e');
            } catch (error) {
                console.error('‚ùå Erreur √©coute escouades SL:', error);
            }
        }
        
        // === MODAL DE CONFIRMATION PERSONNALIS√âE ===
        
        // Variable pour stocker la fonction de callback de confirmation
        let confirmationCallback = null;
        
        // Fonction pour afficher la modal de confirmation personnalis√©e
        function showCustomConfirmation(title, message, onConfirm) {
            console.log('üîî Affichage de la modal de confirmation personnalis√©e');
            console.log('Message:', message);
            
            // Stocker le callback
            confirmationCallback = onConfirm;
            
            // V√©rifier que les √©l√©ments existent
            const modal = document.getElementById('delete-confirmation-modal');
            const messageElement = document.getElementById('delete-confirmation-message');
            
            if (!modal) {
                console.error('‚ùå Modal delete-confirmation-modal introuvable!');
                // Fallback vers confirm() natif
                if (confirm(message)) {
                    onConfirm();
                }
                return;
            }
            
            if (!messageElement) {
                console.error('‚ùå √âl√©ment delete-confirmation-message introuvable!');
                return;
            }
            
            // Mettre √† jour le message
            messageElement.textContent = message;
            
            // Afficher la modal
            modal.classList.remove('hidden');
            console.log('‚úÖ Modal affich√©e');
        }
        
        // Fonction pour masquer la modal de confirmation
        function hideCustomConfirmation() {
            console.log('‚ùå Fermeture de la modal de confirmation');
            const modal = document.getElementById('delete-confirmation-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            confirmationCallback = null;
        }
        
        // Configuration des gestionnaires d'√©v√©nements pour la modal
        function setupConfirmationModalEvents() {
            console.log('üîß Configuration des √©v√©nements de la modal de confirmation');
            
            // Bouton Annuler
            const cancelBtn = document.getElementById('delete-cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    console.log('‚ùå Suppression annul√©e par l\'utilisateur');
                    hideCustomConfirmation();
                });
            }
            
            // Bouton Confirmer
            const confirmBtn = document.getElementById('delete-confirm-btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    console.log('‚úÖ Suppression confirm√©e par l\'utilisateur');
                    if (confirmationCallback) {
                        confirmationCallback();
                    }
                    hideCustomConfirmation();
                });
            }
            
            // Fermer en cliquant sur l'arri√®re-plan
            const modal = document.getElementById('delete-confirmation-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('‚ùå Modal ferm√©e en cliquant sur l\'arri√®re-plan');
                        hideCustomConfirmation();
                    }
                });
            }
            
            // Fermer avec la touche √âchap
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                    console.log('‚ùå Modal ferm√©e avec la touche √âchap');
                    hideCustomConfirmation();
                }
            });
            
            console.log('‚úÖ √âv√©nements de la modal configur√©s');
        }
        
        // === GESTIONNAIRES D'√âV√âNEMENTS ===
        
        // Fonction pour configurer tous les gestionnaires d'√©v√©nements
        function setupEventHandlers() {
            // Gestionnaire pour les clics sur les objectifs
            document.addEventListener('click', function(e) {
                // Gestionnaire pour la validation/√©chec des objectifs dans le d√©tail de mission
                if (e.target.closest('.objective-item') && 
                    (e.target.closest('#mission-detail-view') || e.target.closest('#mission-detail'))) {
                    const objectiveItem = e.target.closest('.objective-item');
                    const missionName = objectiveItem.dataset.mission;
                    const objectiveIndex = parseInt(objectiveItem.dataset.objectiveIndex);
                    
                    if (missionName && missions[missionName] && missions[missionName].objectives[objectiveIndex]) {
                        openObjectiveStatusModal(missionName, objectiveIndex);
                    }
                }
            });
        }
        
        // === CHRONOLOGIE MISSION SITREP ===
        
        // Fonction pour cr√©er un SITREP de chronologie de mission
        function createMissionChronologySitrep(missionName, eventType) {
            const mission = missions[missionName];
            if (!mission) return;
            
            // Si plusieurs escouades, demander laquelle
            if (mission.assignedSquads.length > 1) {
                openSquadSelectionForChronology(missionName, eventType);
                return;
            }
            
            // Si une seule escouade, cr√©er directement
            const squadName = mission.assignedSquads[0];
            createChronologyEventWithSquad(missionName, eventType, squadName);
        }
        
        // Fonction pour ouvrir la s√©lection d'escouade pour chronologie
        function openSquadSelectionForChronology(missionName, eventType) {
            const mission = missions[missionName];
            if (!mission) return;
            
            // V√©rifier si la modal existe d√©j√†
            if (!document.getElementById('chronology-squad-selection-modal')) {
                console.log('Modal de s√©lection d\'escouade non trouv√©e');
                return;
            }
            
            // Remplir la liste des escouades
            const squadList = document.getElementById('chronology-squad-list');
            squadList.innerHTML = mission.assignedSquads.map(squadName => {
                const squadColor = getSquadColor(squadName);
                return `
                    <button onclick="createChronologyEventWithSquad('${missionName}', '${eventType}', '${squadName}')" 
                            class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 hover:border-purple-500/50 transition-all duration-200 text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${squadColor}"></div>
                            <span class="font-bold" style="color: ${squadColor}">${squadName}</span>
                            <span class="text-xs text-gray-400 ml-auto">
                                ${squads[squadName] && squads[squadName].personnel ? 
                                    squads[squadName].personnel.filter(p => p.name && p.name.trim()).length : 0} membres
                            </span>
                        </div>
                    </button>
                `;
            }).join('');
            
            showModal('chronology-squad-selection-modal');
        }
        
        // Fonction pour cr√©er un √©v√©nement de chronologie avec escouade
        function createChronologyEventWithSquad(missionName, eventType, squadName) {
            hideModal('chronology-squad-selection-modal');
            
            const eventMessages = {
                'DEPART_BASE': `Escouade ${squadName} - D√©part de la base confirm√©`,
                'SUR_OBJECTIF': `Escouade ${squadName} - Arriv√©e sur objectif confirm√©e`,
                'OBJECTIF_ATTEINT': `Escouade ${squadName} - Objectif atteint avec succ√®s`,
                'RETOUR_BASE': `Escouade ${squadName} - Retour √† la base en cours`,
                'DEMANDE_EVACUATION': `Escouade ${squadName} - Demande d'√©vacuation urgente`
            };
            
            const message = eventMessages[eventType] || `Escouade ${squadName} - √âv√©nement ${eventType}`;
            
            // Cr√©er l'√©v√©nement de chronologie
            const chronologyEvent = {
                id: `chrono_${Date.now()}`,
                type: eventType,
                squadName: squadName,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // Ajouter √† la chronologie de la mission
            if (!missions[missionName].chronologyEvents) {
                missions[missionName].chronologyEvents = [];
            }
            missions[missionName].chronologyEvents.push(chronologyEvent);
            
            // V√©rifier si c'est un retour base pour la terminaison automatique
            if (eventType === 'RETOUR_BASE') {
                checkMissionTerminationBySquadStatus(missionName);
            }
            
            saveState();
            renderMissionDetail(missionName);
            showNotification('Chronologie Mise √† Jour', `${eventType.replace('_', ' ')} enregistr√© pour l'escouade ${squadName}`);
        }
        
        // Fonction pour v√©rifier la terminaison de mission selon l'√©tat des escouades
        function checkMissionTerminationBySquadStatus(missionName) {
            const mission = missions[missionName];
            if (!mission || mission.status === 'Termin√©e') return;
            
            // Compter les escouades qui sont revenues √† la base
            const returnedSquads = mission.chronologyEvents ? 
                mission.chronologyEvents.filter(event => 
                    event.type === 'RETOUR_BASE' && 
                    mission.assignedSquads.includes(event.squadName)
                ).map(event => event.squadName) : [];
            
            // Supprimer les doublons
            const uniqueReturnedSquads = [...new Set(returnedSquads)];
            
            // Si toutes les escouades sont revenues
            if (uniqueReturnedSquads.length === mission.assignedSquads.length) {
                // Proposer la terminaison automatique
                setTimeout(() => {
                    showCustomConfirmation(
                        'Terminaison Automatique',
                        `Toutes les escouades de la mission "${missionName}" sont revenues √† la base.\n\nVoulez-vous terminer automatiquement cette mission ?`,
                        () => {
                            // Terminer la mission automatiquement
                            missions[missionName].status = 'Termin√©e';
                            missions[missionName].outcome = 'success';
                            missions[missionName].completionDate = new Date().toISOString();
                            
                            // Ajouter un SITREP de fin
                            if (!missions[missionName].sitreps) {
                                missions[missionName].sitreps = [];
                            }
                            missions[missionName].sitreps.push({
                                id: `sitrep_${Date.now()}`,
                                message: `Mission termin√©e - Toutes les escouades revenues √† la base`,
                                timestamp: new Date().toISOString(),
                                type: 'mission_completion'
                            });
                            
                            saveState();
                            renderMissionList();
                            renderMissionDetail(missionName);
                            renderDashboardMissions();
                            updateStats();
                            
                            showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© automatiquement termin√©e.`);
                        }
                    );
                }, 1000);
            }
        }
        
        // === GESTION DES BASES ET FOB ===
        
        // Fonction pour ouvrir la modal de s√©lection de base
        function openBaseSelection() {
            const baseGrid = document.getElementById('base-list-grid');
            const searchInput = document.getElementById('base-search-input');
            
            if (!config.availableBases) {
                baseGrid.innerHTML = '<p class="text-gray-500 col-span-4">Aucune base disponible dans la configuration.</p>';
                showModal('base-selection-modal');
                return;
            }
            
            function renderBases(basesToShow = config.availableBases) {
                baseGrid.innerHTML = basesToShow.map(baseName => 
                    `<button class="terminal-button base-option bg-slate-800 hover:bg-blue-900/20 border border-slate-600 hover:border-blue-500/50 text-white hover:text-blue-300 p-3 rounded transition-all duration-200" data-base="${baseName}">${baseName}</button>`
                ).join('');
                
                // Ajouter les gestionnaires d'√©v√©nements pour les boutons de base
                baseGrid.querySelectorAll('.base-option').forEach(button => {
                    button.addEventListener('click', function() {
                        const baseName = this.dataset.base;
                        selectBase(baseName);
                    });
                });
            }
            
            renderBases();
            searchInput.value = '';
            
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredBases = config.availableBases.filter(base => 
                    base.toLowerCase().includes(searchTerm)
                );
                renderBases(filteredBases);
            };
            
            showModal('base-selection-modal');
        }
        
        // Fonction pour ouvrir la modal de s√©lection de FOB
        function openFOBSelection() {
            const fobGrid = document.getElementById('fob-list-grid');
            const searchInput = document.getElementById('fob-search-input');
            
            if (!config.availableBases) {
                fobGrid.innerHTML = '<p class="text-gray-500 col-span-4">Aucune FOB disponible dans la configuration.</p>';
                showModal('fob-selection-modal');
                return;
            }
            
            function renderFOBs(fobsToShow = config.availableBases) {
                fobGrid.innerHTML = fobsToShow.map(fobName => 
                    `<button class="terminal-button fob-option bg-slate-800 hover:bg-purple-900/20 border border-slate-600 hover:border-purple-500/50 text-white hover:text-purple-300 p-3 rounded transition-all duration-200" data-fob="${fobName}">${fobName}</button>`
                ).join('');
                
                // Ajouter les gestionnaires d'√©v√©nements pour les boutons de FOB
                fobGrid.querySelectorAll('.fob-option').forEach(button => {
                    button.addEventListener('click', function() {
                        const fobName = this.dataset.fob;
                        selectFOB(fobName);
                    });
                });
            }
            
            renderFOBs();
            searchInput.value = '';
            
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredFOBs = config.availableBases.filter(fob => 
                    fob.toLowerCase().includes(searchTerm)
                );
                renderFOBs(filteredFOBs);
            };
            
            showModal('fob-selection-modal');
        }
        
        // Fonction pour s√©lectionner une base
        function selectBase(baseName) {
            selectedBase = baseName;
            saveData();
            updateBaseAndFOBDisplay();
            hideModal('base-selection-modal');
            showNotification('Base S√©lectionn√©e', `Base principale d√©finie sur: ${baseName}`);
        }
        
        // Fonction pour s√©lectionner une FOB
        function selectFOB(fobName) {
            selectedFOB = fobName;
            saveData();
            updateBaseAndFOBDisplay();
            hideModal('fob-selection-modal');
            showNotification('FOB S√©lectionn√©e', `FOB d√©finie sur: ${fobName}`);
        }
        
        // Fonction pour mettre √† jour l'affichage des bases et FOB
        function updateBaseAndFOBDisplay() {
            const baseDisplay = document.getElementById('selected-base-display');
            const fobDisplay = document.getElementById('selected-fob-display');
            
            if (baseDisplay) {
                baseDisplay.textContent = selectedBase || 'Aucune base s√©lectionn√©e';
                baseDisplay.className = selectedBase ? 'text-blue-300 font-bold text-lg mb-3' : 'text-gray-400 font-bold text-lg mb-3';
            }
            
            if (fobDisplay) {
                fobDisplay.textContent = selectedFOB || 'Aucune FOB s√©lectionn√©e';
                fobDisplay.className = selectedFOB ? 'text-purple-300 font-bold text-lg mb-3' : 'text-gray-400 font-bold text-lg mb-3';
            }
        }
        
        // === INITIALISATION COMPL√àTE ===
        
        // Fonction d'initialisation au chargement de la page
        function initializeApp() {
            console.log('üöÄ Initialisation de l\'application...');
            
            // V√©rifier la pr√©sence de la modal de confirmation
            const modal = document.getElementById('delete-confirmation-modal');
            console.log('üîç Modal de confirmation pr√©sente:', modal ? 'OUI' : 'NON');
            if (modal) {
                console.log('üìã Classes de la modal:', modal.className);
            }
            
            // Charger les donn√©es sauvegard√©es
            loadState();
            
            // Initialiser l'affichage
            renderSquadsList();
            renderDashboardAllSquads();
            renderMissionList();
            renderDashboardMissions();
            updateStats();
            
            // Afficher les d√©tails si une s√©lection existe
            if (selectedSquad) {
                renderSquadDetail();
            }
            if (selectedMission) {
                renderMissionDetail(selectedMission);
            }
            
            // Initialiser le syst√®me de drag & drop
            setupDragAndDrop();
            
            // Ajouter les gestionnaires d'√©v√©nements
            setupEventHandlers();
            
            // Configurer les √©v√©nements de la modal de confirmation
            setupConfirmationModalEvents();
            
            // Afficher l'onglet par d√©faut
            showTab('dashboard');
            
            // Mettre √† jour l'heure
            updateTime();
            setInterval(updateTime, 1000);
            
            console.log('COMMANDEMENT_OS initialis√© avec succ√®s');
        }
        
        // Fonction pour mettre √† jour l'heure
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('current-time').textContent = `${dateString} - ${timeString}`;
        }
        
        // Fonction pour mettre √† jour les statistiques
        function updateStats() {
            const totalSquads = Object.keys(squads).length;
            const activeMissions = Object.values(missions).filter(m => m.status !== 'Termin√©e').length;
            const totalPersonnel = Object.values(squads).reduce((total, squad) => {
                return total + (squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0);
            }, 0);
            
            // Mettre √† jour l'affichage des statistiques dans le dashboard
            const statsContainer = document.querySelector('#dashboard-content .grid');
            if (statsContainer) {
                const statsCards = statsContainer.querySelectorAll('.panel');
                if (statsCards.length >= 3) {
                    // Mettre √† jour les statistiques si les √©l√©ments existent
                    const squadStat = statsCards[0].querySelector('.text-3xl');
                    const missionStat = statsCards[1].querySelector('.text-3xl');
                    const personnelStat = statsCards[2].querySelector('.text-3xl');
                    
                    if (squadStat) squadStat.textContent = totalSquads;
                    if (missionStat) missionStat.textContent = activeMissions;
                    if (personnelStat) personnelStat.textContent = totalPersonnel;
                }
            }
        }
        
        // Gestionnaires d'√©v√©nements pour les objectifs multiples
        document.addEventListener('click', function(e) {
            // Ajouter un nouvel objectif
            if (e.target.matches('#modal-add-objective-btn')) {
                tempObjectives.push({ text: 'Nouvel objectif', status: 'active' });
                renderObjectivesInModal();
            }
            
            // Basculer le statut d'un objectif
            if (e.target.matches('.toggle-objective-status-btn')) {
                const index = parseInt(e.target.dataset.index);
                if (tempObjectives[index]) {
                    tempObjectives[index].status = tempObjectives[index].status === 'active' ? 'completed' : 'active';
                    renderObjectivesInModal();
                }
            }
            
            // Supprimer un objectif
            if (e.target.matches('.delete-objective-btn')) {
                const index = parseInt(e.target.dataset.index);
                if (tempObjectives.length > 1) { // Garder au moins un objectif
                    tempObjectives.splice(index, 1);
                    renderObjectivesInModal();
                } else {
                    showNotification('Erreur', 'Une mission doit avoir au moins un objectif.');
                }
            }
            
            // Clic sur un objectif dans le d√©tail de mission - g√©r√© par setupEventHandlers()
            // (Comment√© pour √©viter les conflits avec la nouvelle modal)
        });
        
        // Gestionnaire pour la mise √† jour du texte des objectifs
        document.addEventListener('input', function(e) {
            if (e.target.matches('.objective-input')) {
                const index = parseInt(e.target.dataset.index);
                if (tempObjectives[index]) {
                    tempObjectives[index].text = e.target.value;
                }
            }
        });
        
        // Gestionnaire d'√©v√©nements pour l'initialisation
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Gestionnaire pour les objectifs multiples dans la cr√©ation de mission
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-objective-btn')) {
                addObjectiveField();
            }
            
            if (e.target.classList.contains('remove-objective-btn')) {
                const objectiveItem = e.target.closest('.objective-item');
                if (objectiveItem) {
                    objectiveItem.remove();
                }
            }
            
            // Gestionnaire pour la validation/√©chec des objectifs dans le d√©tail de mission
            if (e.target.closest('.objective-item') && e.target.closest('#mission-detail-view')) {
                const objectiveItem = e.target.closest('.objective-item');
                const missionName = objectiveItem.dataset.mission;
                const objectiveIndex = parseInt(objectiveItem.dataset.objectiveIndex);
                
                if (missionName && missions[missionName] && missions[missionName].objectives[objectiveIndex]) {
                    openObjectiveStatusModal(missionName, objectiveIndex);
                }
            }
        });
        
        // === WORKFLOW AVANC√â DES R√âPONSES SITREP ===
        
        // Variables globales pour le workflow de r√©ponse
        let currentResponseContext = null;
        
        // Fonction pour ouvrir la modal de r√©ponse position
        function openPositionResponseModal(sitrepId, missionName, squadName) {
            currentResponseContext = {
                sitrepId: sitrepId,
                missionName: missionName,
                squadName: squadName,
                type: 'position'
            };
            
            // R√©initialiser les champs
            document.getElementById('position-latitude').value = '';
            document.getElementById('position-longitude').value = '';
            document.getElementById('position-additional-info').value = '';
            
            showModal('position-response-modal');
        }
        
        // Fonction pour ouvrir la modal de r√©ponse statut
        function openStatusResponseModal(sitrepId, missionName, squadName) {
            currentResponseContext = {
                sitrepId: sitrepId,
                missionName: missionName,
                squadName: squadName,
                type: 'status'
            };
            
            // R√©initialiser les champs
            document.getElementById('status-condition').value = 'operationnel';
            document.getElementById('status-ammo').value = 'plein';
            document.getElementById('status-position').value = '';
            document.getElementById('status-personnel').value = '';
            document.getElementById('status-tactical').value = '';
            document.getElementById('status-additional-info').value = '';
            
            showModal('status-response-modal');
        }
        
        // Fonction pour ouvrir la modal d'ordre d'engagement
        function openEngagementOrderModal(sitrepId, missionName, squadName) {
            currentResponseContext = {
                sitrepId: sitrepId,
                missionName: missionName,
                squadName: squadName,
                type: 'engagement'
            };
            
            // R√©initialiser les champs
            const radios = document.querySelectorAll('input[name="engagement-decision"]');
            radios.forEach(radio => radio.checked = false);
            document.getElementById('engagement-instructions').value = '';
            
            showModal('engagement-order-modal');
        }
        
        // Fonction pour soumettre une r√©ponse de position
        function submitPositionResponse() {
            if (!currentResponseContext) return;
            
            const latitude = document.getElementById('position-latitude').value.trim();
            const longitude = document.getElementById('position-longitude').value.trim();
            const additionalInfo = document.getElementById('position-additional-info').value.trim();
            
            if (!latitude || !longitude) {
                alert('Veuillez saisir au minimum la latitude et la longitude.');
                return;
            }
            
            // Cr√©er la r√©ponse SITREP
            const responseMessage = `R√©ponse Position - Escouade ${currentResponseContext.squadName}:\n` +
                                  `üìç Coordonn√©es: ${latitude}, ${longitude}` +
                                  (additionalInfo ? `\nüí¨ Info: ${additionalInfo}` : '');
            
            createSitrepResponse(responseMessage, 'position_response');
            
            hideModal('position-response-modal');
            currentResponseContext = null;
        }
        
        // Fonction pour soumettre une r√©ponse de statut
        function submitStatusResponse() {
            if (!currentResponseContext) return;
            
            const condition = document.getElementById('status-condition').value;
            const ammo = document.getElementById('status-ammo').value;
            const position = document.getElementById('status-position').value.trim();
            const personnel = document.getElementById('status-personnel').value.trim();
            const tactical = document.getElementById('status-tactical').value.trim();
            const additionalInfo = document.getElementById('status-additional-info').value.trim();
            
            // Cr√©er la r√©ponse SITREP
            let responseMessage = `R√©ponse Statut - Escouade ${currentResponseContext.squadName}:\n`;
            responseMessage += `üìä √âtat: ${condition.charAt(0).toUpperCase() + condition.slice(1)}\n`;
            responseMessage += `üî´ Munitions: ${ammo.charAt(0).toUpperCase() + ammo.slice(1)}`;
            
            if (position) responseMessage += `\nüìç Position: ${position}`;
            if (personnel) responseMessage += `\nüë• Effectif: ${personnel} op√©rateurs`;
            if (tactical) responseMessage += `\n‚öîÔ∏è Situation: ${tactical}`;
            if (additionalInfo) responseMessage += `\nüí¨ Info: ${additionalInfo}`;
            
            createSitrepResponse(responseMessage, 'status_response');
            
            hideModal('status-response-modal');
            currentResponseContext = null;
        }
        
        // Fonction pour soumettre un ordre d'engagement
        function submitEngagementOrder() {
            if (!currentResponseContext) return;
            
            const selectedDecision = document.querySelector('input[name="engagement-decision"]:checked');
            const instructions = document.getElementById('engagement-instructions').value.trim();
            
            if (!selectedDecision) {
                alert('Veuillez s√©lectionner une d√©cision d\'engagement.');
                return;
            }
            
            const decisionLabels = {
                'engage': 'üî• Engager l\'ennemi',
                'no-engage': '‚ö†Ô∏è Ne pas engager',
                'standby': '‚è∏Ô∏è Stand-by',
                'withdraw': 'üîÑ Se replier'
            };
            
            // Cr√©er la r√©ponse SITREP
            let responseMessage = `Ordre d'Engagement - Escouade ${currentResponseContext.squadName}:\n`;
            responseMessage += `‚öîÔ∏è D√©cision: ${decisionLabels[selectedDecision.value]}`;
            
            if (instructions) {
                responseMessage += `\nüìã Instructions: ${instructions}`;
            }
            
            createSitrepResponse(responseMessage, 'engagement_order');
            
            hideModal('engagement-order-modal');
            currentResponseContext = null;
        }
        
        // Fonction pour cr√©er une r√©ponse SITREP
        function createSitrepResponse(message, type) {
            if (!currentResponseContext) return;
            
            const { missionName, squadName } = currentResponseContext;
            const mission = missions[missionName];
            
            if (!mission) return;
            
            // Ajouter la r√©ponse aux SITREP de la mission
            if (!mission.sitreps) {
                mission.sitreps = [];
            }
            
            const responseEntry = {
                id: `sitrep_response_${Date.now()}`,
                message: message,
                timestamp: new Date().toISOString(),
                type: type,
                squadName: squadName,
                priority: 'Normale',
                isResponse: true,
                originalSitrepId: currentResponseContext.sitrepId
            };
            
            mission.sitreps.push(responseEntry);
            
            // Sauvegarder et mettre √† jour l'affichage
            saveState();
            renderMissionDetail(missionName);
            
            // Notification
            const typeLabels = {
                'position_response': 'Position',
                'status_response': 'Statut',
                'engagement_order': 'Ordre d\'Engagement'
            };
            
            showNotification(
                `R√©ponse ${typeLabels[type]} Envoy√©e`,
                `R√©ponse transmise pour l'escouade ${squadName}`
            );
        }
        
        // Fonction pour ajouter un "Stand By" dans l'historique
        function addStandByEntry(missionName, squadName, type = 'squad', originalRequestType = null) {
            const mission = missions[missionName];
            if (!mission) return;
            
            if (!mission.sitreps) {
                mission.sitreps = [];
            }
            
            const standByMessage = type === 'squad' ? 
                `Stand By - Escouade ${squadName} en attente` :
                `Stand By - Commandement en attente de r√©ponse de ${squadName}`;
            
            const standByEntry = {
                id: `sitrep_standby_${Date.now()}`,
                message: standByMessage,
                timestamp: new Date().toISOString(),
                type: 'standby',
                subtype: originalRequestType || 'STANDBY', // Conserver le type de demande originale
                squadName: squadName,
                priority: 'Normale',
                isStandBy: true,
                keepResponseButtons: originalRequestType ? true : false // Flag pour garder les boutons
            };
            
            mission.sitreps.push(standByEntry);
            
            // Sauvegarder et mettre √† jour l'affichage
            saveState();
            renderMissionDetail(missionName);
            
            showNotification('Stand By Ajout√©', standByMessage);
        }
        
        // === WORKFLOW RAPPORT SUR OBJECTIF ===
        
        // Variables globales pour le rapport d'objectif
        let currentObjectiveReportData = {
            missionName: null,
            objectiveIndex: null,
            objectiveText: null
        };
        
        // Fonction pour ouvrir la modal de rapport d'objectif
        function openObjectiveReportModal(missionName, objectiveIndex, objectiveText) {
            currentObjectiveReportData = {
                missionName: missionName,
                objectiveIndex: objectiveIndex,
                objectiveText: objectiveText
            };
            
            // Remplir les informations de base
            document.getElementById('report-mission-name').textContent = missionName;
            document.getElementById('report-objective-text').textContent = objectiveText;
            
            // Remplir la liste des escouades assign√©es √† la mission
            const mission = missions[missionName];
            const squadSelect = document.getElementById('report-squad');
            squadSelect.innerHTML = '<option value="">S√©lectionner une escouade</option>';
            
            if (mission && mission.assignedSquads) {
                mission.assignedSquads.forEach(squadName => {
                    const option = document.createElement('option');
                    option.value = squadName;
                    option.textContent = squadName;
                    squadSelect.appendChild(option);
                });
            }
            
            // D√©finir l'heure actuelle par d√©faut
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('report-timestamp').value = localDateTime;
            
            // R√©initialiser le formulaire
            document.getElementById('report-title').value = '';
            document.getElementById('report-details').value = '';
            document.getElementById('report-coordinates-lat').value = '';
            document.getElementById('report-coordinates-lng').value = '';
            document.getElementById('report-additional-info').value = '';
            
            showModal('objective-report-modal');
        }
        
        // Fonction pour soumettre le rapport d'objectif
        function submitObjectiveReport() {
            const title = document.getElementById('report-title').value.trim();
            const details = document.getElementById('report-details').value.trim();
            const squad = document.getElementById('report-squad').value;
            const timestamp = document.getElementById('report-timestamp').value;
            const lat = document.getElementById('report-coordinates-lat').value.trim();
            const lng = document.getElementById('report-coordinates-lng').value.trim();
            const additionalInfo = document.getElementById('report-additional-info').value.trim();
            
            // Validation des champs obligatoires
            if (!title || !details || !squad) {
                showNotification('Erreur de Validation', 'Veuillez remplir le titre, les d√©tails et s√©lectionner une escouade.');
                return;
            }
            
            const { missionName, objectiveIndex, objectiveText } = currentObjectiveReportData;
            const mission = missions[missionName];
            
            if (!mission || !mission.objectives[objectiveIndex]) {
                showNotification('Erreur', 'Objectif introuvable.');
                return;
            }
            
            // Cr√©er le rapport
            const report = {
                id: `report_${Date.now()}`,
                title: title,
                details: details,
                squad: squad,
                timestamp: timestamp || new Date().toISOString(),
                coordinates: lat && lng ? { lat: lat, lng: lng } : null,
                additionalInfo: additionalInfo,
                createdAt: new Date().toISOString()
            };
            
            // Ajouter le rapport √† l'objectif
            if (!mission.objectives[objectiveIndex].report) {
                mission.objectives[objectiveIndex].report = report;
            }
            
            // Valider l'objectif
            mission.objectives[objectiveIndex].status = 'completed';
            
            // Ajouter une entr√©e dans l'historique SITREP
            if (!mission.sitreps) {
                mission.sitreps = [];
            }
            
            const sitrepEntry = {
                id: `sitrep_objective_${Date.now()}`,
                message: `Objectif atteint - ${objectiveText}`,
                timestamp: report.timestamp,
                type: 'objective_completed',
                subtype: 'OBJECTIF_ATTEINT',
                squadName: squad,
                priority: 'Haute',
                hasReport: true,
                reportId: report.id,
                objectiveIndex: objectiveIndex
            };
            
            mission.sitreps.push(sitrepEntry);
            
            // V√©rifier si tous les objectifs sont termin√©s
            const allObjectivesCompleted = mission.objectives.every(obj => 
                obj.status === 'completed' || obj.status === 'failed'
            );
            
            if (allObjectivesCompleted && mission.status !== 'Termin√©e') {
                // Proposer la terminaison automatique de la mission
                setTimeout(() => {
                    if (confirm(`Tous les objectifs de la mission "${missionName}" sont termin√©s.\n\nVoulez-vous terminer automatiquement la mission ?`)) {
                        mission.status = 'Termin√©e';
                        saveState();
                        renderMissionDetail(missionName);
                        renderMissionList();
                        renderDashboardMissions();
                        updateStats();
                        showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© automatiquement termin√©e.`);
                    }
                }, 1000);
            }
            
            // Sauvegarder et mettre √† jour l'affichage
            saveState();
            renderMissionDetail(missionName);
            renderMissionList();
            renderDashboardMissions();
            updateStats();
            hideModal('objective-report-modal');
            
            showNotification('Rapport Enregistr√©', `Rapport d'objectif cr√©√© et objectif valid√© pour "${objectiveText}".`);
        }
        
        // Fonction pour afficher un rapport d'objectif
        function viewObjectiveReport(missionName, objectiveIndex) {
            const mission = missions[missionName];
            if (!mission || !mission.objectives[objectiveIndex] || !mission.objectives[objectiveIndex].report) {
                showNotification('Erreur', 'Rapport introuvable.');
                return;
            }
            
            const objective = mission.objectives[objectiveIndex];
            const report = objective.report;
            
            // Cr√©er une modal de visualisation du rapport
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-slate-800 p-6 rounded-lg max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                            üìã Rapport d'Objectif - ${objective.text}
                        </h3>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                class="text-gray-400 hover:text-white text-2xl">
                            √ó
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-3 bg-slate-700 rounded-lg">
                            <div class="text-sm text-gray-300">
                                <div><strong>Mission:</strong> ${missionName}</div>
                                <div><strong>Objectif:</strong> ${objective.text}</div>
                                <div><strong>Escouade:</strong> ${report.squad}</div>
                                <div><strong>Date:</strong> ${new Date(report.timestamp).toLocaleString('fr-FR')}</div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-300 mb-2">Titre du Rapport</h4>
                            <div class="p-3 bg-slate-700 rounded text-white">${report.title}</div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-300 mb-2">D√©tails</h4>
                            <div class="p-3 bg-slate-700 rounded text-white whitespace-pre-wrap">${report.details}</div>
                        </div>
                        
                        ${report.coordinates ? `
                            <div>
                                <h4 class="text-sm font-medium text-gray-300 mb-2">Coordonn√©es</h4>
                                <div class="p-3 bg-slate-700 rounded text-white">
                                    Latitude: ${report.coordinates.lat}<br>
                                    Longitude: ${report.coordinates.lng}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${report.additionalInfo ? `
                            <div>
                                <h4 class="text-sm font-medium text-gray-300 mb-2">Informations Compl√©mentaires</h4>
                                <div class="p-3 bg-slate-700 rounded text-white whitespace-pre-wrap">${report.additionalInfo}</div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-end pt-4">
                            <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Fonction pour mettre √† jour l'affichage des boutons de r√©ponse dans l'historique SITREP
        function updateSitrepHistoryWithResponseButtons() {
            // Cette fonction sera appel√©e lors du rendu de l'historique SITREP
            // pour ajouter dynamiquement les boutons de r√©ponse aux demandes du commandement
            const sitrepHistory = document.getElementById('sitrep-history');
            if (!sitrepHistory) return;
            
            // Parcourir tous les SITREP et ajouter les boutons de r√©ponse appropri√©s
            const sitrepEntries = sitrepHistory.querySelectorAll('.sitrep-entry');
            sitrepEntries.forEach(entry => {
                const sitrepType = entry.dataset.sitrepType;
                const sitrepId = entry.dataset.sitrepId;
                const missionName = entry.dataset.missionName;
                const squadName = entry.dataset.squadName;
                
                // Ajouter boutons de r√©ponse pour les demandes du commandement
                if (sitrepType === 'DEMANDER_POSITION' || sitrepType === 'DEMANDER_STATUT') {
                    const responseButtonsContainer = entry.querySelector('.response-buttons');
                    if (responseButtonsContainer && !responseButtonsContainer.hasChildNodes()) {
                        let responseButton = '';
                        let standByButton = `
                            <button onclick="addStandByEntry('${missionName}', '${squadName}', 'squad')" 
                                    class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition-colors">
                                ‚è≥ Stand By
                            </button>
                        `;
                        
                        if (sitrepType === 'DEMANDER_POSITION') {
                            responseButton = `
                                <button onclick="openPositionResponseModal('${sitrepId}', '${missionName}', '${squadName}')" 
                                        class="px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded transition-colors">
                                    üìç R√©ponse
                                </button>
                            `;
                        } else if (sitrepType === 'DEMANDER_STATUT') {
                            responseButton = `
                                <button onclick="openStatusResponseModal('${sitrepId}', '${missionName}', '${squadName}')" 
                                        class="px-2 py-1 bg-teal-600 hover:bg-teal-700 text-white text-xs rounded transition-colors">
                                    üìä R√©ponse
                                </button>
                            `;
                        }
                        
                        responseButtonsContainer.innerHTML = responseButton + standByButton;
                    }
                }
                
                // Ajouter bouton d'ordre d'engagement pour les contacts ennemis
                if (sitrepType === 'CONTACT_ENNEMI') {
                    const responseButtonsContainer = entry.querySelector('.response-buttons');
                    if (responseButtonsContainer && !responseButtonsContainer.hasChildNodes()) {
                        responseButtonsContainer.innerHTML = `
                            <button onclick="openEngagementOrderModal('${sitrepId}', '${missionName}', '${squadName}')" 
                                    class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                                ‚öîÔ∏è Ordre d'Engagement
                            </button>
                            <button onclick="addStandByEntry('${missionName}', '${squadName}', 'command')" 
                                    class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs rounded transition-colors">
                                ‚è≥ Stand By
                            </button>
                        `;
                    }
                }
            });
        }
        
        // === RAPPORT DE SYNTH√àSE MISSION TERMIN√âE ===
        
        // Fonction pour g√©n√©rer et afficher le rapport de synth√®se d'une mission termin√©e
        function showMissionCompletionReport(missionName) {
            const mission = missions[missionName];
            if (!mission) {
                showNotification('Erreur', 'Mission introuvable.');
                return;
            }
            
            // G√©n√©rer le rapport de synth√®se
            const report = generateMissionCompletionReport(mission);
            
            // Cr√©er la modal de rapport de synth√®se
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-lg max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                    <!-- En-t√™te -->
                    <div class="flex justify-between items-center p-6 border-b border-slate-600">
                        <h2 class="text-2xl font-bold text-orange-400 flex items-center gap-3">
                            üìã Rapport de Synth√®se - ${mission.name}
                        </h2>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                class="text-gray-400 hover:text-white text-3xl font-bold">
                            √ó
                        </button>
                    </div>
                    
                    <!-- Contenu scrollable -->
                    <div class="flex-1 overflow-y-auto p-6">
                        ${report}
                    </div>
                    
                    <!-- Pied de page -->
                    <div class="flex justify-between items-center p-6 border-t border-slate-600 bg-slate-900">
                        <div class="text-sm text-gray-400">
                            Rapport g√©n√©r√© le ${new Date().toLocaleString('fr-FR')}
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportMissionReport('${missionName}')" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors">
                                üìÑ Exporter PDF
                            </button>
                            <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Fonction pour g√©n√©rer le contenu HTML du rapport de synth√®se
        function generateMissionCompletionReport(mission) {
            const creationDate = new Date(mission.creationDate).toLocaleString('fr-FR');
            const completionDate = mission.completionDate ? new Date(mission.completionDate).toLocaleString('fr-FR') : 'Non d√©finie';
            
            // Calculer la dur√©e de la mission
            let duration = 'Non calculable';
            if (mission.creationDate && mission.completionDate) {
                const start = new Date(mission.creationDate);
                const end = new Date(mission.completionDate);
                const diffMs = end - start;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                duration = `${diffHours}h ${diffMinutes}min`;
            }
            
            // Statistiques des objectifs
            const completedObjectives = mission.objectives.filter(obj => obj.status === 'completed').length;
            const failedObjectives = mission.objectives.filter(obj => obj.status === 'failed').length;
            const objectivesWithReports = mission.objectives.filter(obj => obj.report).length;
            
            // Statistiques SITREP
            const totalSitreps = mission.sitreps ? mission.sitreps.length : 0;
            const sitrepsByType = {};
            if (mission.sitreps) {
                mission.sitreps.forEach(sitrep => {
                    const type = sitrep.subtype || sitrep.type;
                    sitrepsByType[type] = (sitrepsByType[type] || 0) + 1;
                });
            }
            
            // Informations sur les escouades assign√©es
            const assignedSquadsInfo = mission.assignedSquads.map(squadName => {
                const squad = squads[squadName];
                if (!squad) return { name: squadName, personnel: 0, trades: [] };
                
                const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
                const squadTrades = squad.trades || {};
                
                return {
                    name: squadName,
                    type: squad.type || 'Terrain',
                    personnel: personnelCount,
                    trades: squadTrades,
                    frequency: squad.frequency || SQUAD_FREQUENCIES[squadName] || 'N/A'
                };
            });
            
            return `
                <div class="space-y-8">
                    <!-- Informations G√©n√©rales -->
                    <section class="bg-slate-700 p-6 rounded-lg">
                        <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                            üìä Informations G√©n√©rales
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Secteur</div>
                                <div class="text-lg font-semibold text-white">${mission.sector}</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Cat√©gorie</div>
                                <div class="text-lg font-semibold text-white">${mission.category}</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Difficult√©</div>
                                <div class="text-lg font-semibold text-white">${mission.difficulty}</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Statut Final</div>
                                <div class="text-lg font-semibold text-green-400">${mission.status}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Cr√©ation</div>
                                <div class="text-sm font-semibold text-white">${creationDate}</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Finalisation</div>
                                <div class="text-sm font-semibold text-white">${completionDate}</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded">
                                <div class="text-sm text-gray-400">Dur√©e</div>
                                <div class="text-sm font-semibold text-white">${duration}</div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Escouades Assign√©es -->
                    <section class="bg-slate-700 p-6 rounded-lg">
                        <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                            üë• Escouades Assign√©es (${assignedSquadsInfo.length})
                        </h3>
                        <div class="space-y-4">
                            ${assignedSquadsInfo.map(squadInfo => `
                                <div class="bg-slate-800 p-4 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg font-bold" style="color: ${SQUAD_COLORS[squadInfo.name] || '#ffffff'}">
                                                ${squadInfo.name}
                                            </span>
                                            <span class="px-2 py-1 rounded text-xs bg-cyan-900/20 text-cyan-300">
                                                ${squadInfo.type}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-400">
                                            üë• ${squadInfo.personnel} | üìª ${squadInfo.frequency} MHz
                                        </div>
                                    </div>
                                    
                                    <!-- Trades de l'escouade -->
                                    ${Object.keys(squadInfo.trades).length > 0 ? `
                                        <div class="mt-3">
                                            <div class="text-sm font-medium text-gray-300 mb-2">Sp√©cialit√©s (Trades) :</div>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                ${Object.entries(squadInfo.trades).map(([tradeName, tradeData]) => `
                                                    <div class="bg-slate-900 p-2 rounded text-xs">
                                                        <div class="font-medium text-white">${tradeName}</div>
                                                        <div class="text-gray-400">${tradeData.assigned || 0}/${tradeData.required || 0}</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : '<div class="text-sm text-gray-400 italic">Aucune sp√©cialit√© assign√©e</div>'}
                                </div>
                            `).join('')}
                        </div>
                    </section>
                    
                    <!-- Objectifs et Rapports -->
                    <section class="bg-slate-700 p-6 rounded-lg">
                        <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                            üéØ Objectifs et Rapports
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-900/20 p-4 rounded border border-green-500/30">
                                <div class="text-2xl font-bold text-green-400">${completedObjectives}</div>
                                <div class="text-sm text-green-300">Objectifs Valid√©s</div>
                            </div>
                            <div class="bg-red-900/20 p-4 rounded border border-red-500/30">
                                <div class="text-2xl font-bold text-red-400">${failedObjectives}</div>
                                <div class="text-sm text-red-300">Objectifs √âchou√©s</div>
                            </div>
                            <div class="bg-blue-900/20 p-4 rounded border border-blue-500/30">
                                <div class="text-2xl font-bold text-blue-400">${objectivesWithReports}</div>
                                <div class="text-sm text-blue-300">Rapports G√©n√©r√©s</div>
                            </div>
                        </div>
                        
                        <!-- D√©tail des objectifs -->
                        <div class="space-y-3">
                            ${mission.objectives.map((obj, index) => {
                                const statusIcon = obj.status === 'completed' ? '‚úÖ' : obj.status === 'failed' ? '‚ùå' : '‚è≥';
                                const statusColor = obj.status === 'completed' ? 'text-green-400' : obj.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
                                
                                return `
                                    <div class="bg-slate-800 p-4 rounded-lg">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="text-lg">${statusIcon}</span>
                                                    <span class="font-medium text-white">${obj.text}</span>
                                                    <span class="text-sm px-2 py-1 rounded ${statusColor.replace('text-', 'bg-').replace('-400', '-900/20')} ${statusColor}">
                                                        ${obj.status === 'completed' ? 'VALID√â' : obj.status === 'failed' ? '√âCHEC' : 'EN COURS'}
                                                    </span>
                                                    ${obj.requiresReport ? '<span class="text-xs px-2 py-1 bg-blue-900/20 text-blue-300 rounded">üìã Rapport requis</span>' : ''}
                                                </div>
                                                
                                                ${obj.report ? `
                                                    <div class="mt-3 p-3 bg-slate-900 rounded border-l-4 border-green-500">
                                                        <div class="text-sm font-medium text-green-400 mb-2">üìã Rapport d'Objectif</div>
                                                        <div class="text-sm text-gray-300 mb-2">
                                                            <strong>Titre:</strong> ${obj.report.title}
                                                        </div>
                                                        <div class="text-sm text-gray-300 mb-2">
                                                            <strong>Escouade:</strong> ${obj.report.squad} | 
                                                            <strong>Date:</strong> ${new Date(obj.report.timestamp).toLocaleString('fr-FR')}
                                                        </div>
                                                        ${obj.report.coordinates ? `
                                                            <div class="text-sm text-gray-300 mb-2">
                                                                <strong>Coordonn√©es:</strong> ${obj.report.coordinates.lat}, ${obj.report.coordinates.lng}
                                                            </div>
                                                        ` : ''}
                                                        <div class="text-sm text-gray-300 bg-slate-800 p-2 rounded mt-2">
                                                            <strong>D√©tails:</strong><br>
                                                            <div class="whitespace-pre-wrap">${obj.report.details}</div>
                                                        </div>
                                                        ${obj.report.additionalInfo ? `
                                                            <div class="text-sm text-gray-300 bg-slate-800 p-2 rounded mt-2">
                                                                <strong>Informations suppl√©mentaires:</strong><br>
                                                                <div class="whitespace-pre-wrap">${obj.report.additionalInfo}</div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </section>
                    
                    <!-- Historique SITREP -->
                    <section class="bg-slate-700 p-6 rounded-lg">
                        <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                            üì° Historique SITREP (${totalSitreps} entr√©es)
                        </h3>
                        
                        <!-- Statistiques SITREP -->
                        ${Object.keys(sitrepsByType).length > 0 ? `
                            <div class="mb-6">
                                <div class="text-sm font-medium text-gray-300 mb-3">R√©partition par type :</div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    ${Object.entries(sitrepsByType).map(([type, count]) => `
                                        <div class="bg-slate-800 p-2 rounded text-center">
                                            <div class="text-lg font-bold text-white">${count}</div>
                                            <div class="text-xs text-gray-400">${type}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Chronologie compl√®te -->
                        ${mission.sitreps && mission.sitreps.length > 0 ? `
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${mission.sitreps.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).map(sitrep => {
                                    const sitrepTime = new Date(sitrep.timestamp).toLocaleString('fr-FR');
                                    const priorityColor = {
                                        'Haute': 'text-red-400',
                                        'Normale': 'text-blue-400',
                                        'Basse': 'text-gray-400'
                                    }[sitrep.priority] || 'text-gray-400';
                                    
                                    return `
                                        <div class="bg-slate-800 p-3 rounded border-l-4 border-blue-500/50">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="text-sm font-medium text-white">${sitrep.squadName || 'Commandement'}</span>
                                                        <span class="text-xs px-2 py-1 rounded bg-slate-700 text-gray-300">${sitrep.subtype || sitrep.type}</span>
                                                        <span class="text-xs px-2 py-1 rounded ${priorityColor.replace('text-', 'bg-').replace('-400', '-900/20')} ${priorityColor}">
                                                            ${sitrep.priority}
                                                        </span>
                                                    </div>
                                                    <div class="text-sm text-gray-300">${sitrep.message}</div>
                                                </div>
                                                <div class="text-xs text-gray-400 ml-4">${sitrepTime}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<div class="text-gray-400 italic">Aucun SITREP enregistr√©</div>'}
                    </section>
                    
                    <!-- Demandes de Renfort -->
                    ${mission.reinforcementRequests && mission.reinforcementRequests.length > 0 ? `
                        <section class="bg-slate-700 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                                üöÅ Demandes de Renfort (${mission.reinforcementRequests.length})
                            </h3>
                            <div class="space-y-3">
                                ${mission.reinforcementRequests.map(request => `
                                    <div class="bg-slate-800 p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-medium text-white">${request.type}</span>
                                            <span class="text-xs px-2 py-1 rounded ${
                                                request.status === 'approved' ? 'bg-green-900/20 text-green-400' :
                                                request.status === 'denied' ? 'bg-red-900/20 text-red-400' :
                                                'bg-yellow-900/20 text-yellow-400'
                                            }">
                                                ${request.status === 'approved' ? 'APPROUV√â' : request.status === 'denied' ? 'REFUS√â' : 'EN ATTENTE'}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-300">
                                            <div><strong>Demandeur:</strong> ${request.requestingSquad}</div>
                                            <div><strong>Date:</strong> ${new Date(request.timestamp).toLocaleString('fr-FR')}</div>
                                            ${request.reason ? `<div><strong>Raison:</strong> ${request.reason}</div>` : ''}
                                            ${request.assignedSquad ? `<div><strong>Escouade assign√©e:</strong> ${request.assignedSquad}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}
                    
                    <!-- Demandes d'√âvacuation -->
                    ${mission.evacRequests && mission.evacRequests.length > 0 ? `
                        <section class="bg-slate-700 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4 flex items-center gap-2">
                                üöë Demandes d'√âvacuation (${mission.evacRequests.length})
                            </h3>
                            <div class="space-y-3">
                                ${mission.evacRequests.map(request => `
                                    <div class="bg-slate-800 p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-medium text-white">${request.type || '√âvacuation'}</span>
                                            <span class="text-xs px-2 py-1 rounded ${
                                                request.status === 'completed' ? 'bg-green-900/20 text-green-400' :
                                                request.status === 'cancelled' ? 'bg-red-900/20 text-red-400' :
                                                'bg-yellow-900/20 text-yellow-400'
                                            }">
                                                ${request.status === 'completed' ? 'TERMIN√â' : request.status === 'cancelled' ? 'ANNUL√â' : 'EN COURS'}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-300">
                                            <div><strong>Escouade:</strong> ${request.squadName}</div>
                                            <div><strong>Date:</strong> ${new Date(request.timestamp).toLocaleString('fr-FR')}</div>
                                            ${request.reason ? `<div><strong>Raison:</strong> ${request.reason}</div>` : ''}
                                            ${request.coordinates ? `<div><strong>Coordonn√©es:</strong> ${request.coordinates.lat}, ${request.coordinates.lng}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}
                </div>
            `;
        }
        
        // Fonction pour g√©n√©rer et t√©l√©charger un prompt ChatGPT pour rapport militaire
        function exportMissionReport(missionName) {
            const mission = missions[missionName];
            if (!mission) {
                showNotification('Erreur', 'Mission introuvable.');
                return;
            }
            
            try {
                // Construire le prompt ChatGPT structur√©
                let prompt = `Tu es un officier d'√©tat-major charg√© de r√©diger un rapport de mission militaire officiel. Voici les donn√©es brutes d'une mission tactique que tu dois transformer en rapport militaire professionnel au format fran√ßais.

`;
                
                prompt += `**CONSIGNES DE R√âDACTION :**
`;
                prompt += `- R√©dige un rapport militaire officiel en fran√ßais
`;
                prompt += `- Utilise un style formel et professionnel
`;
                prompt += `- Structure le rapport selon les standards militaires fran√ßais
`;
                prompt += `- Inclus des recommandations tactiques si pertinentes
`;
                prompt += `- Utilise la terminologie militaire appropri√©e
`;
                prompt += `- Formate le document avec des sections claires
\n`;
                
                prompt += `**DONN√âES DE MISSION √Ä TRAITER :**\n\n`;
                
                // INFORMATIONS G√âN√âRALES
                prompt += `**INFORMATIONS G√âN√âRALES :**\n`;
                prompt += `- Nom de mission : ${mission.name}\n`;
                prompt += `- Secteur d'op√©ration : ${mission.sector}\n`;
                prompt += `- Cat√©gorie : ${mission.category}\n`;
                prompt += `- Niveau de difficult√© : ${mission.difficulty}\n`;
                prompt += `- Statut final : ${mission.status}\n`;
                prompt += `- Date de d√©but : ${new Date(mission.creationDate).toLocaleString('fr-FR')}\n`;
                
                if (mission.completionDate) {
                    prompt += `- Date de fin : ${new Date(mission.completionDate).toLocaleString('fr-FR')}\n`;
                    const duration = Math.round((new Date(mission.completionDate) - new Date(mission.creationDate)) / (1000 * 60 * 60));
                    prompt += `- Dur√©e totale : ${duration} heures\n`;
                    if (mission.completionReason) {
                        prompt += `- Raison de terminaison : ${mission.completionReason}\n`;
                    }
                }
                prompt += `\n`;
                
                // FORCES ENGAG√âES
                if (mission.assignedSquads && mission.assignedSquads.length > 0) {
                    prompt += `**FORCES ENGAG√âES :**\n`;
                    mission.assignedSquads.forEach(squadName => {
                        const squad = squads[squadName];
                        prompt += `- Escouade ${squadName}\n`;
                        
                        if (squad) {
                            const personnelCount = squad.personnel ? squad.personnel.filter(p => p.name && p.name.trim()).length : 0;
                            prompt += `  * Effectif : ${personnelCount} membres\n`;
                            
                            if (squad.frequency) {
                                prompt += `  * Fr√©quence radio : ${squad.frequency}\n`;
                            }
                            
                            // Sp√©cialit√©s/Trades
                            const tradeStats = {};
                            if (squad.personnel) {
                                squad.personnel.forEach(member => {
                                    if (member.role && TRADES[member.role]) {
                                        tradeStats[member.role] = (tradeStats[member.role] || 0) + 1;
                                    }
                                });
                            }
                            
                            if (Object.keys(tradeStats).length > 0) {
                                prompt += `  * Sp√©cialit√©s disponibles : `;
                                const tradesText = Object.entries(tradeStats)
                                    .map(([trade, count]) => `${TRADES[trade]?.name || trade} (${count})`)
                                    .join(', ');
                                prompt += `${tradesText}\n`;
                            }
                        }
                    });
                    prompt += `\n`;
                }
                
                // OBJECTIFS DE MISSION
                prompt += `**OBJECTIFS DE MISSION :**\n`;
                const completedObjectives = mission.objectives.filter(obj => obj.status === 'completed').length;
                const failedObjectives = mission.objectives.filter(obj => obj.status === 'failed').length;
                const pendingObjectives = mission.objectives.length - completedObjectives - failedObjectives;
                const reportedObjectives = mission.objectives.filter(obj => obj.report).length;
                
                prompt += `- Total : ${mission.objectives.length} objectifs\n`;
                prompt += `- R√©alis√©s : ${completedObjectives}\n`;
                prompt += `- √âchou√©s : ${failedObjectives}\n`;
                prompt += `- En cours : ${pendingObjectives}\n`;
                prompt += `- Avec rapport d√©taill√© : ${reportedObjectives}\n\n`;
                
                prompt += `**D√âTAIL DES OBJECTIFS :**\n`;
                mission.objectives.forEach((obj, index) => {
                    const statusText = obj.status === 'completed' ? 'R√âALIS√â' : 
                                      obj.status === 'failed' ? '√âCHOU√â' : 'EN COURS';
                    
                    prompt += `${index + 1}. ${obj.text} - Statut: ${statusText}\n`;
                    
                    if (obj.report) {
                        prompt += `   ‚Üí Rapport associ√©: "${obj.report.title}"\n`;
                        if (obj.report.description) {
                            prompt += `   ‚Üí D√©tails: ${obj.report.description}\n`;
                        }
                        if (obj.report.squad) {
                            prompt += `   ‚Üí Escouade rapporteur: ${obj.report.squad}\n`;
                        }
                        if (obj.report.coordinates) {
                            prompt += `   ‚Üí Coordonn√©es: ${obj.report.coordinates.lat}, ${obj.report.coordinates.lng}\n`;
                        }
                    }
                });
                prompt += `\n`;
                
                // CHRONOLOGIE OP√âRATIONNELLE (SITREP)
                if (mission.sitreps && mission.sitreps.length > 0) {
                    prompt += `**CHRONOLOGIE OP√âRATIONNELLE :**\n`;
                    
                    // Statistiques SITREP
                    const sitrepTypes = {};
                    mission.sitreps.forEach(sitrep => {
                        const type = sitrep.subtype || sitrep.type || 'Autre';
                        sitrepTypes[type] = (sitrepTypes[type] || 0) + 1;
                    });
                    
                    prompt += `- Total des rapports de situation : ${mission.sitreps.length}\n`;
                    Object.entries(sitrepTypes).forEach(([type, count]) => {
                        prompt += `- ${type} : ${count} rapports\n`;
                    });
                    prompt += `\n`;
                    
                    // √âv√©nements chronologiques (15 plus r√©cents)
                    prompt += `**√âV√âNEMENTS MARQUANTS (15 plus r√©cents) :**\n`;
                    const recentSitreps = mission.sitreps
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .slice(0, 15);
                    
                    recentSitreps.reverse().forEach((sitrep, index) => {
                        const date = new Date(sitrep.timestamp).toLocaleString('fr-FR');
                        const squad = sitrep.squadName || 'COMMANDEMENT';
                        const priority = sitrep.priority || 'Normale';
                        
                        prompt += `${index + 1}. [${date}] ${squad} (Priorit√©: ${priority})\n`;
                        prompt += `   ‚Üí ${sitrep.message}\n`;
                        
                        if (sitrep.coordinates) {
                            prompt += `   ‚Üí Position: ${sitrep.coordinates}\n`;
                        }
                        if (sitrep.additionalInfo) {
                            prompt += `   ‚Üí Informations: ${sitrep.additionalInfo}\n`;
                        }
                    });
                    prompt += `\n`;
                }
                
                // DEMANDES SP√âCIALES
                if ((mission.reinforcementRequests && mission.reinforcementRequests.length > 0) || 
                    (mission.evacRequests && mission.evacRequests.length > 0)) {
                    
                    prompt += `**DEMANDES SP√âCIALES :**\n`;
                    
                    if (mission.reinforcementRequests && mission.reinforcementRequests.length > 0) {
                        prompt += `\n**Demandes de renfort (${mission.reinforcementRequests.length}) :**\n`;
                        mission.reinforcementRequests.forEach((request, index) => {
                            const status = request.status === 'approved' ? 'APPROUV√âE' : 
                                          request.status === 'denied' ? 'REFUS√âE' : 'EN ATTENTE';
                            prompt += `${index + 1}. Type: ${request.type} - Statut: ${status}\n`;
                            prompt += `   ‚Üí Demandeur: ${request.requestingSquad}\n`;
                            prompt += `   ‚Üí Date: ${new Date(request.timestamp).toLocaleString('fr-FR')}\n`;
                            if (request.reason) {
                                prompt += `   ‚Üí Justification: ${request.reason}\n`;
                            }
                            if (request.assignedSquad) {
                                prompt += `   ‚Üí Escouade assign√©e: ${request.assignedSquad}\n`;
                            }
                        });
                    }
                    
                    if (mission.evacRequests && mission.evacRequests.length > 0) {
                        prompt += `\n**Demandes d'√©vacuation (${mission.evacRequests.length}) :**\n`;
                        mission.evacRequests.forEach((request, index) => {
                            const status = request.status === 'completed' ? 'TERMIN√âE' : 
                                          request.status === 'cancelled' ? 'ANNUL√âE' : 'EN COURS';
                            prompt += `${index + 1}. Type: ${request.type || '√âvacuation'} - Statut: ${status}\n`;
                            prompt += `   ‚Üí Date: ${new Date(request.timestamp).toLocaleString('fr-FR')}\n`;
                            if (request.reason) {
                                prompt += `   ‚Üí Motif: ${request.reason}\n`;
                            }
                        });
                    }
                    prompt += `\n`;
                }
                
                // INSTRUCTIONS FINALES
                prompt += `**INSTRUCTIONS DE R√âDACTION :**\n`;
                prompt += `Transforme ces donn√©es brutes en un rapport militaire officiel fran√ßais comprenant :\n`;
                prompt += `1. EN-T√äTE avec classification et r√©f√©rences\n`;
                prompt += `2. R√âSUM√â EX√âCUTIF\n`;
                prompt += `3. CONTEXTE ET MISSION\n`;
                prompt += `4. FORCES ENGAG√âES\n`;
                prompt += `5. D√âROULEMENT DES OP√âRATIONS\n`;
                prompt += `6. R√âSULTATS ET BILAN\n`;
                prompt += `7. ENSEIGNEMENTS ET RECOMMANDATIONS\n`;
                prompt += `8. CONCLUSION\n\n`;
                
                prompt += `Utilise un style militaire professionnel avec la terminologie appropri√©e. Le rapport doit √™tre r√©aliste et cr√©dible.`;
                
                // Cr√©er et t√©l√©charger le fichier prompt
                const blob = new Blob([prompt], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                const fileName = `Prompt_ChatGPT_Mission_${mission.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Prompt G√©n√©r√©', `Prompt ChatGPT t√©l√©charg√© avec succ√®s : ${fileName}`);
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du prompt:', error);
                showNotification('Erreur Export', 'Erreur lors de la g√©n√©ration du prompt. V√©rifiez la console pour plus de d√©tails.');
            }
        }
        
        // Fonction utilitaire pour terminer une mission avec enregistrement de la date
        function completeMission(missionName, reason = 'Mission termin√©e') {
            const mission = missions[missionName];
            if (!mission) {
                showNotification('Erreur', 'Mission introuvable.');
                return false;
            }
            
            // Enregistrer le statut et la date de finalisation
            mission.status = 'Termin√©e';
            mission.completionDate = new Date().toISOString();
            mission.completionReason = reason;
            
            // Ajouter une entr√©e SITREP de finalisation
            if (!mission.sitreps) {
                mission.sitreps = [];
            }
            
            const completionSitrep = {
                id: `sitrep_completion_${Date.now()}`,
                message: `Mission termin√©e - ${reason}`,
                timestamp: mission.completionDate,
                type: 'mission_completion',
                subtype: 'MISSION_TERMINEE',
                squadName: 'Commandement',
                priority: 'Haute'
            };
            
            mission.sitreps.push(completionSitrep);
            
            // Sauvegarder et mettre √† jour l'affichage
            saveState();
            renderMissionDetail(missionName);
            renderMissionList();
            renderDashboardMissions();
            updateStats();
            
            return true;
        }
        
        // Fonction pour terminer manuellement une mission
        function manualCompleteMission(missionName) {
            if (!missions[missionName]) {
                showNotification('Erreur', 'Mission introuvable.');
                return;
            }
            
            const mission = missions[missionName];
            
            // V√©rifier si la mission peut √™tre termin√©e
            if (mission.status === 'Termin√©e') {
                showNotification('Information', 'Cette mission est d√©j√† termin√©e.');
                return;
            }
            
            // Demander confirmation
            const confirmation = confirm(
                `Voulez-vous vraiment terminer manuellement la mission "${missionName}" ?\n\n` +
                `Cette action marquera la mission comme termin√©e et g√©n√©rera un rapport de synth√®se complet.\n\n` +
                `Objectifs actuels :\n` +
                `‚Ä¢ Valid√©s : ${mission.objectives.filter(obj => obj.status === 'completed').length}\n` +
                `‚Ä¢ √âchou√©s : ${mission.objectives.filter(obj => obj.status === 'failed').length}\n` +
                `‚Ä¢ En cours : ${mission.objectives.filter(obj => obj.status !== 'completed' && obj.status !== 'failed').length}`
            );
            
            if (confirmation) {
                if (completeMission(missionName, 'Terminaison manuelle par le commandement')) {
                    showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© termin√©e manuellement.`);
                }
            }
        }
        
        // === GESTIONNAIRES D'√âV√âNEMENTS POUR LES OBJECTIFS ===
        
        // Gestionnaire d'√©v√©nements pour les clics sur les objectifs
        document.addEventListener('click', function(e) {
            // Gestion des clics sur les objectifs
            if (e.target.closest('.objective-item')) {
                const objectiveItem = e.target.closest('.objective-item');
                const missionName = objectiveItem.dataset.mission;
                const objectiveIndex = parseInt(objectiveItem.dataset.objectiveIndex);
                
                if (!missions[missionName] || !missions[missionName].objectives[objectiveIndex]) {
                    return;
                }
                
                const mission = missions[missionName];
                const objective = mission.objectives[objectiveIndex];
                
                // Si l'objectif a d√©j√† un rapport, l'afficher
                if (objective.report) {
                    viewObjectiveReport(missionName, objectiveIndex);
                    return;
                }
                
                // Si l'objectif est d√©j√† termin√© (valid√© ou √©chou√©), permettre de le modifier
                if (objective.status === 'completed' || objective.status === 'failed') {
                    openObjectiveStatusModal(missionName, objectiveIndex, objective.text);
                    return;
                }
                
                // Si l'objectif n√©cessite un rapport, ouvrir directement la modal de rapport
                if (objective.requiresReport) {
                    openObjectiveReportModal(missionName, objectiveIndex, objective.text);
                } else {
                    // Sinon, ouvrir la modal de statut classique
                    openObjectiveStatusModal(missionName, objectiveIndex, objective.text);
                }
            }
            
            // Gestion des clics sur les entr√©es SITREP avec rapport
            if (e.target.closest('[data-action="view-report"]')) {
                const reportButton = e.target.closest('[data-action="view-report"]');
                const missionName = reportButton.dataset.mission;
                const objectiveIndex = parseInt(reportButton.dataset.objectiveIndex);
                
                viewObjectiveReport(missionName, objectiveIndex);
                e.preventDefault();
                e.stopPropagation();
            }
        });
        
        // Fonction pour ouvrir la modal de statut d'objectif (version classique sans rapport)
        function openObjectiveStatusModal(missionName, objectiveIndex, objectiveText) {
            // Cr√©er une modal simple pour valider/√©chouer l'objectif
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-slate-800 p-6 rounded-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white">
                            üéØ Statut de l'Objectif
                        </h3>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                class="text-gray-400 hover:text-white text-2xl">
                            √ó
                        </button>
                    </div>
                    
                    <div class="mb-4 p-3 bg-slate-700 rounded-lg">
                        <div class="text-sm text-gray-300">
                            <div><strong>Mission:</strong> ${missionName}</div>
                            <div><strong>Objectif:</strong> ${objectiveText}</div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-300 mb-6">
                        Choisissez le nouveau statut pour cet objectif :
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="updateObjectiveStatus('${missionName}', ${objectiveIndex}, 'completed'); document.body.removeChild(this.closest('.fixed'))" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                            ‚úì Valid√©
                        </button>
                        <button onclick="updateObjectiveStatus('${missionName}', ${objectiveIndex}, 'failed'); document.body.removeChild(this.closest('.fixed'))" 
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors">
                            ‚úó √âchec
                        </button>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">
                            Annuler
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Fonction pour mettre √† jour le statut d'un objectif (version classique)
        function updateObjectiveStatus(missionName, objectiveIndex, newStatus) {
            const mission = missions[missionName];
            if (!mission || !mission.objectives[objectiveIndex]) {
                showNotification('Erreur', 'Objectif introuvable.');
                return;
            }
            
            const objective = mission.objectives[objectiveIndex];
            const oldStatus = objective.status;
            objective.status = newStatus;
            
            // Ajouter une entr√©e dans l'historique SITREP
            if (!mission.sitreps) {
                mission.sitreps = [];
            }
            
            const statusText = newStatus === 'completed' ? 'atteint' : '√©chou√©';
            const sitrepEntry = {
                id: `sitrep_objective_${Date.now()}`,
                message: `Objectif ${statusText} - ${objective.text}`,
                timestamp: new Date().toISOString(),
                type: 'objective_status',
                subtype: newStatus === 'completed' ? 'OBJECTIF_ATTEINT' : 'OBJECTIF_ECHEC',
                squadName: 'Commandement',
                priority: 'Normale',
                hasReport: false
            };
            
            mission.sitreps.push(sitrepEntry);
            
            // V√©rifier si tous les objectifs sont termin√©s
            const allObjectivesCompleted = mission.objectives.every(obj => 
                obj.status === 'completed' || obj.status === 'failed'
            );
            
            if (allObjectivesCompleted && mission.status !== 'Termin√©e') {
                // Proposer la terminaison automatique de la mission
                setTimeout(() => {
                    if (confirm(`Tous les objectifs de la mission "${missionName}" sont termin√©s.\n\nVoulez-vous terminer automatiquement la mission ?`)) {
                        mission.status = 'Termin√©e';
                        saveState();
                        renderMissionDetail(missionName);
                        renderMissionList();
                        renderDashboardMissions();
                        updateStats();
                        showNotification('Mission Termin√©e', `La mission "${missionName}" a √©t√© automatiquement termin√©e.`);
                    }
                }, 1000);
            }
            
            // Sauvegarder et mettre √† jour l'affichage
            saveState();
            renderMissionDetail(missionName);
            renderMissionList();
            renderDashboardMissions();
            updateStats();
            
            const statusLabel = newStatus === 'completed' ? 'valid√©' : 'marqu√© comme √©chou√©';
            showNotification('Objectif Mis √† Jour', `L'objectif "${objective.text}" a √©t√© ${statusLabel}.`);
        }
        
        // Sauvegarde automatique p√©riodique
        setInterval(saveState, 30000); // Sauvegarde toutes les 30 secondes
        
        // Sauvegarde avant fermeture de la page
        window.addEventListener('beforeunload', saveState);
        
        // === iOS SPECIFIC ENHANCEMENTS ===
        
        // D√©tection iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                     (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        
        if (isIOS) {
            console.log('üçé iOS d√©tect√© - Application des am√©liorations iOS');
            
            // Fix pour le viewport iOS
            function fixIOSViewport() {
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover'
                    );
                }
            }
            
            // Pr√©venir le zoom iOS sur les inputs
            function preventIOSZoom() {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.style.fontSize === '' || parseFloat(input.style.fontSize) < 16) {
                        input.style.fontSize = '16px';
                    }
                });
            }
            
            // Am√©liorer les interactions tactiles
            function enhanceTouchInteractions() {
                // Ajouter des √©v√©nements tactiles pour les boutons
                document.addEventListener('touchstart', function(e) {
                    if (e.target.classList.contains('terminal-button') || 
                        e.target.classList.contains('list-item')) {
                        e.target.style.transform = 'scale(0.98)';
                        e.target.style.opacity = '0.8';
                    }
                }, { passive: true });
                
                document.addEventListener('touchend', function(e) {
                    if (e.target.classList.contains('terminal-button') || 
                        e.target.classList.contains('list-item')) {
                        setTimeout(() => {
                            e.target.style.transform = '';
                            e.target.style.opacity = '';
                        }, 150);
                    }
                }, { passive: true });
            }
            
            // Fix pour les modales iOS
            function fixIOSModals() {
                const originalShowModal = window.showModal;
                window.showModal = function(modalId) {
                    originalShowModal(modalId);
                    
                    // Pr√©venir le scroll du body quand une modal est ouverte
                    document.body.style.position = 'fixed';
                    document.body.style.top = `-${window.scrollY}px`;
                    document.body.style.width = '100%';
                };
                
                const originalHideModal = window.hideModal;
                window.hideModal = function(modalId) {
                    const scrollY = document.body.style.top;
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.width = '';
                    
                    if (scrollY) {
                        window.scrollTo(0, parseInt(scrollY || '0') * -1);
                    }
                    
                    originalHideModal(modalId);
                };
            }
            
            // Am√©liorer le scrolling iOS
            function enhanceIOSScrolling() {
                const scrollableElements = document.querySelectorAll('.overflow-y-auto, .modal-panel');
                scrollableElements.forEach(element => {
                    element.style.webkitOverflowScrolling = 'touch';
                });
            }
            
            // Fix pour les inputs iOS qui perdent le focus
            function fixIOSInputFocus() {
                document.addEventListener('focusout', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        // Petit d√©lai pour permettre √† iOS de repositionner le viewport
                        setTimeout(() => {
                            window.scrollTo(0, 0);
                        }, 100);
                    }
                });
            }
            
            // G√©rer l'orientation iOS
            function handleIOSOrientation() {
                window.addEventListener('orientationchange', function() {
                    setTimeout(() => {
                        fixIOSViewport();
                        preventIOSZoom();
                        enhanceIOSScrolling();
                    }, 500);
                });
            }
            
            // Appliquer toutes les am√©liorations iOS
            document.addEventListener('DOMContentLoaded', function() {
                fixIOSViewport();
                preventIOSZoom();
                enhanceTouchInteractions();
                fixIOSModals();
                enhanceIOSScrolling();
                fixIOSInputFocus();
                handleIOSOrientation();
                
                console.log('‚úÖ Am√©liorations iOS appliqu√©es avec succ√®s');
            });
            
            // Observer pour les nouveaux √©l√©ments ajout√©s dynamiquement
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Appliquer les fixes aux nouveaux √©l√©ments
                                const newInputs = node.querySelectorAll('input, select, textarea');
                                newInputs.forEach(input => {
                                    if (input.style.fontSize === '' || parseFloat(input.style.fontSize) < 16) {
                                        input.style.fontSize = '16px';
                                    }
                                });
                                
                                const newScrollables = node.querySelectorAll('.overflow-y-auto, .modal-panel');
                                newScrollables.forEach(element => {
                                    element.style.webkitOverflowScrolling = 'touch';
                                });
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    </script>
    
    <!-- Modal de Confirmation de Suppression -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl border border-slate-600 w-full max-w-md mx-4">
            <div class="p-6">
                <!-- En-t√™te -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-red-900/20 rounded-full flex items-center justify-center">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-red-400">Confirmer la Suppression</h3>
                        <p class="text-sm text-gray-400">Cette action est irr√©versible</p>
                    </div>
                </div>
                
                <!-- Message -->
                <div class="mb-6">
                    <p id="delete-confirmation-message" class="text-gray-300 leading-relaxed">
                        √ätes-vous s√ªr de vouloir supprimer cette mission ?
                    </p>
                </div>
                
                <!-- Boutons -->
                <div class="flex gap-3 justify-end">
                    <button id="delete-cancel-btn" 
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-gray-300 hover:text-white rounded-lg border border-slate-600 hover:border-slate-500 transition-all duration-200">
                        Annuler
                    </button>
                    <button id="delete-confirm-btn" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg border border-red-500 hover:border-red-400 transition-all duration-200 font-medium">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de s√©lection de Base Principale -->
    <div id="base-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-600 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-600">
                <h3 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                    üè≠ S√©lectionner Base Principale
                </h3>
                <button onclick="hideModal('base-selection-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <input type="text" id="base-search-input" placeholder="Rechercher une base..." 
                           class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                </div>
                <div id="base-list-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-96 overflow-y-auto">
                    <!-- Les bases seront ajout√©es dynamiquement ici -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de s√©lection de FOB -->
    <div id="fob-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-600 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-600">
                <h3 class="text-xl font-bold text-purple-400 flex items-center gap-2">
                    üè¢ S√©lectionner FOB
                </h3>
                <button onclick="hideModal('fob-selection-modal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <input type="text" id="fob-search-input" placeholder="Rechercher une FOB..." 
                           class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none">
                </div>
                <div id="fob-list-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-96 overflow-y-auto">
                    <!-- Les FOB seront ajout√©es dynamiquement ici -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de S√©lection d'Escouade pour Chronologie -->
    <div id="chronology-squad-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">S√©lectionner l'Escouade</h3>
            <div id="chronology-squad-list" class="space-y-2 mb-4">
                <!-- Les escouades seront ajout√©es dynamiquement -->
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="hideModal('chronology-squad-selection-modal')" 
                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de R√©ponse Position -->
    <div id="position-response-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">üìç R√©ponse - Position</h3>
            <form id="position-response-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Latitude</label>
                        <input type="text" id="position-latitude" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Ex: 48.8566">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Longitude</label>
                        <input type="text" id="position-longitude" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Ex: 2.3522">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Informations Suppl√©mentaires (optionnel)</label>
                    <textarea id="position-additional-info" rows="3" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Contexte, situation tactique, points de rep√®re..."></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="hideModal('position-response-modal')" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="submitPositionResponse()" 
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors">
                        üìç Envoyer Position
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de R√©ponse Statut -->
    <div id="status-response-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-2xl w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">üìä R√©ponse - Statut</h3>
            <form id="status-response-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">√âtat G√©n√©ral</label>
                        <select id="status-condition" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                            <option value="operationnel">Op√©rationnel</option>
                            <option value="degrade">D√©grad√©</option>
                            <option value="critique">Critique</option>
                            <option value="hors_combat">Hors Combat</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Niveau Munitions</label>
                        <select id="status-ammo" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                            <option value="plein">Plein (80-100%)</option>
                            <option value="correct">Correct (60-80%)</option>
                            <option value="faible">Faible (30-60%)</option>
                            <option value="critique">Critique (<30%)</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Position Actuelle</label>
                        <input type="text" id="status-position" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Ex: Sur objectif, En route, Base...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Effectif Op√©rationnel</label>
                        <input type="number" id="status-personnel" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Nombre d'op√©rateurs actifs">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Situation Tactique</label>
                    <textarea id="status-tactical" rows="2" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Menaces, obstacles, opportunit√©s..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Informations Suppl√©mentaires (optionnel)</label>
                    <textarea id="status-additional-info" rows="3" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="D√©tails compl√©mentaires, besoins sp√©cifiques..."></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="hideModal('status-response-modal')" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="submitStatusResponse()" 
                            class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded transition-colors">
                        üìä Envoyer Statut
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal d'Ordre d'Engagement -->
    <div id="engagement-order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">‚öîÔ∏è Ordre d'Engagement</h3>
            <form id="engagement-order-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">D√©cision d'Engagement</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="engagement-decision" value="engage" class="text-red-500">
                            <span class="text-red-400">üî• Engager l'ennemi</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="engagement-decision" value="no-engage" class="text-yellow-500">
                            <span class="text-yellow-400">‚ö†Ô∏è Ne pas engager</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="engagement-decision" value="standby" class="text-blue-500">
                            <span class="text-blue-400">‚è∏Ô∏è Stand-by</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="engagement-decision" value="withdraw" class="text-purple-500">
                            <span class="text-purple-400">üîÑ Se replier</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Instructions Compl√©mentaires (optionnel)</label>
                    <textarea id="engagement-instructions" rows="3" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" placeholder="Consignes tactiques, limitations, objectifs sp√©cifiques..."></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="hideModal('engagement-order-modal')" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="submitEngagementOrder()" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                        ‚öîÔ∏è Transmettre Ordre
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Saisie de Rapport d'Objectif -->
    <div id="objective-report-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    üìã Rapport d'Objectif
                </h3>
                <button onclick="hideModal('objective-report-modal')" 
                        class="text-gray-400 hover:text-white text-2xl">
                    √ó
                </button>
            </div>
            
            <div class="mb-4 p-3 bg-slate-700 rounded-lg">
                <div class="text-sm text-gray-300">
                    <div><strong>Mission:</strong> <span id="report-mission-name"></span></div>
                    <div><strong>Objectif:</strong> <span id="report-objective-text"></span></div>
                </div>
            </div>
            
            <form id="objective-report-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Titre du Rapport</label>
                    <input type="text" id="report-title" 
                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" 
                           placeholder="Ex: Objectif atteint - Zone s√©curis√©e">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">D√©tails du Rapport</label>
                    <textarea id="report-details" rows="6" 
                              class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" 
                              placeholder="D√©crivez en d√©tail l'accomplissement de l'objectif, les m√©thodes utilis√©es, les difficult√©s rencontr√©es, les r√©sultats obtenus..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Escouade Responsable</label>
                        <select id="report-squad" 
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                            <option value="">S√©lectionner une escouade</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Heure d'Accomplissement</label>
                        <input type="datetime-local" id="report-timestamp" 
                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Coordonn√©es (optionnel)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="report-coordinates-lat" 
                               class="px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" 
                               placeholder="Latitude">
                        <input type="text" id="report-coordinates-lng" 
                               class="px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" 
                               placeholder="Longitude">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Informations Compl√©mentaires (optionnel)</label>
                    <textarea id="report-additional-info" rows="3" 
                              class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white placeholder-gray-400" 
                              placeholder="Remarques, recommandations, points d'attention..."></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideModal('objective-report-modal')" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="submitObjectiveReport()" 
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors">
                        üìã Valider et Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    </div> <!-- Fin de main-interface -->

    <!-- Script d'authentification -->
    <script>
        // ===== SYST√àME D'AUTHENTIFICATION ET SESSIONS =====
        const AUTH_CREDENTIALS = {
            username: 'COMMANDANT',
            password: 'admin'
        };

        // Configuration Firebase pour synchronisation multi-appareils
        const firebaseConfig = {
            apiKey: "AIzaSyCw_ZmPc3U82A77qLrS-97X5s_Bn_srUik",
            authDomain: "em-commandement.firebaseapp.com",
            databaseURL: "https://em-commandement-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "em-commandement",
            storageBucket: "em-commandement.firebasestorage.app",
            messagingSenderId: "974967110531",
            appId: "1:974967110531:web:1ff295ee931c28f121d4b6",
            measurementId: "G-VXHG7H2L2J"
        };

        // Initialiser Firebase
        let firebaseApp = null;
        let database = null;
        let isFirebaseEnabled = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseEnabled = true;
            console.log('üî• Firebase initialis√© avec succ√®s');
        } catch (error) {
            console.warn('‚ö†Ô∏è Firebase non disponible, utilisation du localStorage:', error.message);
            isFirebaseEnabled = false;
        }

        // Variables de session
        let currentUser = null;
        let connectedUsers = [];

        // V√©rifier si l'utilisateur est d√©j√† authentifi√©
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('commandement_auth') === 'true';
            const userSession = sessionStorage.getItem('user_session');
            
            if (isAuthenticated && userSession) {
                currentUser = JSON.parse(userSession);
                loadConnectedUsers();
                showMainInterface();
            }
        }

        // Charger la liste des utilisateurs connect√©s (Firebase + localStorage fallback)
        function loadConnectedUsers() {
            if (isFirebaseEnabled) {
                // Utiliser Firebase pour la synchronisation temps r√©el
                database.ref('connected_users').once('value').then((snapshot) => {
                    connectedUsers = snapshot.val() || [];
                    console.log('üì• Sessions charg√©es depuis Firebase:', connectedUsers.length, 'utilisateur(s)');
                }).catch((error) => {
                    console.warn('‚ö†Ô∏è Erreur Firebase, fallback localStorage:', error.message);
                    loadConnectedUsersLocal();
                });
                
                // √âcouter les changements en temps r√©el
                database.ref('connected_users').on('value', (snapshot) => {
                    const updatedUsers = snapshot.val() || [];
                    if (JSON.stringify(updatedUsers) !== JSON.stringify(connectedUsers)) {
                        connectedUsers = updatedUsers;
                        updateUserSessionDisplay();
                        console.log('üîÑ Sessions mises √† jour en temps r√©el:', connectedUsers.length, 'utilisateur(s)');
                    }
                });
            } else {
                loadConnectedUsersLocal();
            }
        }

        // Charger depuis localStorage (fallback)
        function loadConnectedUsersLocal() {
            const savedUsers = localStorage.getItem('connected_users');
            if (savedUsers) {
                connectedUsers = JSON.parse(savedUsers);
            } else {
                connectedUsers = [];
            }
        }

        // Sauvegarder la liste des utilisateurs connect√©s (Firebase + localStorage)
        function saveConnectedUsers() {
            if (isFirebaseEnabled) {
                // Sauvegarder dans Firebase pour synchronisation
                database.ref('connected_users').set(connectedUsers).then(() => {
                    console.log('üíæ Sessions sauvegard√©es dans Firebase');
                }).catch((error) => {
                    console.warn('‚ö†Ô∏è Erreur sauvegarde Firebase, fallback localStorage:', error.message);
                    localStorage.setItem('connected_users', JSON.stringify(connectedUsers));
                });
            } else {
                // Fallback localStorage
                localStorage.setItem('connected_users', JSON.stringify(connectedUsers));
            }
        }

        // V√©rifier si un pseudo existe d√©j√†
        function isPseudoTaken(pseudo) {
            return connectedUsers.some(user => user.pseudo.toLowerCase() === pseudo.toLowerCase());
        }

        // Ajouter un utilisateur √† la session
        function addUserToSession(pseudo) {
            const newUser = {
                pseudo: pseudo,
                connectedAt: new Date().toISOString(),
                sessionId: Date.now() + Math.random()
            };
            
            connectedUsers.push(newUser);
            currentUser = newUser;
            
            sessionStorage.setItem('user_session', JSON.stringify(newUser));
            saveConnectedUsers();
            
            return newUser;
        }

        // Supprimer un utilisateur de la session
        function removeUserFromSession(sessionId) {
            connectedUsers = connectedUsers.filter(user => user.sessionId !== sessionId);
            saveConnectedUsers();
        }

        // Afficher la modal de session utilisateur
        function showUserSessionModal() {
            loadConnectedUsers();
            
            const modal = document.getElementById('user-session-modal');
            const existingUsersSection = document.getElementById('existing-users-section');
            const existingUsersList = document.getElementById('existing-users-list');
            const sessionMessage = document.getElementById('session-message');
            
            // V√©rifier s'il y a des utilisateurs d√©j√† connect√©s
            if (connectedUsers.length > 0) {
                existingUsersSection.classList.remove('hidden');
                sessionMessage.textContent = 'Des utilisateurs sont d√©j√† connect√©s. Saisissez votre pseudo pour les rejoindre :';
                
                // Afficher la liste des utilisateurs connect√©s
                let usersList = '';
                connectedUsers.forEach((user, index) => {
                    const connectedTime = new Date(user.connectedAt).toLocaleTimeString('fr-FR');
                    usersList += `<div class="flex justify-between items-center py-1">`;
                    usersList += `<span>üë§ ${user.pseudo}</span>`;
                    usersList += `<span class="text-xs text-gray-500">depuis ${connectedTime}</span>`;
                    usersList += `</div>`;
                });
                existingUsersList.innerHTML = usersList;
            } else {
                existingUsersSection.classList.add('hidden');
                sessionMessage.textContent = 'Veuillez saisir votre pseudo pour cr√©er votre session';
            }
            
            modal.classList.remove('hidden');
            document.getElementById('user-pseudo').focus();
        }

        // Masquer la modal de session utilisateur
        function hideUserSessionModal() {
            document.getElementById('user-session-modal').classList.add('hidden');
            document.getElementById('user-pseudo').value = '';
            document.getElementById('session-error').classList.add('hidden');
        }

        // Afficher l'interface principale
        function showMainInterface() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-interface').classList.remove('hidden');
            
            console.log('üîê Authentification r√©ussie, interface √âtat-Major activ√©e');
            
            // Afficher les informations de session
            updateUserSessionDisplay();
            
            // Charger les donn√©es avec synchronisation Firebase
            loadState();
            
            // Initialiser l'heure
            updateTime();
            setInterval(updateTime, 1000);
            
            // Configurer le menu mobile
            setupMobileMenu();
            
            // Activer l'√©coute des escouades depuis les SL
            listenForSquadSync();
            
            // Afficher une notification de bienvenue personnalis√©e
            setTimeout(() => {
                const welcomeMessage = currentUser ? 
                    `Bienvenue ${currentUser.pseudo} ! Interface √âtat-Major activ√©e` : 
                    'Interface √âtat-Major activ√©e avec succ√®s';
                showNotification(welcomeMessage, 'success');
                
                // Notification de synchronisation compl√®te active
                if (isFirebaseEnabled) {
                    setTimeout(() => {
                        showNotification('üîÑ Synchronisation temps r√©el activ√©e', 'Toutes les donn√©es sont synchronis√©es entre utilisateurs', 'info');
                    }, 2000);
                } else {
                    setTimeout(() => {
                        showNotification('üì± Mode local', 'Donn√©es sauvegard√©es localement uniquement', 'warning');
                    }, 2000);
                }
            }, 1000);
        }

        // Mettre √† jour l'affichage des sessions utilisateur
        function updateUserSessionDisplay() {
            if (!currentUser) return;
            
            // Ajouter l'affichage du pseudo dans l'en-t√™te
            const header = document.querySelector('header h1');
            if (header && !document.getElementById('user-display')) {
                const userDisplay = document.createElement('div');
                userDisplay.id = 'user-display';
                userDisplay.className = 'text-xs text-cyan-300 mt-1';
                userDisplay.innerHTML = `üë§ Connect√© en tant que: ${currentUser.pseudo}`;
                header.parentNode.appendChild(userDisplay);
            }
            
            // Afficher le nombre d'utilisateurs connect√©s
            setTimeout(() => {
                if (connectedUsers.length > 1) {
                    showNotification(`${connectedUsers.length} utilisateurs connect√©s en simultan√©`, 'info');
                }
            }, 2000);
        }

        // Fonction de d√©connexion
        function logout() {
            // Supprimer l'utilisateur actuel de la liste des connect√©s
            if (currentUser) {
                removeUserFromSession(currentUser.sessionId);
                console.log(`üö™ D√©connexion de ${currentUser.pseudo}`);
            }
            
            // Nettoyer la session locale
            sessionStorage.removeItem('commandement_auth');
            sessionStorage.removeItem('user_session');
            currentUser = null;
            
            // Retourner √† l'√©cran d'authentification
            document.getElementById('main-interface').classList.add('hidden');
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('auth-form').reset();
            
            // Supprimer l'affichage utilisateur
            const userDisplay = document.getElementById('user-display');
            if (userDisplay) {
                userDisplay.remove();
            }
            
            console.log('‚úÖ D√©connexion r√©ussie');
        }

        // Mise √† jour de l'heure
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('fr-FR', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = `${dateString} ${timeString}`;
            }
        }

        // Configuration du menu mobile
        function setupMobileMenu() {
            const menuToggle = document.getElementById('menu-toggle');
            const mainNav = document.getElementById('main-nav');
            
            if (menuToggle && mainNav) {
                menuToggle.addEventListener('click', () => {
                    mainNav.classList.toggle('mobile-menu-open');
                });
            }
        }

        // Gestionnaire du formulaire d'authentification
        document.addEventListener('DOMContentLoaded', function() {
            const authForm = document.getElementById('auth-form');
            const authError = document.getElementById('auth-error');
            
            // V√©rifier l'authentification au chargement
            checkAuthentication();
            
            authForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                if (username === AUTH_CREDENTIALS.username && password === AUTH_CREDENTIALS.password) {
                    // Authentification r√©ussie
                    sessionStorage.setItem('commandement_auth', 'true');
                    
                    // Masquer l'√©cran d'authentification et afficher la modal de session
                    document.getElementById('auth-screen').style.display = 'none';
                    showUserSessionModal();
                } else {
                    // Authentification √©chou√©e
                    authError.textContent = '‚ùå Identifiants incorrects';
                    authError.classList.remove('hidden');
                    
                    // Effacer le message d'erreur apr√®s 3 secondes
                    setTimeout(() => {
                        authError.classList.add('hidden');
                    }, 3000);
                    
                    // Vider les champs
                    document.getElementById('password').value = '';
                }
            });
        });

        // Gestionnaires d'√©v√©nements pour la modal de session utilisateur
        document.addEventListener('DOMContentLoaded', function() {
            // Gestionnaire du formulaire de session utilisateur
            const userSessionForm = document.getElementById('user-session-form');
            const sessionError = document.getElementById('session-error');
            
            if (userSessionForm) {
                userSessionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const pseudo = document.getElementById('user-pseudo').value.trim();
                    
                    // Validation du pseudo
                    if (!pseudo) {
                        sessionError.textContent = '‚ö†Ô∏è Veuillez saisir un pseudo';
                        sessionError.classList.remove('hidden');
                        return;
                    }
                    
                    if (pseudo.length < 2) {
                        sessionError.textContent = '‚ö†Ô∏è Le pseudo doit contenir au moins 2 caract√®res';
                        sessionError.classList.remove('hidden');
                        return;
                    }
                    
                    if (isPseudoTaken(pseudo)) {
                        sessionError.textContent = '‚ùå Ce pseudo est d√©j√† utilis√© par un autre utilisateur connect√©';
                        sessionError.classList.remove('hidden');
                        return;
                    }
                    
                    // Ajouter l'utilisateur √† la session
                    addUserToSession(pseudo);
                    
                    // Masquer la modal et afficher l'interface principale
                    hideUserSessionModal();
                    showMainInterface();
                    
                    console.log(`‚úÖ Session cr√©√©e pour ${pseudo}`);
                });
            }
            
            // Gestionnaire du bouton annuler
            const cancelButton = document.getElementById('cancel-session');
            if (cancelButton) {
                cancelButton.addEventListener('click', function() {
                    // Annuler la connexion et retourner √† l'√©cran d'authentification
                    sessionStorage.removeItem('commandement_auth');
                    hideUserSessionModal();
                    document.getElementById('auth-screen').style.display = 'flex';
                    console.log('üö´ Session annul√©e');
                });
            }
            
            // Effacer les erreurs quand l'utilisateur tape
            const pseudoInput = document.getElementById('user-pseudo');
            if (pseudoInput && sessionError) {
                pseudoInput.addEventListener('input', function() {
                    sessionError.classList.add('hidden');
                });
            }
            
            // Fonction pour afficher le statut Firebase
            function displayFirebaseStatus() {
                if (isFirebaseEnabled) {
                    console.log('üî• Firebase activ√© - Synchronisation multi-appareils disponible');
                } else {
                    console.log('üì± Mode local - Donn√©es sauvegard√©es localement uniquement');
                }
            }
            
            // Afficher le statut Firebase au chargement
            displayFirebaseStatus();
        });

        // Ajouter le bouton de d√©connexion √† l'en-t√™te
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const header = document.querySelector('header .flex.items-center.gap-2');
                if (header && !document.getElementById('logout-btn')) {
                    const logoutBtn = document.createElement('button');
                    logoutBtn.id = 'logout-btn';
                    logoutBtn.className = 'terminal-button text-sm';
                    logoutBtn.innerHTML = 'üö™ D√©connexion';
                    logoutBtn.onclick = logout;
                    header.appendChild(logoutBtn);
                }
            }, 1500);
        });
    </script>

</body>
</html>
